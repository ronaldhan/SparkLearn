<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>Apache Spark进行文本分析和实体解析</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
</head>
<body class="theme theme-white">
<div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px none; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_SVG_Hidden"></div><svg><defs id="MathJax_SVG_glyphs"><path d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z" stroke-width="1" id="MJMATHI-61"></path><path d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z" stroke-width="1" id="MJMAIN-22C5"></path><path d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z" stroke-width="1" id="MJMATHI-62"></path><path d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" stroke-width="1" id="MJMAIN-3D"></path><path d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z" stroke-width="1" id="MJMAIN-2225"></path><path d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" stroke-width="1" id="MJMAIN-63"></path><path d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" stroke-width="1" id="MJMAIN-6F"></path><path d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" stroke-width="1" id="MJMAIN-73"></path><path d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z" stroke-width="1" id="MJMATHI-3B8"></path><path d="M61 748Q64 750 489 750H913L954 640Q965 609 976 579T993 533T999 516H979L959 517Q936 579 886 621T777 682Q724 700 655 705T436 710H319Q183 710 183 709Q186 706 348 484T511 259Q517 250 513 244L490 216Q466 188 420 134T330 27L149 -187Q149 -188 362 -188Q388 -188 436 -188T506 -189Q679 -189 778 -162T936 -43Q946 -27 959 6H999L913 -249L489 -250Q65 -250 62 -248Q56 -246 56 -239Q56 -234 118 -161Q186 -81 245 -11L428 206Q428 207 242 462L57 717L56 728Q56 744 61 748Z" stroke-width="1" id="MJSZ1-2211"></path><path d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-69"></path><path d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z" stroke-width="1" id="MJMAIN-7C"></path><path d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" stroke-width="1" id="MJMAIN-32"></path><path d="M1001 1150Q1017 1150 1020 1132Q1020 1127 741 244L460 -643Q453 -650 436 -650H424Q423 -647 423 -645T421 -640T419 -631T415 -617T408 -594T399 -560T385 -512T367 -448T343 -364T312 -259L203 119L138 41L111 67L212 188L264 248L472 -474L983 1140Q988 1150 1001 1150Z" stroke-width="1" id="MJSZ2-221A"></path><path d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z" stroke-width="1" id="MJMATHI-73"></path><path d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-6D"></path><path d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z" stroke-width="1" id="MJMATHI-6C"></path><path d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-72"></path><path d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z" stroke-width="1" id="MJMATHI-74"></path><path d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-79"></path><path d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z" stroke-width="1" id="MJMATHI-46"></path><path d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z" stroke-width="1" id="MJMATHI-65"></path><path d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-75"></path><path d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z" stroke-width="1" id="MJMATHI-70"></path><path d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z" stroke-width="1" id="MJMATHI-63"></path><path d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z" stroke-width="1" id="MJMATHI-6F"></path><path d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-6E"></path><path d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z" stroke-width="1" id="MJMAIN-2217"></path><path d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z" stroke-width="1" id="MJMAIN-2B"></path></defs></svg></div><div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 id="apache-spark进行文本分析和实体解析" data-anchor-id="tow3">Apache Spark进行文本分析和实体解析</h1><p data-anchor-id="9xgd"><code>Spark</code> <code>文本分析</code> <code>实体解析</code> <code>Text</code> <code>Analysis</code><a href="../index.html" style="float:right"><strong>Home</strong></a></p><hr><div class="md-section-divider"></div><h3 id="内容目录" data-anchor-id="ptp1">内容目录</h3><p data-anchor-id="49p0"><div class="toc"><div class="toc">
<ul>
<li><a href="#apache-spark进行文本分析和实体解析">Apache Spark进行文本分析和实体解析</a><ul>
<li><ul>
<li><a href="#内容目录">内容目录</a></li>
<li><a href="#1-背景介绍">1. 背景介绍</a></li>
<li><a href="#2-预备工作">2. 预备工作</a></li>
<li><a href="#3-文本相似度-词袋模型">3. 文本相似度--词袋模型</a><ul>
<li><a href="#将文本tokenize化">将文本tokenize化</a></li>
<li><a href="#移除停用词">移除停用词</a></li>
<li><a href="#在抽样数据上将文本tokenize化">在抽样数据上将文本tokenize化</a></li>
<li><a href="#amazon数据集中token最多的记录">Amazon数据集中token最多的记录</a></li>
</ul>
</li>
<li><a href="#4-文本相似度-tf-idf">4. 文本相似度--TF-IDF</a><ul>
<li><a href="#tf计算函数">TF计算函数</a></li>
<li><a href="#创建语料库">创建语料库</a></li>
<li><a href="#idf计算函数">IDF计算函数</a></li>
<li><a href="#查看idf计算结果">查看IDF计算结果</a></li>
<li><a href="#idf直方图">IDF直方图</a></li>
<li><a href="#实现tf-idf函数">实现TF-IDF函数</a></li>
</ul>
</li>
<li><a href="#5-文本相似度-余弦">5. 文本相似度--余弦</a><ul>
<li><a href="#计算cosine相似度的函数">计算cosine相似度的函数</a></li>
<li><a href="#进行实体解析">进行实体解析</a></li>
<li><a href="#使用broadcast-variables来计算相似度">使用Broadcast Variables来计算相似度</a></li>
<li><a href="#使用黄金标准对结果进行评估">使用黄金标准对结果进行评估</a></li>
</ul>
</li>
<li><a href="#6-在大数据集上进行实体解析">6. 在大数据集上进行实体解析</a><ul>
<li><a href="#将完整的数据集tokenize化">将完整的数据集tokenize化</a></li>
<li><a href="#计算完整数据集的tf和idf">计算完整数据集的TF和IDF</a></li>
<li><a href="#计算权重的模">计算权重的模</a></li>
<li><a href="#创建倒序索引">创建倒序索引</a></li>
<li><a href="#筛选数据集中共有的token">筛选数据集中共有的token</a></li>
</ul>
</li>
<li><a href="#8-分析">8. 分析</a><ul>
<li><a href="#计算真阳性假阳性假阴性的值">计算真阳性/假阳性/假阴性的值</a></li>
<li><a href="#准确度召回率f-measures">准确度/召回率/F-measures</a></li>
<li><a href="#结果可视化">结果可视化</a></li>
</ul>
</li>
<li><a href="#9-讨论">9. 讨论</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</p><p data-anchor-id="y6l4">Tags : Spark 文本分析 实体解析 Text Analysis Entity Resolution</p><div class="md-section-divider"></div><h3 id="1-背景介绍" data-anchor-id="4dn0">1. 背景介绍</h3><p data-anchor-id="8fvk">实体解析在数据整合,数据清洗中非常常见但也比较困难的任务,本文尝试使用Spark进行文本分析和实体解析.实体解析是指识别不同来源数据集中指代相同实体的一系列任务.在需要将并没有相同识别标识的不同数据进行整合时时必须的. <br>
任务中需要的文件来自于<a target="_blank" href="https://code.google.com/p/metric-learning/">metric-learning</a>项目,包含以下文件:</p><ul data-anchor-id="c9ki">
<li>Google.csv Google产品数据集</li>
<li>Amazon.csv Amazon产品数据集</li>
<li>Google_small.csv Google产品数据集中抽取200个记录</li>
<li>Amazon_small.csv Amazon产品数据集中抽取200个记录</li>
<li>Amazon_Google_perfectMapping.csv 黄金标准映射文件</li>
<li>stopwords.txt 停用词文件 <br>
Amazon_Google_perfectMapping.csv文件中包含数据集中所有真正对应的实体的记录, 这个文件中每一行存储一个元组,分别记录Google id和Amazon id, 我们将使用这个文件来评价算法的匹配质量.</li>
</ul><div class="md-section-divider"></div><h3 id="2-预备工作" data-anchor-id="mysk">2. 预备工作</h3><p data-anchor-id="3ksr">我们需要将数据加载到RDD中, 对于数据中的每一条记录, 我们希望用产品的id作为RDD中一条记录的key, 用除了id之外的其他数据组合成为字符串作为对应的value. <br>
Amazon数据文件的格式</p><blockquote class="white-blockquote" data-anchor-id="18q4">
  <p>"id","title","description","manufacturer","price"</p>
</blockquote><p data-anchor-id="2nvt">Google数据文件的格式</p><blockquote class="white-blockquote" data-anchor-id="79sx">
  <p>"id","name","description","manufacturer","price"</p>
</blockquote><div class="md-section-divider"></div><pre style="" data-anchor-id="ggbz" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> re</span></code></li><li class="L1"><code class="language-python"><span class="pln">DATAFILE_PATTERN </span><span class="pun">=</span><span class="pln"> </span><span class="str">'^(.+),"(.+)",(.*),(.*),(.*)'</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> removeQuotes</span><span class="pun">(</span><span class="pln">s</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">""" Remove quotation marks from an input string(移除输入字符包含的引号)</span></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        s (str): input string that might have the quote "" characters</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        str: a string without the quote characters</span></code></li><li class="L9"><code class="language-python"><span class="str">    """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="str">''</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">i </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> s </span><span class="kwd">if</span><span class="pln"> i</span><span class="pun">!=</span><span class="str">'"'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> parseDatafileLine</span><span class="pun">(</span><span class="pln">datafileLine</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">""" Parse a line of the data file using the specified regular expression pattern(通过正则匹配提取出key-value值)</span></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        datafileLine (str): input string that is a line from the data file</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        str: a string parsed using the given regular expression and without the quote characters</span></code></li><li class="L9"><code class="language-python"><span class="str">    """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    match </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">search</span><span class="pun">(</span><span class="pln">DATAFILE_PATTERN</span><span class="pun">,</span><span class="pln"> datafileLine</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> match </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Invalid datafile line: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> datafileLine</span></code></li><li class="L3"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">datafileLine</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">elif</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'"id"'</span><span class="pun">:</span></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Header datafile line: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> datafileLine</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">datafileLine</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L8"><code class="language-python"><span class="pln">        product </span><span class="pun">=</span><span class="pln"> </span><span class="str">'%s %s %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">2</span><span class="pun">),</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">3</span><span class="pun">),</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">4</span><span class="pun">))</span></code></li><li class="L9"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">((</span><span class="pln">removeQuotes</span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)),</span><span class="pln"> product</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="riv4" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 加载抽样数据/正则解析/生成RDD</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L2"><code class="language-python"><span class="kwd">import</span><span class="pln"> os</span></code></li><li class="L3"><code class="language-python"><span class="kwd">from</span><span class="pln"> test_helper </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Test</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">baseDir </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">inputPath </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">'cs100'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lab3'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">GOOGLE_PATH </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Google.csv'</span></code></li><li class="L9"><code class="language-python"><span class="pln">GOOGLE_SMALL_PATH </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Google_small.csv'</span></code></li><li class="L0"><code class="language-python"><span class="pln">AMAZON_PATH </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Amazon.csv'</span></code></li><li class="L1"><code class="language-python"><span class="pln">AMAZON_SMALL_PATH </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Amazon_small.csv'</span></code></li><li class="L2"><code class="language-python"><span class="pln">GOLD_STANDARD_PATH </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Amazon_Google_perfectMapping.csv'</span></code></li><li class="L3"><code class="language-python"><span class="pln">STOPWORDS_PATH </span><span class="pun">=</span><span class="pln"> </span><span class="str">'stopwords.txt'</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> parseData</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">""" Parse a data file</span></code></li><li class="L7"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L8"><code class="language-python"><span class="str">        filename (str): input file name of the data file</span></code></li><li class="L9"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L0"><code class="language-python"><span class="str">        RDD: a RDD of parsed lines</span></code></li><li class="L1"><code class="language-python"><span class="str">    """</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sc</span></code></li><li class="L3"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">textFile</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">parseDatafileLine</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="kwd">def</span><span class="pln"> loadData</span><span class="pun">(</span><span class="pln">path</span><span class="pun">):</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="str">""" Load a data file</span></code></li><li class="L9"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L0"><code class="language-python"><span class="str">        path (str): input file name of the data file</span></code></li><li class="L1"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L2"><code class="language-python"><span class="str">        RDD: a RDD of parsed valid lines</span></code></li><li class="L3"><code class="language-python"><span class="str">    """</span></code></li><li class="L4"><code class="language-python"><span class="pln">    filename </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">baseDir</span><span class="pun">,</span><span class="pln"> inputPath</span><span class="pun">,</span><span class="pln"> path</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    raw </span><span class="pun">=</span><span class="pln"> parseData</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">).</span><span class="pln">cache</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="pln">    failed </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">raw</span></code></li><li class="L7"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]))</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> failed</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">):</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'%s - Invalid datafile line: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> line</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    valid </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">raw</span></code></li><li class="L2"><code class="language-python"><span class="pln">             </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">             </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">])</span></code></li><li class="L4"><code class="language-python"><span class="pln">             </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'%s - Read %d lines, successfully parsed %d lines, failed to parse %d lines'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">path</span><span class="pun">,</span></code></li><li class="L6"><code class="language-python"><span class="pln">                                                                                        raw</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span></code></li><li class="L7"><code class="language-python"><span class="pln">                                                                                        valid</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span></code></li><li class="L8"><code class="language-python"><span class="pln">                                                                                        failed</span><span class="pun">.</span><span class="pln">count</span><span class="pun">())</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">assert</span><span class="pln"> failed</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">assert</span><span class="pln"> raw</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="pun">(</span><span class="pln">valid</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> valid</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">googleSmall </span><span class="pun">=</span><span class="pln"> loadData</span><span class="pun">(</span><span class="pln">GOOGLE_SMALL_PATH</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">google </span><span class="pun">=</span><span class="pln"> loadData</span><span class="pun">(</span><span class="pln">GOOGLE_PATH</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">amazonSmall </span><span class="pun">=</span><span class="pln"> loadData</span><span class="pun">(</span><span class="pln">AMAZON_SMALL_PATH</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">amazon </span><span class="pun">=</span><span class="pln"> loadData</span><span class="pun">(</span><span class="pln">AMAZON_PATH</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Google_small</span><span class="pun">.</span><span class="pln">csv </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Read</span><span class="pln"> </span><span class="lit">201</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> successfully parsed </span><span class="lit">200</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> failed to parse </span><span class="lit">0</span><span class="pln"> lines</span></code></li><li class="L9"><code class="language-python"><span class="typ">Google</span><span class="pun">.</span><span class="pln">csv </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Read</span><span class="pln"> </span><span class="lit">3227</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> successfully parsed </span><span class="lit">3226</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> failed to parse </span><span class="lit">0</span><span class="pln"> lines</span></code></li><li class="L0"><code class="language-python"><span class="typ">Amazon_small</span><span class="pun">.</span><span class="pln">csv </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Read</span><span class="pln"> </span><span class="lit">201</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> successfully parsed </span><span class="lit">200</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> failed to parse </span><span class="lit">0</span><span class="pln"> lines</span></code></li><li class="L1"><code class="language-python"><span class="typ">Amazon</span><span class="pun">.</span><span class="pln">csv </span><span class="pun">-</span><span class="pln"> </span><span class="typ">Read</span><span class="pln"> </span><span class="lit">1364</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> successfully parsed </span><span class="lit">1363</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> failed to parse </span><span class="lit">0</span><span class="pln"> lines</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># 查看数据格式</span></code></li><li class="L4"><code class="language-python"><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> googleSmall</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">3</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'google: %s: %s\n'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">line</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> line</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> amazonSmall</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">3</span><span class="pun">):</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'amazon: %s: %s\n'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">line</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> line</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> google</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">://</span><span class="pln">www</span><span class="pun">.</span><span class="pln">google</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">base</span><span class="pun">/</span><span class="pln">feeds</span><span class="pun">/</span><span class="pln">snippets</span><span class="pun">/</span><span class="lit">11448761432933644608</span><span class="pun">:</span><span class="pln"> spanish vocabulary builder </span><span class="str">"expand your vocabulary! contains fun lessons that both teach and entertain you'll quickly find yourself mastering new terms. includes games and more!"</span><span class="pln"> </span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">google</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">://</span><span class="pln">www</span><span class="pun">.</span><span class="pln">google</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">base</span><span class="pun">/</span><span class="pln">feeds</span><span class="pun">/</span><span class="pln">snippets</span><span class="pun">/</span><span class="lit">8175198959985911471</span><span class="pun">:</span><span class="pln"> topics presents</span><span class="pun">:</span><span class="pln"> museums of world </span><span class="str">"5 cd-rom set. step behind the velvet rope to examine some of the most treasured collections of antiquities art and inventions. includes the following the louvre - virtual visit 25 rooms in full screen interactive video detailed map of the louvre ..."</span><span class="pln"> </span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">google</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">://</span><span class="pln">www</span><span class="pun">.</span><span class="pln">google</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/</span><span class="pln">base</span><span class="pun">/</span><span class="pln">feeds</span><span class="pun">/</span><span class="pln">snippets</span><span class="pun">/</span><span class="lit">18445827127704822533</span><span class="pun">:</span><span class="pln"> sierrahome hse hallmark card studio special edition win </span><span class="lit">98</span><span class="pln"> me </span><span class="lit">2000</span><span class="pln"> xp </span><span class="str">"hallmark card studio special edition (win 98 me 2000 xp)"</span><span class="pln"> </span><span class="str">"sierrahome"</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">amazon</span><span class="pun">:</span><span class="pln"> b000jz4hqo</span><span class="pun">:</span><span class="pln"> clickart </span><span class="lit">950</span><span class="pln"> </span><span class="lit">000</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> premier image pack </span><span class="pun">(</span><span class="pln">dvd</span><span class="pun">-</span><span class="pln">rom</span><span class="pun">)</span><span class="pln">  </span><span class="str">"broderbund"</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">amazon</span><span class="pun">:</span><span class="pln"> b0006zf55o</span><span class="pun">:</span><span class="pln"> ca international </span><span class="pun">-</span><span class="pln"> arcserve lap</span><span class="pun">/</span><span class="pln">desktop oem </span><span class="lit">30pk</span><span class="pln"> </span><span class="str">"oem arcserve backup v11.1 win 30u for laptops and desktops"</span><span class="pln"> </span><span class="str">"computer associates"</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">amazon</span><span class="pun">:</span><span class="pln"> b00004tkvy</span><span class="pun">:</span><span class="pln"> noah</span><span class="str">'s ark activity center (jewel case ages 3-8)  "victory multimedia"</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="3-文本相似度-词袋模型" data-anchor-id="ltrk">3. 文本相似度--词袋模型</h3><p data-anchor-id="jmrw">进行实体解析的一种简单方法是将所有的记录都认为是字符串, 通过距离函数计算字符串相似度. 词袋模型(<a target="_blank" href="https://en.wikipedia.org/wiki/Bag-of-words_model">Bag-of-words </a>)是一种直觉上简单但却非常有效的文本分析方法.</p><div class="md-section-divider"></div><h4 id="将文本tokenize化" data-anchor-id="c430">将文本tokenize化</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="k0p5" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 实现将文本转为了一个个单词,保存在list中</span></code></li><li class="L1"><code class="language-python"><span class="pln">quickbrownfox </span><span class="pun">=</span><span class="pln"> </span><span class="str">'A quick brown fox jumps over the lazy dog.'</span></code></li><li class="L2"><code class="language-python"><span class="pln">split_regex </span><span class="pun">=</span><span class="pln"> r</span><span class="str">'\W+'</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> simpleTokenize</span><span class="pun">(</span><span class="pln">string</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="str">""" A simple implementation of input string tokenization</span></code></li><li class="L6"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L7"><code class="language-python"><span class="str">        string (str): input string</span></code></li><li class="L8"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L9"><code class="language-python"><span class="str">        list: a list of tokens</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span><span class="pln">    </span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="pln">x </span><span class="kwd">for</span><span class="pln"> x </span><span class="kwd">in</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="pln">split_regex</span><span class="pun">,</span><span class="pln"> string</span><span class="pun">.</span><span class="pln">lower</span><span class="pun">())</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> x </span><span class="pun">!=</span><span class="pln"> </span><span class="str">''</span><span class="pun">]</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> simpleTokenize</span><span class="pun">(</span><span class="pln">quickbrownfox</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="str">'a'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'quick'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'brown'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fox'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'jumps'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'over'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'the'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lazy'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'dog'</span><span class="pun">]</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="com"># 更多的测试文本分割函数</span></code></li><li class="L8"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">simpleTokenize</span><span class="pun">(</span><span class="pln">quickbrownfox</span><span class="pun">),</span></code></li><li class="L9"><code class="language-python"><span class="pln">                  </span><span class="pun">[</span><span class="str">'a'</span><span class="pun">,</span><span class="str">'quick'</span><span class="pun">,</span><span class="str">'brown'</span><span class="pun">,</span><span class="str">'fox'</span><span class="pun">,</span><span class="str">'jumps'</span><span class="pun">,</span><span class="str">'over'</span><span class="pun">,</span><span class="str">'the'</span><span class="pun">,</span><span class="str">'lazy'</span><span class="pun">,</span><span class="str">'dog'</span><span class="pun">],</span></code></li><li class="L0"><code class="language-python"><span class="pln">                  </span><span class="str">'simpleTokenize should handle sample text'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">simpleTokenize</span><span class="pun">(</span><span class="str">' '</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> </span><span class="str">'simpleTokenize should handle empty string'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">simpleTokenize</span><span class="pun">(</span><span class="str">'!!!!123A/456_B/789C.123A'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'123a'</span><span class="pun">,</span><span class="str">'456_b'</span><span class="pun">,</span><span class="str">'789c'</span><span class="pun">,</span><span class="str">'123a'</span><span class="pun">],</span></code></li><li class="L3"><code class="language-python"><span class="pln">                  </span><span class="str">'simpleTokenize should handle puntuations and lowercase result'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">simpleTokenize</span><span class="pun">(</span><span class="str">'fox fox'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'fox'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fox'</span><span class="pun">],</span></code></li><li class="L5"><code class="language-python"><span class="pln">                  </span><span class="str">'simpleTokenize should not remove duplicates'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="com"># 以上测试都需要通过才能说名函数可用</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="移除停用词" data-anchor-id="fpfq">移除停用词</h4><p data-anchor-id="z3hv">停用词(<a target="_blank" href="https://en.wikipedia.org/wiki/Stop_words">Stopwords</a>)是那些对文本内容意思作用不大的词, 比如"the", "a", "is", "to"这类词. 停用词会增加词袋模型的噪声,因此需要移除.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="025l" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 实现一个移除停用词的tokenize函数</span></code></li><li class="L1"><code class="language-python"><span class="pln">stopfile </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">baseDir</span><span class="pun">,</span><span class="pln"> inputPath</span><span class="pun">,</span><span class="pln"> STOPWORDS_PATH</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">stopwords </span><span class="pun">=</span><span class="pln"> set</span><span class="pun">(</span><span class="pln">sc</span><span class="pun">.</span><span class="pln">textFile</span><span class="pun">(</span><span class="pln">stopfile</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'These are the stopwords: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> stopwords</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> tokenize</span><span class="pun">(</span><span class="pln">string</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">""" An implementation of input string tokenization that excludes stopwords</span></code></li><li class="L7"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L8"><code class="language-python"><span class="str">        string (str): input string</span></code></li><li class="L9"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L0"><code class="language-python"><span class="str">        list: a list of tokens without stopwords</span></code></li><li class="L1"><code class="language-python"><span class="str">    """</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> x </span><span class="kwd">for</span><span class="pln"> x </span><span class="kwd">in</span><span class="pln"> simpleTokenize</span><span class="pun">(</span><span class="pln">string</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> x </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> stopwords</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> tokenize</span><span class="pun">(</span><span class="pln">quickbrownfox</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">These</span><span class="pln"> are the stopwords</span><span class="pun">:</span><span class="pln"> set</span><span class="pun">([</span><span class="pln">u</span><span class="str">'all'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'just'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'being'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'over'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'both'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'through'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'yourselves'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'its'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'before'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'with'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'had'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'should'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'to'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'only'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'under'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'ours'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'has'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'do'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'them'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'his'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'very'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'they'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'not'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'during'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'now'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'him'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'nor'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'did'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'these'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'t'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'each'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'where'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'because'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'doing'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'theirs'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'some'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'are'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'our'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'ourselves'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'out'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'what'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'for'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'below'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'does'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'above'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'between'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'she'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'be'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'we'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'after'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'here'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'hers'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'by'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'on'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'about'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'of'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'against'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'s'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'or'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'own'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'into'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'yourself'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'down'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'your'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'from'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'her'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'whom'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'there'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'been'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'few'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'too'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'themselves'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'was'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'until'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'more'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'himself'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'that'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'but'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'off'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'herself'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'than'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'those'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'he'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'me'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'myself'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'this'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'up'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'will'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'while'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'can'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'were'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'my'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'and'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'then'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'is'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'in'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'am'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'it'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'an'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'as'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'itself'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'at'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'have'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'further'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'their'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'if'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'again'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'no'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'when'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'same'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'any'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'how'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'which'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'you'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'who'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'most'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'such'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'why'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'a'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'don'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'i'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'having'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'so'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'the'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'yours'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'once'</span><span class="pun">])</span></code></li><li class="L7"><code class="language-python"><span class="pun">[</span><span class="str">'quick'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'brown'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fox'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'jumps'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lazy'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'dog'</span><span class="pun">]</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># 更多对新的tokenize函数的测试</span></code></li><li class="L0"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">(</span><span class="str">"Why a the?"</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> </span><span class="str">'tokenize should remove all stopwords'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">(</span><span class="str">"Being at the_?"</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'the_'</span><span class="pun">],</span><span class="pln"> </span><span class="str">'tokenize should handle non-stopwords'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">(</span><span class="pln">quickbrownfox</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'quick'</span><span class="pun">,</span><span class="str">'brown'</span><span class="pun">,</span><span class="str">'fox'</span><span class="pun">,</span><span class="str">'jumps'</span><span class="pun">,</span><span class="str">'lazy'</span><span class="pun">,</span><span class="str">'dog'</span><span class="pun">],</span><span class="pln"> </span><span class="str">'tokenize should handle sample text'</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="在抽样数据上将文本tokenize化" data-anchor-id="6pgz">在抽样数据上将文本tokenize化</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="pbi2" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># flatMapValues方法映射出一对多的结果</span></code></li><li class="L1"><code class="language-python"><span class="pln">amazonRecToToken </span><span class="pun">=</span><span class="pln"> amazonSmall</span><span class="pun">.</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">googleRecToToken </span><span class="pun">=</span><span class="pln"> googleSmall</span><span class="pun">.</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> countTokens</span><span class="pun">(</span><span class="pln">vendorRDD</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="str">""" Count and return the number of tokens</span></code></li><li class="L6"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L7"><code class="language-python"><span class="str">        vendorRDD (RDD of (recordId, tokenizedValue)): Pair tuple of record ID to tokenized output</span></code></li><li class="L8"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L9"><code class="language-python"><span class="str">        count: count of all tokens</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> vendorRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">totalTokens </span><span class="pun">=</span><span class="pln"> countTokens</span><span class="pun">(</span><span class="pln">amazonRecToToken</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> countTokens</span><span class="pun">(</span><span class="pln">googleRecToToken</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'There are %s tokens in the combined datasets'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> totalTokens</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">There</span><span class="pln"> are </span><span class="lit">22520</span><span class="pln"> tokens </span><span class="kwd">in</span><span class="pln"> the combined datasets</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="amazon数据集中token最多的记录" data-anchor-id="ohq6">Amazon数据集中token最多的记录</h4><p data-anchor-id="goq8">对结果按照token的数量进行排序,并找出量最大的一个</p><div class="md-section-divider"></div><pre style="" data-anchor-id="7i4w" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> findBiggestRecord</span><span class="pun">(</span><span class="pln">vendorRDD</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">""" Find and return the record with the largest number of tokens</span></code></li><li class="L2"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L3"><code class="language-python"><span class="str">        vendorRDD (RDD of (recordId, tokens)): input Pair Tuple of record ID and tokens</span></code></li><li class="L4"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L5"><code class="language-python"><span class="str">        list: a list of 1 Pair Tuple of record ID and tokens</span></code></li><li class="L6"><code class="language-python"><span class="str">    """</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">vendorRDD</span></code></li><li class="L8"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">sortBy</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]),</span><span class="pln"> ascending</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">biggestRecordAmazon </span><span class="pun">=</span><span class="pln"> findBiggestRecord</span><span class="pun">(</span><span class="pln">amazonRecToToken</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'The Amazon record with ID "%s" has the most tokens (%s)'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">biggestRecordAmazon</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">biggestRecordAmazon</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">1</span><span class="pun">]))</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="4-文本相似度-tf-idf" data-anchor-id="mxf7">4. 文本相似度--TF-IDF</h3><p data-anchor-id="lqu7">词袋模型认为所有的token权重是等同的, 而实际上某些词更重要. 为词汇赋予权重可以反映以上思想. 在词汇具有权重的情况下, 我们计算文档之间相似度时不再统计两个文档共有词汇的数量, ersI而是计算共有词汇的权重加和. 一种启发式地为词汇分配权重的方法是<code>Term-Frequency/Inverse-Document-Frequency</code>, 简称为<a target="_blank" href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">TF-IDF</a>. </p><p data-anchor-id="tkmq"><strong>TF</strong>  <br>
TF表示tokens在文档中出现的次数. 例如, 文档<code>d</code>包含100个token, 其中token <code>t</code>在<code>d</code>中出现了5次, <code>t</code>在<code>d</code>中的TF值为5/100 = 1/20. TF表明, 如果文档中一个token出现的次数越高, 那么这个token就越重要.</p><p data-anchor-id="9nw9"><strong>IDF</strong> <br>
IDF更侧重于在所有文档中出现次数很少的token. IDF表明, 两个文档共有一些罕见词汇比共有一些常见词汇更有意义. 在文档集<code>U</code>中, token <code>t</code> 的IDF计算方式如下: </p><ul data-anchor-id="97tm">
<li>N表示U中文档的数量</li>
<li>n(t)表示U中包含t的文档的数量</li>
<li>那么, IDF(t) = N/n(t)</li>
</ul><p data-anchor-id="lwwz"><strong>TF-IDF</strong> <br>
TF-IDF = TF * IDF</p><div class="md-section-divider"></div><h4 id="tf计算函数" data-anchor-id="2vgy">TF计算函数</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="9z87" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># tf=单词出现次数/所有单词的个数</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> tf</span><span class="pun">(</span><span class="pln">tokens</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute TF</span></code></li><li class="L3"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L4"><code class="language-python"><span class="str">        tokens (list of str): input list of tokens from tokenize</span></code></li><li class="L5"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L6"><code class="language-python"><span class="str">        dictionary: a dictionary of tokens to its TF values</span></code></li><li class="L7"><code class="language-python"><span class="str">    """</span></code></li><li class="L8"><code class="language-python"><span class="pln">    result </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> word </span><span class="kwd">in</span><span class="pln"> tokens</span><span class="pun">:</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> word </span><span class="kwd">in</span><span class="pln"> result</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">():</span></code></li><li class="L1"><code class="language-python"><span class="pln">            result</span><span class="pun">[</span><span class="pln">word</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code class="language-python"><span class="pln">            result</span><span class="pun">[</span><span class="pln">word</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> k</span><span class="pun">,</span><span class="pln"> v </span><span class="kwd">in</span><span class="pln"> result</span><span class="pun">.</span><span class="pln">items</span><span class="pun">():</span></code></li><li class="L6"><code class="language-python"><span class="pln">        result</span><span class="pun">[</span><span class="pln">k</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">v</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">tokens</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> result</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> tokenize</span><span class="pun">(</span><span class="pln">quickbrownfox</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> tf</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">(</span><span class="pln">quickbrownfox</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="str">'quick'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'brown'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fox'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'jumps'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lazy'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'dog'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-python"><span class="pun">{</span><span class="str">'brown'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.16666666666666666</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lazy'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.16666666666666666</span><span class="pun">,</span><span class="pln"> </span><span class="str">'jumps'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.16666666666666666</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fox'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.16666666666666666</span><span class="pun">,</span><span class="pln"> </span><span class="str">'dog'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.16666666666666666</span><span class="pun">,</span><span class="pln"> </span><span class="str">'quick'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.16666666666666666</span><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="创建语料库" data-anchor-id="c40m">创建语料库</h4><p data-anchor-id="zlkt">语料库中包含Google和Amazon抽样数据集中所有的token. 语料库中的内容是一个键值对,键为url或者id, 值为相关联的内容,为一行文本.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="77hu" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">corpusRDD </span><span class="pun">=</span><span class="pln"> amazonSmall</span><span class="pun">.</span><span class="pln">union</span><span class="pun">(</span><span class="pln">googleSmall</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="idf计算函数" data-anchor-id="4dmy">IDF计算函数</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="y6sd" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">tf </span><span class="pun">=</span><span class="pln"> amazonRecToToken</span><span class="pun">.</span><span class="pln">union</span><span class="pun">(</span><span class="pln">googleRecToToken</span><span class="pun">).</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]).</span><span class="pln">distinct</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="pln">tc </span><span class="pun">=</span><span class="pln"> amazonRecToToken</span><span class="pun">.</span><span class="pln">union</span><span class="pun">(</span><span class="pln">googleRecToToken</span><span class="pun">).</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]).</span><span class="pln">distinct</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">tc </span><span class="pun">=</span><span class="pln"> tc</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> x</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">tx </span><span class="pun">=</span><span class="pln"> amazonRecToToken</span><span class="pun">.</span><span class="pln">union</span><span class="pun">(</span><span class="pln">googleRecToToken</span><span class="pun">).</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]))</span></code></li><li class="L4"><code class="language-python"><span class="com"># 需要将group后的值进行唯一值化,使用set进行</span></code></li><li class="L5"><code class="language-python"><span class="pln">tm </span><span class="pun">=</span><span class="pln"> tc</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">tx</span><span class="pun">).</span><span class="pln">groupByKey</span><span class="pun">().</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">set</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))))</span></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> tm</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> tm</span><span class="pun">.</span><span class="pln">takeOrdered</span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">:</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">4772</span></code></li><li class="L0"><code class="language-python"><span class="pun">[(</span><span class="str">'software'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">94</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'features'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">58</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'new'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">58</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'use'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">57</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'complete'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">55</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="4ev6" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> idfs</span><span class="pun">(</span><span class="pln">corpus</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute IDF</span></code></li><li class="L2"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L3"><code class="language-python"><span class="str">        corpus (RDD): input corpus</span></code></li><li class="L4"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L5"><code class="language-python"><span class="str">        RDD: a RDD of (token, IDF value)</span></code></li><li class="L6"><code class="language-python"><span class="str">    """</span></code></li><li class="L7"><code class="language-python"><span class="pln">    N </span><span class="pun">=</span><span class="pln"> corpus</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]).</span><span class="pln">distinct</span><span class="pun">().</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L8"><code class="language-python"><span class="pln">    uniqueTokens </span><span class="pun">=</span><span class="pln"> corpus</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]).</span><span class="pln">distinct</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"><span class="pln">    tokenCountPairTuple </span><span class="pun">=</span><span class="pln"> uniqueTokens</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> x</span><span class="pun">)).</span><span class="pln">join</span><span class="pun">(</span><span class="pln">corpus</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]))).</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L0"><code class="language-python"><span class="pln">    tokenSumPairTuple </span><span class="pun">=</span><span class="pln"> tokenCountPairTuple</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">set</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))))</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">tokenSumPairTuple</span></code></li><li class="L2"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">N</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])))</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">idfsSmall </span><span class="pun">=</span><span class="pln"> idfs</span><span class="pun">(</span><span class="pln">amazonRecToToken</span><span class="pun">.</span><span class="pln">union</span><span class="pun">(</span><span class="pln">googleRecToToken</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"><span class="pln">uniqueTokenCount </span><span class="pun">=</span><span class="pln"> idfsSmall</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'There are %s unique tokens in the small datasets.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> uniqueTokenCount</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="查看idf计算结果" data-anchor-id="kh43">查看IDF计算结果</h4><p data-anchor-id="hg9u">查看IDF值最小的11个token</p><div class="md-section-divider"></div><pre style="" data-anchor-id="8ewo" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">smallIDFTokens </span><span class="pun">=</span><span class="pln"> idfsSmall</span><span class="pun">.</span><span class="pln">takeOrdered</span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> smallIDFTokens</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[(</span><span class="str">'software'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4.25531914893617</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'features'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6.896551724137931</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'new'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6.896551724137931</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'use'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7.017543859649122</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'complete'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7.2727272727272725</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'easy'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7.6923076923076925</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'create'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8.333333333333334</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'system'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8.333333333333334</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'cd'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8.333333333333334</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'1'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8.51063829787234</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'windows'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8.51063829787234</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="idf直方图" data-anchor-id="gx7c">IDF直方图</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="okwp" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">pyplot </span><span class="kwd">as</span><span class="pln"> plt</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">small_idf_values </span><span class="pun">=</span><span class="pln"> idfsSmall</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">3</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">hist</span><span class="pun">(</span><span class="pln">small_idf_values</span><span class="pun">,</span><span class="pln"> </span><span class="lit">50</span><span class="pun">,</span><span class="pln"> log</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="f21l">![idf_small_hist.png-8.2kB][2]</p><div class="md-section-divider"></div><h4 id="实现tf-idf函数" data-anchor-id="hiwh">实现TF-IDF函数</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="dr7k" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> tfidf</span><span class="pun">(</span><span class="pln">tokens</span><span class="pun">,</span><span class="pln"> idfs</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute TF-IDF</span></code></li><li class="L2"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L3"><code class="language-python"><span class="str">        tokens (list of str): input list of tokens from tokenize</span></code></li><li class="L4"><code class="language-python"><span class="str">        idfs (dictionary): record to IDF value</span></code></li><li class="L5"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L6"><code class="language-python"><span class="str">        dictionary: a dictionary of records to TF-IDF values</span></code></li><li class="L7"><code class="language-python"><span class="str">    """</span></code></li><li class="L8"><code class="language-python"><span class="pln">    tfs </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">(</span><span class="pln">tokens</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    tfIdfDict </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> key </span><span class="pun">:</span><span class="pln"> tfs</span><span class="pun">[</span><span class="pln">key</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> idfs</span><span class="pun">[</span><span class="pln">key</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> key </span><span class="kwd">in</span><span class="pln"> tfs</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">()</span><span class="pln"> </span><span class="pun">}</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> tfIdfDict</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">recb000hkgj8k </span><span class="pun">=</span><span class="pln"> amazonRecToToken</span><span class="pun">.</span><span class="pln">groupByKey</span><span class="pun">().</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'b000hkgj8k'</span><span class="pun">).</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> list</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])).</span><span class="pln">collect</span><span class="pun">()[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> recb000hkgj8k</span></code></li><li class="L4"><code class="language-python"><span class="pln">idfsSmallWeights </span><span class="pun">=</span><span class="pln"> idfsSmall</span><span class="pun">.</span><span class="pln">collectAsMap</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="pln">rec_b000hkgj8k_weights </span><span class="pun">=</span><span class="pln"> tfidf</span><span class="pun">(</span><span class="pln">recb000hkgj8k</span><span class="pun">,</span><span class="pln"> idfsSmallWeights</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Amazon record "b000hkgj8k" has tokens and weights:\n%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> rec_b000hkgj8k_weights</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="str">'autocad'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2007'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'courseware'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'customizing'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'interface'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'autocad'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2007'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'courseware'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'customizing'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'interface'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'autodesk'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'psg'</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"><span class="typ">Amazon</span><span class="pln"> record </span><span class="str">"b000hkgj8k"</span><span class="pln"> has tokens </span><span class="kwd">and</span><span class="pln"> weights</span><span class="pun">:</span></code></li><li class="L1"><code class="language-python"><span class="pun">{</span><span class="str">'autocad'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">33.33333333333333</span><span class="pun">,</span><span class="pln"> </span><span class="str">'autodesk'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8.333333333333332</span><span class="pun">,</span><span class="pln"> </span><span class="str">'courseware'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">66.66666666666666</span><span class="pun">,</span><span class="pln"> </span><span class="str">'psg'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">33.33333333333333</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2007'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3.5087719298245617</span><span class="pun">,</span><span class="pln"> </span><span class="str">'customizing'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">16.666666666666664</span><span class="pun">,</span><span class="pln"> </span><span class="str">'interface'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3.0303030303030303</span><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="5-文本相似度-余弦" data-anchor-id="xmb8">5. 文本相似度--余弦</h3><p data-anchor-id="iym1">我们可以将文档看做是高维空间向量, 文本之间相似度可以通过计算向量之间的余弦值来衡量.如何将文档表达成为向量呢? 一种方式是使用词袋模型, 文档中的每一个词(去重复)表示向量的一个维度, 并且用这个词的权重来表示此维度的值.  <br>
接下来的问题是如何计算余弦值. 计算余弦的公式如下:  <br>
<span class="MathJax_Preview"></span><div style="text-align: center;" aria-readonly="true" role="textbox" class="MathJax_SVG_Display"><span id="MathJax-Element-1-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -771.9033013280564 8119.333333333334 1043.8066026561128" style="width: 18.889ex; height: 2.444ex; vertical-align: -0.778ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-61"></use><use y="0" x="751" xlink:href="#MJMAIN-22C5"></use><use y="0" x="1252" xlink:href="#MJMATHI-62"></use><use y="0" x="1959" xlink:href="#MJMAIN-3D"></use><use y="0" x="3016" xlink:href="#MJMAIN-2225"></use><use y="0" x="3516" xlink:href="#MJMATHI-61"></use><use y="0" x="4046" xlink:href="#MJMAIN-2225"></use><use y="0" x="4546" xlink:href="#MJMAIN-2225"></use><use y="0" x="5047" xlink:href="#MJMATHI-62"></use><use y="0" x="5476" xlink:href="#MJMAIN-2225"></use><g transform="translate(6143,0)"><use xlink:href="#MJMAIN-63"></use><use y="0" x="444" xlink:href="#MJMAIN-6F"></use><use y="0" x="945" xlink:href="#MJMAIN-73"></use></g><use y="0" x="7649" xlink:href="#MJMATHI-3B8"></use></g></svg></span></div><script id="MathJax-Element-1" type="math/tex; mode=display"> a \cdot b = \| a \| \| b \| \cos \theta </script> <br>
在这里 <span class="MathJax_Preview"></span><span aria-readonly="true" role="textbox" id="MathJax-Element-2-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -771.9033013280564 5886.777452466572 1043.8066026561128" style="width: 13.667ex; height: 2.444ex; vertical-align: -0.778ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-61"></use><use y="0" x="751" xlink:href="#MJMAIN-22C5"></use><use y="0" x="1252" xlink:href="#MJMATHI-62"></use><use y="0" x="1959" xlink:href="#MJMAIN-3D"></use><use y="0" x="3016" xlink:href="#MJSZ1-2211"></use><g transform="translate(4239,0)"><use xlink:href="#MJMATHI-61"></use><use y="-213" x="748" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g><g transform="translate(5112,0)"><use xlink:href="#MJMATHI-62"></use><use y="-213" x="607" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g></g></svg></span><script id="MathJax-Element-2" type="math/tex"> a \cdot b = \sum a_i b_i </script> 表示两个向量点乘的结果, <span class="MathJax_Preview"></span><span aria-readonly="true" role="textbox" id="MathJax-Element-3-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -1256.7251809844968 5627.629166206089 1903.8066026561128" style="width: 13.111ex; height: 4.444ex; vertical-align: -1.556ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMAIN-7C"></use><use y="0" x="278" xlink:href="#MJMATHI-61"></use><use y="0" x="808" xlink:href="#MJMAIN-7C"></use><use y="0" x="1364" xlink:href="#MJMAIN-3D"></use><g transform="translate(2420,0)"><use y="24" x="0" xlink:href="#MJSZ2-221A"></use><rect y="1115" x="1000" height="60" width="2206" stroke="none"></rect><g transform="translate(1000,0)"><use xlink:href="#MJSZ1-2211"></use><g transform="translate(1223,0)"><use xlink:href="#MJMATHI-61"></use><use y="488" x="748" xlink:href="#MJMAIN-32" transform="scale(0.7071067811865476)"></use><use y="-430" x="748" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g></g></g></g></svg></span><script id="MathJax-Element-3" type="math/tex"> |a| = \sqrt{ \sum a_i^2 } </script> 表示 <span class="MathJax_Preview"></span><span aria-readonly="true" role="textbox" id="MathJax-Element-4-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -462.9033013280564 529.5 494.80660265611283" style="width: 1.222ex; height: 1.111ex; vertical-align: -0.222ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-61"></use></g></svg></span><script id="MathJax-Element-4" type="math/tex"> a </script> 的模. 相似度可以表示为: <br>
<span class="MathJax_Preview"></span><div style="text-align: center;" aria-readonly="true" role="textbox" class="MathJax_SVG_Display"><span id="MathJax-Element-5-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -1482.5016346613897 20495.9805546344 3325.0032693227795" style="width: 47.556ex; height: 7.778ex; vertical-align: -4.333ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-73"></use><use y="0" x="469" xlink:href="#MJMATHI-69"></use><use y="0" x="815" xlink:href="#MJMATHI-6D"></use><use y="0" x="1693" xlink:href="#MJMATHI-69"></use><use y="0" x="2039" xlink:href="#MJMATHI-6C"></use><use y="0" x="2337" xlink:href="#MJMATHI-61"></use><use y="0" x="2867" xlink:href="#MJMATHI-72"></use><use y="0" x="3318" xlink:href="#MJMATHI-69"></use><use y="0" x="3664" xlink:href="#MJMATHI-74"></use><use y="0" x="4025" xlink:href="#MJMATHI-79"></use><use y="0" x="4800" xlink:href="#MJMAIN-3D"></use><g transform="translate(5857,0)"><use xlink:href="#MJMAIN-63"></use><use y="0" x="444" xlink:href="#MJMAIN-6F"></use><use y="0" x="945" xlink:href="#MJMAIN-73"></use></g><use y="0" x="7363" xlink:href="#MJMATHI-3B8"></use><use y="0" x="8110" xlink:href="#MJMAIN-3D"></use><g transform="translate(9286,0)"><rect y="220" x="0" height="60" width="3081" stroke="none"></rect><g transform="translate(699,676)"><use xlink:href="#MJMATHI-61"></use><use y="0" x="751" xlink:href="#MJMAIN-22C5"></use><use y="0" x="1252" xlink:href="#MJMATHI-62"></use></g><g transform="translate(60,-711)"><use xlink:href="#MJMAIN-2225"></use><use y="0" x="500" xlink:href="#MJMATHI-61"></use><use y="0" x="1030" xlink:href="#MJMAIN-2225"></use><use y="0" x="1530" xlink:href="#MJMAIN-2225"></use><use y="0" x="2031" xlink:href="#MJMATHI-62"></use><use y="0" x="2460" xlink:href="#MJMAIN-2225"></use></g></g><use y="0" x="12765" xlink:href="#MJMAIN-3D"></use><g transform="translate(13941,0)"><rect y="220" x="0" height="60" width="6434" stroke="none"></rect><g transform="translate(1781,710)"><use xlink:href="#MJSZ1-2211"></use><g transform="translate(1223,0)"><use xlink:href="#MJMATHI-61"></use><use y="-213" x="748" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g><g transform="translate(2096,0)"><use xlink:href="#MJMATHI-62"></use><use y="-213" x="607" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g></g><g transform="translate(60,-1196)"><use y="24" x="0" xlink:href="#MJSZ2-221A"></use><rect y="1115" x="1000" height="60" width="2206" stroke="none"></rect><g transform="translate(1000,0)"><use xlink:href="#MJSZ1-2211"></use><g transform="translate(1223,0)"><use xlink:href="#MJMATHI-61"></use><use y="488" x="748" xlink:href="#MJMAIN-32" transform="scale(0.7071067811865476)"></use><use y="-430" x="748" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g></g><g transform="translate(3207,0)"><use y="24" x="0" xlink:href="#MJSZ2-221A"></use><rect y="1115" x="1000" height="60" width="2106" stroke="none"></rect><g transform="translate(1000,0)"><use xlink:href="#MJSZ1-2211"></use><g transform="translate(1223,0)"><use xlink:href="#MJMATHI-62"></use><use y="488" x="607" xlink:href="#MJMAIN-32" transform="scale(0.7071067811865476)"></use><use y="-430" x="607" xlink:href="#MJMATHI-69" transform="scale(0.7071067811865476)"></use></g></g></g></g></g></g></svg></span></div><script id="MathJax-Element-5" type="math/tex; mode=display"> similarity = \cos \theta = \frac{a \cdot b}{\|a\| \|b\|} = \frac{\sum a_i b_i}{\sqrt{\sum a_i^2} \sqrt{\sum b_i^2}} </script> <br>
通过余弦的几何意义更直观表达计算结果的意义. 如果两个文档有比较多的词汇相同, 那么代表它们的向量之间的角度就比较小, 因为此时两个向量指向几乎相同的方向.</p><div class="md-section-divider"></div><h4 id="计算cosine相似度的函数" data-anchor-id="4x3o">计算<code>cosine</code>相似度的函数</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="or0t" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> math</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> dotprod</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute dot product</span></code></li><li class="L4"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L5"><code class="language-python"><span class="str">        a (dictionary): first dictionary of record to value</span></code></li><li class="L6"><code class="language-python"><span class="str">        b (dictionary): second dictionary of record to value</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        dotProd: result of the dot product with the two input dictionaries</span></code></li><li class="L9"><code class="language-python"><span class="str">    """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="com"># 使用dict的get方法, 设置默认值0, 可以避免出错</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> sum</span><span class="pun">([</span><span class="pln"> a</span><span class="pun">[</span><span class="pln">x</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> b</span><span class="pun">.</span><span class="pln">get</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> x </span><span class="kwd">in</span><span class="pln"> a</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">()])</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> norm</span><span class="pun">(</span><span class="pln">a</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute square root of the dot product</span></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        a (dictionary): a dictionary of record to value</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        norm: a dictionary of tokens to its TF values</span></code></li><li class="L9"><code class="language-python"><span class="str">    """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> math</span><span class="pun">.</span><span class="pln">sqrt</span><span class="pun">(</span><span class="pln">sum</span><span class="pun">([</span><span class="pln">x </span><span class="pun">*</span><span class="pln"> x </span><span class="kwd">for</span><span class="pln"> x </span><span class="kwd">in</span><span class="pln"> a</span><span class="pun">.</span><span class="pln">values</span><span class="pun">()]))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> cossim</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute cosine similarity</span></code></li><li class="L4"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L5"><code class="language-python"><span class="str">        a (dictionary): first dictionary of record to value</span></code></li><li class="L6"><code class="language-python"><span class="str">        b (dictionary): second dictionary of record to value</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        cossim: dot product of two dictionaries divided by the norm of the first dictionary and</span></code></li><li class="L9"><code class="language-python"><span class="str">                then by the norm of the second dictionary</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">dotprod</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln">b</span><span class="pun">))</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">norm</span><span class="pun">(</span><span class="pln">a</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> norm</span><span class="pun">(</span><span class="pln">b</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">testVec1 </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'foo'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">'bar'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="str">'baz'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5</span><span class="pln"> </span><span class="pun">}</span></code></li><li class="L4"><code class="language-python"><span class="pln">testVec2 </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'foo'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">'bar'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="str">'baz'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20</span><span class="pln"> </span><span class="pun">}</span></code></li><li class="L5"><code class="language-python"><span class="pln">dp </span><span class="pun">=</span><span class="pln"> dotprod</span><span class="pun">(</span><span class="pln">testVec1</span><span class="pun">,</span><span class="pln"> testVec2</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">nm </span><span class="pun">=</span><span class="pln"> norm</span><span class="pun">(</span><span class="pln">testVec1</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> dp</span><span class="pun">,</span><span class="pln"> nm</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">102</span><span class="pln"> </span><span class="lit">6.16441400297</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="l4la" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> cosineSimilarity</span><span class="pun">(</span><span class="pln">string1</span><span class="pun">,</span><span class="pln"> string2</span><span class="pun">,</span><span class="pln"> idfsDictionary</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute cosine similarity between two strings</span></code></li><li class="L2"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L3"><code class="language-python"><span class="str">        string1 (str): first string</span></code></li><li class="L4"><code class="language-python"><span class="str">        string2 (str): second string</span></code></li><li class="L5"><code class="language-python"><span class="str">        idfsDictionary (dictionary): a dictionary of IDF values</span></code></li><li class="L6"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L7"><code class="language-python"><span class="str">        cossim: cosine similarity value</span></code></li><li class="L8"><code class="language-python"><span class="str">    """</span></code></li><li class="L9"><code class="language-python"><span class="pln">    w1 </span><span class="pun">=</span><span class="pln"> tfidf</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">(</span><span class="pln">string1</span><span class="pun">),</span><span class="pln"> idfsDictionary</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> w1</span></code></li><li class="L1"><code class="language-python"><span class="pln">    w2 </span><span class="pun">=</span><span class="pln"> tfidf</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">(</span><span class="pln">string2</span><span class="pun">),</span><span class="pln"> idfsDictionary</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> w2</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> cossim</span><span class="pun">(</span><span class="pln">w1</span><span class="pun">,</span><span class="pln"> w2</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">cossimAdobe </span><span class="pun">=</span><span class="pln"> cosineSimilarity</span><span class="pun">(</span><span class="str">'Adobe Photoshop'</span><span class="pun">,</span></code></li><li class="L6"><code class="language-python"><span class="pln">                               </span><span class="str">'Adobe Illustrator'</span><span class="pun">,</span></code></li><li class="L7"><code class="language-python"><span class="pln">                               idfsSmallWeights</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> cossimAdobe</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="str">'photoshop'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">22.22222222222222</span><span class="pun">,</span><span class="pln"> </span><span class="str">'adobe'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8.333333333333334</span><span class="pun">}</span></code></li><li class="L2"><code class="language-python"><span class="pun">{</span><span class="str">'adobe'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8.333333333333334</span><span class="pun">,</span><span class="pln"> </span><span class="str">'illustrator'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">50.0</span><span class="pun">}</span></code></li><li class="L3"><code class="language-python"><span class="lit">0.0577243382163</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="进行实体解析" data-anchor-id="4taf">进行实体解析</h4><p data-anchor-id="94i3">需要有几个步骤:</p><ul data-anchor-id="f0v2">
<li>计算两个数据集的笛卡尔乘积, 得到任意两条记录组成的结果集, 结果类似于 <br>
[ ((Google URL1, Google String1), (Amazon ID1, Amazon String1)), ((Google URL1, Google String1), (Amazon ID2, Amazon String2)), ((Google URL2, Google String2), (Amazon ID1, Amazon String1)), ... ]</li>
<li>定义一个计算第一步中元组中记录相似度的函数</li>
<li>对RDD中的每个元组执行此函数</li>
<li>计算一个样例数据的相似度</li>
</ul><div class="md-section-divider"></div><pre style="" data-anchor-id="sts0" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 使用cartesian方法获取初步结果集</span></code></li><li class="L1"><code class="language-python"><span class="pln">crossSmall </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">googleSmall</span></code></li><li class="L2"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">cartesian</span><span class="pun">(</span><span class="pln">amazonSmall</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> computeSimilarity</span><span class="pun">(</span><span class="pln">record</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute similarity on a combination record</span></code></li><li class="L7"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L8"><code class="language-python"><span class="str">        record: a pair, (google record, amazon record)</span></code></li><li class="L9"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L0"><code class="language-python"><span class="str">        pair: a pair, (google URL, amazon ID, cosine similarity value)</span></code></li><li class="L1"><code class="language-python"><span class="str">    """</span></code></li><li class="L2"><code class="language-python"><span class="pln">    googleRec </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"><span class="pln">    amazonRec </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L4"><code class="language-python"><span class="pln">    googleURL </span><span class="pun">=</span><span class="pln"> googleRec</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L5"><code class="language-python"><span class="pln">    amazonID </span><span class="pun">=</span><span class="pln"> amazonRec</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L6"><code class="language-python"><span class="pln">    googleValue </span><span class="pun">=</span><span class="pln"> googleRec</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L7"><code class="language-python"><span class="pln">    amazonValue </span><span class="pun">=</span><span class="pln"> amazonRec</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L8"><code class="language-python"><span class="pln">    cs </span><span class="pun">=</span><span class="pln"> cosineSimilarity</span><span class="pun">(</span><span class="pln">googleValue</span><span class="pun">,</span><span class="pln"> amazonValue</span><span class="pun">,</span><span class="pln"> idfsSmallWeights</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">googleURL</span><span class="pun">,</span><span class="pln"> amazonID</span><span class="pun">,</span><span class="pln"> cs</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">similarities </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">crossSmall</span></code></li><li class="L2"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">computeSimilarity</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> similar</span><span class="pun">(</span><span class="pln">amazonID</span><span class="pun">,</span><span class="pln"> googleURL</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">""" Return similarity value</span></code></li><li class="L7"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L8"><code class="language-python"><span class="str">        amazonID: amazon ID</span></code></li><li class="L9"><code class="language-python"><span class="str">        googleURL: google URL</span></code></li><li class="L0"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L1"><code class="language-python"><span class="str">        similar: cosine similarity value</span></code></li><li class="L2"><code class="language-python"><span class="str">    """</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">similarities</span></code></li><li class="L4"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> record</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> googleURL </span><span class="kwd">and</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> amazonID</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">2</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">similarityAmazonGoogle </span><span class="pun">=</span><span class="pln"> similar</span><span class="pun">(</span><span class="str">'b000o24l3q'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/17242822440574356561'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Requested similarity is %s.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> similarityAmazonGoogle</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Requested</span><span class="pln"> similarity </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">0.000303171940451</span><span class="pun">.</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># cartesian方法的结果</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> crossSmall</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[((</span><span class="str">'http://www.google.com/base/feeds/snippets/11448761432933644608'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'spanish vocabulary builder "expand your vocabulary! contains fun lessons that both teach and entertain you\'ll quickly find yourself mastering new terms. includes games and more!" '</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b000jz4hqo'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'clickart 950 000 - premier image pack (dvd-rom)  "broderbund"'</span><span class="pun">))]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="使用broadcast-variables来计算相似度" data-anchor-id="wd89">使用Broadcast Variables来计算相似度</h4><p data-anchor-id="x00g">以上计算方法对于小数据集是可以的, 由于需要Spark把idfsSmallWeights发送给所有的worker, 如果不将idfsSmallWeights进行cache, 那么在程序运行过程中就会多次计算生成idfsSmallWeights, 这也会导致Spark将多次发送idfsSmallWeights. <br>
为避免这个问题, 我们可以将idfsSmallWeights定义为Broadcast Variable, 这样每个worker都可以引用这个变量, Spark也只需要发送此变量一次即可.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="77pc" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> computeSimilarityBroadcast</span><span class="pun">(</span><span class="pln">record</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute similarity on a combination record, using Broadcast variable</span></code></li><li class="L2"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L3"><code class="language-python"><span class="str">        record: a pair, (google record, amazon record)</span></code></li><li class="L4"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L5"><code class="language-python"><span class="str">        pair: a pair, (google URL, amazon ID, cosine similarity value)</span></code></li><li class="L6"><code class="language-python"><span class="str">    """</span></code></li><li class="L7"><code class="language-python"><span class="pln">    googleRec </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L8"><code class="language-python"><span class="pln">    amazonRec </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L9"><code class="language-python"><span class="pln">    googleURL </span><span class="pun">=</span><span class="pln"> googleRec</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"><span class="pln">    amazonID </span><span class="pun">=</span><span class="pln"> amazonRec</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L1"><code class="language-python"><span class="pln">    googleValue </span><span class="pun">=</span><span class="pln"> googleRec</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L2"><code class="language-python"><span class="pln">    amazonValue </span><span class="pun">=</span><span class="pln"> amazonRec</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># 从Broadcast Variable中获取值</span></code></li><li class="L4"><code class="language-python"><span class="pln">    cs </span><span class="pun">=</span><span class="pln"> cosineSimilarity</span><span class="pun">(</span><span class="pln">googleValue</span><span class="pun">,</span><span class="pln"> amazonValue</span><span class="pun">,</span><span class="pln"> idfsSmallBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">googleURL</span><span class="pun">,</span><span class="pln"> amazonID</span><span class="pun">,</span><span class="pln"> cs</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="com"># 设置idfsSmallBroadcast为Broadcast Variable</span></code></li><li class="L8"><code class="language-python"><span class="pln">idfsSmallBroadcast </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">idfsSmallWeights</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">similaritiesBroadcast </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">crossSmall</span></code></li><li class="L0"><code class="language-python"><span class="pln">                         </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">computeSimilarityBroadcast</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">                         </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> similarBroadcast</span><span class="pun">(</span><span class="pln">amazonID</span><span class="pun">,</span><span class="pln"> googleURL</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">""" Return similarity value, computed using Broadcast variable</span></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        amazonID: amazon ID</span></code></li><li class="L7"><code class="language-python"><span class="str">        googleURL: google URL</span></code></li><li class="L8"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L9"><code class="language-python"><span class="str">        similar: cosine similarity value</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">similaritiesBroadcast</span></code></li><li class="L2"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> record</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> googleURL </span><span class="kwd">and</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> amazonID</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">2</span><span class="pun">])</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">similarityAmazonGoogleBroadcast </span><span class="pun">=</span><span class="pln"> similarBroadcast</span><span class="pun">(</span><span class="str">'b000o24l3q'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/17242822440574356561'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Requested similarity is %s.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> similarityAmazonGoogleBroadcast</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Requested</span><span class="pln"> similarity </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">0.000303171940451</span><span class="pun">.</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="使用黄金标准对结果进行评估" data-anchor-id="w7dq">使用黄金标准对结果进行评估</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="vqd6" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">GOLDFILE_PATTERN </span><span class="pun">=</span><span class="pln"> </span><span class="str">'^(.+),(.+)'</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># Parse each line of a data file useing the specified regular expression pattern</span></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> parse_goldfile_line</span><span class="pun">(</span><span class="pln">goldfile_line</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">""" Parse a line from the 'golden standard' data file</span></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        goldfile_line: a line of data</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        pair: ((key, 'gold', 1 if successful or else 0))</span></code></li><li class="L9"><code class="language-python"><span class="str">    """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    match </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">search</span><span class="pun">(</span><span class="pln">GOLDFILE_PATTERN</span><span class="pun">,</span><span class="pln"> goldfile_line</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> match </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Invalid goldfile line: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> goldfile_line</span></code></li><li class="L3"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">goldfile_line</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">elif</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'"idAmazon"'</span><span class="pun">:</span></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Header datafile line: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> goldfile_line</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">goldfile_line</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L8"><code class="language-python"><span class="pln">        key </span><span class="pun">=</span><span class="pln"> </span><span class="str">'%s %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">removeQuotes</span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)),</span><span class="pln"> removeQuotes</span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">2</span><span class="pun">)))</span></code></li><li class="L9"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">((</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> </span><span class="str">'gold'</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">goldfile </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">baseDir</span><span class="pun">,</span><span class="pln"> inputPath</span><span class="pun">,</span><span class="pln"> GOLD_STANDARD_PATH</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">gsRaw </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sc</span></code></li><li class="L3"><code class="language-python"><span class="pln">         </span><span class="pun">.</span><span class="pln">textFile</span><span class="pun">(</span><span class="pln">goldfile</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">         </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">parse_goldfile_line</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">         </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">gsFailed </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gsRaw</span></code></li><li class="L8"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">            </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]))</span></code></li><li class="L0"><code class="language-python"><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> gsFailed</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Invalid goldfile line: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> line</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">goldStandard </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gsRaw</span></code></li><li class="L4"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Read %d lines, successfully parsed %d lines, failed to parse %d lines'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gsRaw</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span></code></li><li class="L9"><code class="language-python"><span class="pln">                                                                                 goldStandard</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span></code></li><li class="L0"><code class="language-python"><span class="pln">                                                                                 gsFailed</span><span class="pun">.</span><span class="pln">count</span><span class="pun">())</span></code></li><li class="L1"><code class="language-python"><span class="kwd">assert</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gsFailed</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="kwd">assert</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gsRaw</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="pun">(</span><span class="pln">goldStandard</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> goldStandard</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Read</span><span class="pln"> </span><span class="lit">1301</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> successfully parsed </span><span class="lit">1300</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> failed to parse </span><span class="lit">0</span><span class="pln"> lines</span></code></li><li class="L6"><code class="language-python"><span class="pun">[(</span><span class="pln">u</span><span class="str">'b000jz4hqo http://www.google.com/base/feeds/snippets/18441480711193821750'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'gold'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'b00004tkvy http://www.google.com/base/feeds/snippets/18441110047404795849'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'gold'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'b000g80lqo http://www.google.com/base/feeds/snippets/18441188461196475272'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'gold'</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="h5fx" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># similaritiesBroadcast中有4万条记录</span></code></li><li class="L1"><code class="language-python"><span class="com"># goldStandard中有1300多条记录</span></code></li><li class="L2"><code class="language-python"><span class="pln">sims </span><span class="pun">=</span><span class="pln"> similaritiesBroadcast</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="str">' '</span><span class="pun">.</span><span class="pln">join</span><span class="pun">([</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]]),</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></code></li><li class="L3"><code class="language-python"><span class="com"># print sims.take(3)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># 提取出键值出现在两者之中的记录</span></code></li><li class="L6"><code class="language-python"><span class="com">#.groupByKey())</span></code></li><li class="L7"><code class="language-python"><span class="com">#                .filter(lambda x : len(x[1]) &gt; 1))</span></code></li><li class="L8"><code class="language-python"><span class="pln">trueDupsRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sims</span></code></li><li class="L9"><code class="language-python"><span class="pln">               </span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">goldStandard</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">               </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">][</span><span class="lit">0</span><span class="pun">]))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># print trueDupsRDD.take(10)</span></code></li><li class="L3"><code class="language-python"><span class="com"># print trueDupsRDD.values().collect()</span></code></li><li class="L4"><code class="language-python"><span class="pln">trueDupsCount </span><span class="pun">=</span><span class="pln"> trueDupsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="com"># print trueDupsCount</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">avgSimDups </span><span class="pun">=</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">trueDupsRDD</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()))</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> trueDupsCount</span></code></li><li class="L8"><code class="language-python"><span class="com"># print avgSimDups</span></code></li><li class="L9"><code class="language-python"><span class="com"># 使用subtractByKey,而不是subtract</span></code></li><li class="L0"><code class="language-python"><span class="pln">nonDupsRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sims</span></code></li><li class="L1"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">subtractByKey</span><span class="pun">(</span><span class="pln">sims</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">goldStandard</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))</span></code></li><li class="L3"><code class="language-python"><span class="pln">avgSimNon </span><span class="pun">=</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">nonDupsRDD</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()))</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> nonDupsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> avgSimNon</span></code></li><li class="L5"><code class="language-python"><span class="com"># print 'There are %s true duplicates.' % trueDupsCount</span></code></li><li class="L6"><code class="language-python"><span class="com"># print 'The average similarity of true duplicates is %s.' % avgSimDups</span></code></li><li class="L7"><code class="language-python"><span class="com"># print 'And for non duplicates, it is %s.' % avgSimNon</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">0.00123476304656</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># 计算结果验证</span></code></li><li class="L3"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">trueDupsCount</span><span class="pun">,</span><span class="pln"> </span><span class="lit">146</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect trueDupsCount'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">abs</span><span class="pun">(</span><span class="pln">avgSimDups </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0.264332573435</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0.0000001</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect avgSimDups'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">abs</span><span class="pun">(</span><span class="pln">avgSimNon </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0.00123476304656</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0.0000001</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect avgSimNon'</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="6-在大数据集上进行实体解析" data-anchor-id="mshf">6. 在大数据集上进行实体解析</h3><p data-anchor-id="muha">前面的代码在小数据集上执行效率还可以接受, 但受限于其二次方级别的时间复杂度, 即使是中等级别的数据上执行上述代码也是不能接受的. 我们需要开发更好的算法. <br>
上述代码时间复杂度在二次方级别主要是因为以下两个方面:</p><ul data-anchor-id="o5yd">
<li>由于在比较时的重复生成tokens和weights, 产生了大量无用计算</li>
<li>记录之间的比较是二次方级别</li>
</ul><p data-anchor-id="12wx">针对第一个问题, 可以采用预处理和查找表的方式解决, 但是第二个问题并不容易解决. 在最坏情况下, 任意两条记录中间都有共有词汇, 最终的比较不可避免是二次方级别. <br>
实际情况下, 多数记录并没有共同词汇或者共同词汇非常少. 更进一步,通常 数据集A中的一条记录在数据集B中至多有一条记录匹配. 基于这种假设, 我们能够获得近似于线性复杂度的输出, 进而得到线性时间复杂度的算法. <br>
倒序索引<a target="_blank" href="https://en.wikipedia.org/wiki/Inverted_index">inverted index </a>这种数据结构能够避免二次方级别的比较. 倒序索引将文档中每个token和包含token的文档的list之间建立映射关系.</p><div class="md-section-divider"></div><h4 id="将完整的数据集tokenize化" data-anchor-id="33lq">将完整的数据集tokenize化</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="i62v" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">amazonFullRecToToken </span><span class="pun">=</span><span class="pln"> amazon</span><span class="pun">.</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">).</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="pln">googleFullRecToToken </span><span class="pun">=</span><span class="pln"> google</span><span class="pun">.</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">).</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Amazon full dataset is %s products, Google full dataset is %s products'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">amazonFullRecToToken</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln">googleFullRecToToken</span><span class="pun">.</span><span class="pln">count</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Amazon</span><span class="pln"> full dataset </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">1363</span><span class="pln"> products</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Google</span><span class="pln"> full dataset </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">3226</span><span class="pln"> products</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="计算完整数据集的tf和idf" data-anchor-id="g2s8">计算完整数据集的TF和IDF</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="f4lw" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">fullCorpusRDD </span><span class="pun">=</span><span class="pln"> amazon</span><span class="pun">.</span><span class="pln">union</span><span class="pun">(</span><span class="pln">google</span><span class="pun">).</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">idfsFull </span><span class="pun">=</span><span class="pln"> idfs</span><span class="pun">(</span><span class="pln">fullCorpusRDD</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">idfsFullCount </span><span class="pun">=</span><span class="pln"> idfsFull</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'There are %s unique tokens in the full datasets.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> idfsFullCount</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># # Recompute IDFs for full dataset</span></code></li><li class="L6"><code class="language-python"><span class="pln">idfsFullWeights </span><span class="pun">=</span><span class="pln"> idfsFull</span><span class="pun">.</span><span class="pln">collectAsMap</span><span class="pun">()</span></code></li><li class="L7"><code class="language-python"><span class="pln">idfsFullBroadcast </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">idfsFullWeights</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># Pre-compute TF-IDF weights.  Build mappings from record ID weight vector.</span></code></li><li class="L0"><code class="language-python"><span class="com"># 存储形式应该是(每个键值, 字典)</span></code></li><li class="L1"><code class="language-python"><span class="pln">amazonWeightsRDD </span><span class="pun">=</span><span class="pln"> amazonFullRecToToken</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> tfidf</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> idfsFullBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">)))</span></code></li><li class="L2"><code class="language-python"><span class="pln">googleWeightsRDD </span><span class="pun">=</span><span class="pln"> googleFullRecToToken</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> tfidf</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> idfsFullBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">)))</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'There are %s Amazon weights and %s Google weights.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">amazonWeightsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln">googleWeightsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">())</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">There</span><span class="pln"> are </span><span class="lit">17078</span><span class="pln"> unique tokens </span><span class="kwd">in</span><span class="pln"> the full datasets</span><span class="pun">.</span></code></li><li class="L7"><code class="language-python"><span class="typ">There</span><span class="pln"> are </span><span class="lit">1363</span><span class="pln"> </span><span class="typ">Amazon</span><span class="pln"> weights </span><span class="kwd">and</span><span class="pln"> </span><span class="lit">3226</span><span class="pln"> </span><span class="typ">Google</span><span class="pln"> weights</span><span class="pun">.</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># 结果数据</span></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> amazonWeightsRDD</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[(</span><span class="str">'b000fzvv3u'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">'case'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2.5255916345624656</span><span class="pun">,</span><span class="pln"> </span><span class="str">'10'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.5076889036397831</span><span class="pun">,</span><span class="pln"> </span><span class="str">'school'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2.1925465838509317</span><span class="pun">,</span><span class="pln"> </span><span class="str">'publishing'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.4251552795031057</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fogware'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5.250572082379862</span><span class="pun">,</span><span class="pln"> </span><span class="str">'win'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.7855186579938377</span><span class="pun">,</span><span class="pln"> </span><span class="str">'later'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.7974931453192322</span><span class="pun">,</span><span class="pln"> </span><span class="str">'jewel'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3.440029985007496</span><span class="pun">,</span><span class="pln"> </span><span class="str">'mac'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.48842530998882444</span><span class="pun">,</span><span class="pln"> </span><span class="str">'poetry'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">133.0144927536232</span><span class="pun">,</span><span class="pln"> </span><span class="str">'drama'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">79.80869565217391</span><span class="pun">,</span><span class="pln"> </span><span class="str">'middle'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">7.980869565217391</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.33309138419104306</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2000'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.6563215102974828</span><span class="pun">,</span><span class="pln"> </span><span class="str">'english'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.7053140096618358</span><span class="pun">,</span><span class="pln"> </span><span class="str">'8'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.6046113306982872</span><span class="pun">,</span><span class="pln"> </span><span class="str">'xp'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.47057013945857257</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fiction'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">133.0144927536232</span><span class="pun">})]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="计算权重的模" data-anchor-id="zois">计算权重的模</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="4lbu" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com">#计算norm是两个dict进行相乘,应该有1363个计算值</span></code></li><li class="L1"><code class="language-python"><span class="pln">amazonNorms </span><span class="pun">=</span><span class="pln"> amazonWeightsRDD</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> norm</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))).</span><span class="pln">collectAsMap</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">amazonNormsBroadcast </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">amazonNorms</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">googleNorms </span><span class="pun">=</span><span class="pln"> googleWeightsRDD</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> norm</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))).</span><span class="pln">collectAsMap</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="pln">googleNormsBroadcast </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">googleNorms</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># 测试结果</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> amazonNormsBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">[</span><span class="str">'b000fzvv3u'</span><span class="pun">]</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">204.645628157</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="创建倒序索引" data-anchor-id="9m1a">创建倒序索引</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="0i9x" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> invert</span><span class="pun">(</span><span class="pln">record</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">""" Invert (ID, tokens) to a list of (token, ID)</span></code></li><li class="L2"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L3"><code class="language-python"><span class="str">        record: a pair, (ID, token vector)</span></code></li><li class="L4"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L5"><code class="language-python"><span class="str">        pairs: a list of pairs of token to ID</span></code></li><li class="L6"><code class="language-python"><span class="str">    """</span></code></li><li class="L7"><code class="language-python"><span class="pln">    uid </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L8"><code class="language-python"><span class="pln">    tokens </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L9"><code class="language-python"><span class="pln">    pairs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> uid</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> key </span><span class="kwd">in</span><span class="pln"> tokens</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">()]</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pairs</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">amazonInvPairsRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">amazonWeightsRDD</span></code></li><li class="L3"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> dict</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])))</span></code></li><li class="L4"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">invert</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">flatMap</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> list</span><span class="pun">(</span><span class="pln">x</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">googleInvPairsRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">googleWeightsRDD</span></code></li><li class="L0"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> dict</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])))</span></code></li><li class="L1"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">invert</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">flatMap</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> list</span><span class="pun">(</span><span class="pln">x</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'There are %s Amazon inverted pairs and %s Google inverted pairs.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">amazonInvPairsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> googleInvPairsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">())</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">There</span><span class="pln"> are </span><span class="lit">111387</span><span class="pln"> </span><span class="typ">Amazon</span><span class="pln"> inverted pairs </span><span class="kwd">and</span><span class="pln"> </span><span class="lit">77678</span><span class="pln"> </span><span class="typ">Google</span><span class="pln"> inverted pairs</span><span class="pun">.</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># 测试结果</span></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> amazonWeightsRDD</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> </span><span class="pun">[</span><span class="pln">key </span><span class="kwd">for</span><span class="pln"> key </span><span class="kwd">in</span><span class="pln"> dict</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]).</span><span class="pln">keys</span><span class="pun">()])).</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">).</span><span class="pln">take</span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[(</span><span class="str">'b000fzvv3u'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fogware'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b000fzvv3u'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'win'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b000fzvv3u'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'middle'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b000fzvv3u'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'mac'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b000fzvv3u'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'xp'</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="筛选数据集中共有的token" data-anchor-id="6fmd">筛选数据集中共有的token</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="cm27" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 查看数据格式</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> amazonInvPairsRDD</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">googleInvPairsRDD</span><span class="pun">).</span><span class="pln">take</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[(</span><span class="str">'aided'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b000dz9yoa'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/17293379770636740081'</span><span class="pun">)),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'aided'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b0007yepy6'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/17293379770636740081'</span><span class="pun">)),</span><span class="pln"> </span><span class="pun">(</span><span class="str">'aided'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="str">'b00004ochi'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/17293379770636740081'</span><span class="pun">))]</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> swap</span><span class="pun">(</span><span class="pln">record</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">""" Swap (token, (ID, URL)) to ((ID, URL), token)</span></code></li><li class="L7"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L8"><code class="language-python"><span class="str">        record: a pair, (token, (ID, URL))</span></code></li><li class="L9"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L0"><code class="language-python"><span class="str">        pair: ((ID, URL), token)</span></code></li><li class="L1"><code class="language-python"><span class="str">    """</span></code></li><li class="L2"><code class="language-python"><span class="pln">    token </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"><span class="pln">    keys </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">keys</span><span class="pun">,</span><span class="pln"> token</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">commonTokens </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">amazonInvPairsRDD</span></code></li><li class="L7"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">googleInvPairsRDD</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">swap</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L0"><code class="language-python"><span class="pln">                </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Found %d common tokens'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> commonTokens</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Found</span><span class="pln"> </span><span class="lit">2441100</span><span class="pln"> common tokens</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># 结果测试</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> commonTokens</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> list</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))).</span><span class="pln">take</span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[((</span><span class="str">'b00005lzly'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/18376072611700638452'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'120'</span><span class="pun">]),</span><span class="pln"> </span><span class="pun">((</span><span class="str">'b000bnb72g'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/6959766318020460134'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'software'</span><span class="pun">]),</span><span class="pln"> </span><span class="pun">((</span><span class="str">'b00009apna'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/13986409474793202514'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'business'</span><span class="pun">]),</span><span class="pln"> </span><span class="pun">((</span><span class="str">'b00004ochi'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/7147648211015076337'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'rom'</span><span class="pun">]),</span><span class="pln"> </span><span class="pun">((</span><span class="str">'b000gcgqvy'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/6874875179525744781'</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'win'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'xp'</span><span class="pun">])]</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="u61x" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 设置为Broadcast Variable便于访问</span></code></li><li class="L1"><code class="language-python"><span class="pln">amazonWeightsBroadcast </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">idfs</span><span class="pun">(</span><span class="pln">amazon</span><span class="pun">.</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">)).</span><span class="pln">collectAsMap</span><span class="pun">())</span></code></li><li class="L2"><code class="language-python"><span class="pln">googleWeightsBroadcast </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">broadcast</span><span class="pun">(</span><span class="pln">idfs</span><span class="pun">(</span><span class="pln">google</span><span class="pun">.</span><span class="pln">flatMapValues</span><span class="pun">(</span><span class="pln">tokenize</span><span class="pun">)).</span><span class="pln">collectAsMap</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> fastCosineSimilarity</span><span class="pun">(</span><span class="pln">record</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="str">""" Compute Cosine Similarity using Broadcast variables</span></code></li><li class="L6"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L7"><code class="language-python"><span class="str">        record: ((ID, URL), token)</span></code></li><li class="L8"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L9"><code class="language-python"><span class="str">        pair: ((ID, URL), cosine similarity value)</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    amazonRec </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L2"><code class="language-python"><span class="pln">    googleRec </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">3</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"><span class="pln">    tokens </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># 根据共同的单词能够计算出点乘结果,还需要计算id和url对应的tokens的norm</span></code></li><li class="L5"><code class="language-python"><span class="pln">    s </span><span class="pun">=</span><span class="pln"> sum</span><span class="pun">([(</span><span class="pln">amazonWeightsBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">[</span><span class="pln">amazonRec</span><span class="pun">][</span><span class="pln">token</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> googleWeightsBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">[</span><span class="pln">googleRec</span><span class="pun">][</span><span class="pln">token</span><span class="pun">])</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> token </span><span class="kwd">in</span><span class="pln"> tokens</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"><span class="pln">    value </span><span class="pun">=</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">s</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dict</span><span class="pun">(</span><span class="pln">amazonNormsBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">)[</span><span class="pln">amazonRec</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> dict</span><span class="pun">(</span><span class="pln">googleNormsBroadcast</span><span class="pun">.</span><span class="pln">value</span><span class="pun">)[</span><span class="pln">googleRec</span><span class="pun">])</span></code></li><li class="L7"><code class="language-python"><span class="pln">    key </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">amazonRec</span><span class="pun">,</span><span class="pln"> googleRec</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">similaritiesFullRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">commonTokens</span></code></li><li class="L1"><code class="language-python"><span class="pln">                       </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">fastCosineSimilarity</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">                       </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> similaritiesFullRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">2441100</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com"># 结果测试</span></code></li><li class="L9"><code class="language-python"><span class="pln">similarityTest </span><span class="pun">=</span><span class="pln"> similaritiesFullRDD</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">((</span><span class="pln">aID</span><span class="pun">,</span><span class="pln"> gURL</span><span class="pun">),</span><span class="pln"> cs</span><span class="pun">):</span><span class="pln"> aID </span><span class="pun">==</span><span class="pln"> </span><span class="str">'b00005lzly'</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> gURL </span><span class="pun">==</span><span class="pln"> </span><span class="str">'http://www.google.com/base/feeds/snippets/13823221823254120257'</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L0"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">similarityTest</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect len(similarityTest)'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">abs</span><span class="pun">(</span><span class="pln">similarityTest</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">4.286548414e-06</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0.000000000001</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect similarityTest fastCosineSimilarity'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">similaritiesFullRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> </span><span class="lit">2441100</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect similaritiesFullRDD.count()'</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="8-分析" data-anchor-id="fkyf">8. 分析</h3><p data-anchor-id="3v8k">至此为止, 我们能够知道任意一对记录之间的相似度, 但决定记录是否重复还需要设置一个相似度阈值, 高于阈值认为是同一实体, 低于阈值则认为是不同的实体. 问题转为阈值应该如何确定. <br>
如果阈值确定的太低, 假阳性案例出现增多, 意味着不是同一实体的记录被认为是同一实体; 如果阈值确定的太高, 假阴性案例出现增多, 本来是同一实体的记录被认为是不同实体. <br>
对实体解析的评价有两个指标, 准确度和召回率.  准确度表示算法标识为同一实体中真正的同一实体比率, 召回率表示实体解析算法找出的真正的同一实体数量与整个数据中真正的同一实体比率. 通常需要在这两个指标之间进行平衡, 另外一个指标F-measure来同一表示两个指标, 公式如下: <br>
<span class="MathJax_Preview"></span><div style="text-align: center;" aria-readonly="true" role="textbox" class="MathJax_SVG_Display"><span id="MathJax-Element-6-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -1393.4113013280564 14747.666666666668 2295.2656026561126" style="width: 34.222ex; height: 5.333ex; vertical-align: -2.222ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-46"></use><use y="0" x="749" xlink:href="#MJMATHI-6D"></use><use y="0" x="1628" xlink:href="#MJMATHI-65"></use><use y="0" x="2094" xlink:href="#MJMATHI-61"></use><use y="0" x="2624" xlink:href="#MJMATHI-73"></use><use y="0" x="3093" xlink:href="#MJMATHI-75"></use><use y="0" x="3666" xlink:href="#MJMATHI-72"></use><use y="0" x="4117" xlink:href="#MJMATHI-65"></use><use y="0" x="4861" xlink:href="#MJMAIN-3D"></use><use y="0" x="5918" xlink:href="#MJMAIN-32"></use><g transform="translate(6705,0)"><rect y="220" x="0" height="60" width="7922" stroke="none"></rect><g transform="translate(199,676)"><use xlink:href="#MJMATHI-70"></use><use y="0" x="503" xlink:href="#MJMATHI-72"></use><use y="0" x="955" xlink:href="#MJMATHI-65"></use><use y="0" x="1421" xlink:href="#MJMATHI-63"></use><use y="0" x="1855" xlink:href="#MJMATHI-69"></use><use y="0" x="2200" xlink:href="#MJMATHI-73"></use><use y="0" x="2670" xlink:href="#MJMATHI-69"></use><use y="0" x="3015" xlink:href="#MJMATHI-6F"></use><use y="0" x="3501" xlink:href="#MJMATHI-6E"></use><use y="0" x="4323" xlink:href="#MJMAIN-2217"></use><use y="0" x="5046" xlink:href="#MJMATHI-72"></use><use y="0" x="5497" xlink:href="#MJMATHI-65"></use><use y="0" x="5964" xlink:href="#MJMATHI-63"></use><use y="0" x="6397" xlink:href="#MJMATHI-61"></use><use y="0" x="6927" xlink:href="#MJMATHI-6C"></use><use y="0" x="7225" xlink:href="#MJMATHI-6C"></use></g><g transform="translate(60,-686)"><use xlink:href="#MJMATHI-70"></use><use y="0" x="503" xlink:href="#MJMATHI-72"></use><use y="0" x="955" xlink:href="#MJMATHI-65"></use><use y="0" x="1421" xlink:href="#MJMATHI-63"></use><use y="0" x="1855" xlink:href="#MJMATHI-69"></use><use y="0" x="2200" xlink:href="#MJMATHI-73"></use><use y="0" x="2670" xlink:href="#MJMATHI-69"></use><use y="0" x="3015" xlink:href="#MJMATHI-6F"></use><use y="0" x="3501" xlink:href="#MJMATHI-6E"></use><use y="0" x="4323" xlink:href="#MJMAIN-2B"></use><use y="0" x="5324" xlink:href="#MJMATHI-72"></use><use y="0" x="5775" xlink:href="#MJMATHI-65"></use><use y="0" x="6242" xlink:href="#MJMATHI-63"></use><use y="0" x="6675" xlink:href="#MJMATHI-61"></use><use y="0" x="7205" xlink:href="#MJMATHI-6C"></use><use y="0" x="7503" xlink:href="#MJMATHI-6C"></use></g></g></g></svg></span></div><script id="MathJax-Element-6" type="math/tex; mode=display"> Fmeasure = 2 \frac{precision * recall}{precision + recall} </script></p><div class="md-section-divider"></div><h4 id="计算真阳性假阳性假阴性的值" data-anchor-id="hklo">计算真阳性/假阳性/假阴性的值</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="5uyi" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Create an RDD of ((Amazon ID, Google URL), similarity score)</span></code></li><li class="L1"><code class="language-python"><span class="pln">simsFullRDD </span><span class="pun">=</span><span class="pln"> similaritiesFullRDD</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="str">"%s %s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="lit">5</span><span class="pun">]),</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))</span></code></li><li class="L2"><code class="language-python"><span class="kwd">assert</span><span class="pln"> </span><span class="pun">(</span><span class="pln">simsFullRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">2441100</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Create an RDD of just the similarity scores</span></code></li><li class="L5"><code class="language-python"><span class="pln">simsFullValuesRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">simsFullRDD</span></code></li><li class="L6"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L7"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L8"><code class="language-python"><span class="kwd">assert</span><span class="pln"> </span><span class="pun">(</span><span class="pln">simsFullValuesRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">2441100</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="com"># Look up all similarity scores for true duplicates</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># This helper function will return the similarity score for records that are in the gold standard </span></code></li><li class="L3"><code class="language-python"><span class="com"># and the simsFullRDD (True positives), and will return 0 for records that are in the gold standard </span></code></li><li class="L4"><code class="language-python"><span class="com"># but not in simsFullRDD (False Negatives)</span></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> gs_value</span><span class="pun">(</span><span class="pln">record</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">][</span><span class="lit">6</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L9"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> record</span><span class="pun">[</span><span class="lit">1</span><span class="pun">][</span><span class="lit">7</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># Join the gold standard and simsFullRDD, and then extract the similarities scores using the helper function</span></code></li><li class="L2"><code class="language-python"><span class="pln">trueDupSimsRDD </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">goldStandard</span></code></li><li class="L3"><code class="language-python"><span class="pln">                  </span><span class="pun">.</span><span class="pln">leftOuterJoin</span><span class="pun">(</span><span class="pln">simsFullRDD</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">                  </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">gs_value</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">                  </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'There are %s true duplicates.'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> trueDupSimsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L7"><code class="language-python"><span class="kwd">assert</span><span class="pun">(</span><span class="pln">trueDupSimsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1300</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># 黄金标准中有1300对记录</span></code></li><li class="L0"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">There</span><span class="pln"> are </span><span class="lit">1300</span><span class="pln"> true duplicates</span><span class="pun">.</span></code></li></ol></pre><p data-anchor-id="khu7">接下来需要确定真阳性的阈值, 为了探索不同阈值对应的真阳性/假阳性/假阴性, 将0到1划分为100等份.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="m7da" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">accumulators </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">AccumulatorParam</span></code></li><li class="L1"><code class="language-python"><span class="kwd">class</span><span class="pln"> </span><span class="typ">VectorAccumulatorParam</span><span class="pun">(</span><span class="typ">AccumulatorParam</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># Initialize the VectorAccumulator to 0</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> zero</span><span class="pun">(</span><span class="pln">self</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">value</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Add two VectorAccumulator variables</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> addInPlace</span><span class="pun">(</span><span class="pln">self</span><span class="pun">,</span><span class="pln"> val1</span><span class="pun">,</span><span class="pln"> val2</span><span class="pun">):</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> xrange</span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">val1</span><span class="pun">)):</span></code></li><li class="L9"><code class="language-python"><span class="pln">            val1</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+=</span><span class="pln"> val2</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> val1</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># Return a list with entry x set to value and all other entries set to 0</span></code></li><li class="L3"><code class="language-python"><span class="com"># 初始化向量, 把特定位置设定为1, 其他位置设置为0</span></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> set_bit</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">,</span><span class="pln"> length</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    bits </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> y </span><span class="kwd">in</span><span class="pln"> xrange</span><span class="pun">(</span><span class="pln">length</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x </span><span class="pun">==</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L8"><code class="language-python"><span class="pln">          bits</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">value</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L0"><code class="language-python"><span class="pln">          bits</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> bits</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># Pre-bin counts of false positives for different threshold ranges</span></code></li><li class="L4"><code class="language-python"><span class="pln">BINS </span><span class="pun">=</span><span class="pln"> </span><span class="lit">101</span></code></li><li class="L5"><code class="language-python"><span class="pln">nthresholds </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100</span></code></li><li class="L6"><code class="language-python"><span class="kwd">def</span><span class="pln"> bin</span><span class="pun">(</span><span class="pln">similarity</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">similarity </span><span class="pun">*</span><span class="pln"> nthresholds</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># fpCounts[i] = number of entries (possible false positives) where bin(similarity) == i</span></code></li><li class="L0"><code class="language-python"><span class="pln">zeros </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> BINS</span></code></li><li class="L1"><code class="language-python"><span class="pln">fpCounts </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">accumulator</span><span class="pun">(</span><span class="pln">zeros</span><span class="pun">,</span><span class="pln"> </span><span class="typ">VectorAccumulatorParam</span><span class="pun">())</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> add_element</span><span class="pun">(</span><span class="pln">score</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">global</span><span class="pln"> fpCounts</span></code></li><li class="L5"><code class="language-python"><span class="pln">    b </span><span class="pun">=</span><span class="pln"> bin</span><span class="pun">(</span><span class="pln">score</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">    fpCounts </span><span class="pun">+=</span><span class="pln"> set_bit</span><span class="pun">(</span><span class="pln">b</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> BINS</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">simsFullValuesRDD</span><span class="pun">.</span><span class="pln">foreach</span><span class="pun">(</span><span class="pln">add_element</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="com"># Remove true positives from FP counts</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> sub_element</span><span class="pun">(</span><span class="pln">score</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">global</span><span class="pln"> fpCounts</span></code></li><li class="L3"><code class="language-python"><span class="pln">    b </span><span class="pun">=</span><span class="pln"> bin</span><span class="pun">(</span><span class="pln">score</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    fpCounts </span><span class="pun">+=</span><span class="pln"> set_bit</span><span class="pun">(</span><span class="pln">b</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> BINS</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">trueDupSimsRDD</span><span class="pun">.</span><span class="pln">foreach</span><span class="pun">(</span><span class="pln">sub_element</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="kwd">def</span><span class="pln"> falsepos</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    fpList </span><span class="pun">=</span><span class="pln"> fpCounts</span><span class="pun">.</span><span class="pln">value</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> sum</span><span class="pun">([</span><span class="pln">fpList</span><span class="pun">[</span><span class="pln">b</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> b </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> BINS</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">b</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> nthresholds </span><span class="pun">&gt;=</span><span class="pln"> threshold</span><span class="pun">])</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> falseneg</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> trueDupSimsRDD</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">:</span><span class="pln"> x </span><span class="pun">&lt;</span><span class="pln"> threshold</span><span class="pun">).</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> truepos</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> trueDupSimsRDD</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> falsenegDict</span><span class="pun">[</span><span class="pln">threshold</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="准确度召回率f-measures" data-anchor-id="el1b">准确度/召回率/F-measures</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="9729" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Precision = true-positives / (true-positives + false-positives)</span></code></li><li class="L1"><code class="language-python"><span class="com"># Recall = true-positives / (true-positives + false-negatives)</span></code></li><li class="L2"><code class="language-python"><span class="com"># F-measure = 2 x Recall x Precision / (Recall + Precision)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> precision</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    tp </span><span class="pun">=</span><span class="pln"> trueposDict</span><span class="pun">[</span><span class="pln">threshold</span><span class="pun">]</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">tp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="pln">tp </span><span class="pun">+</span><span class="pln"> falseposDict</span><span class="pun">[</span><span class="pln">threshold</span><span class="pun">])</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="kwd">def</span><span class="pln"> recall</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    tp </span><span class="pun">=</span><span class="pln"> trueposDict</span><span class="pun">[</span><span class="pln">threshold</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> float</span><span class="pun">(</span><span class="pln">tp</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="pln">tp </span><span class="pun">+</span><span class="pln"> falsenegDict</span><span class="pun">[</span><span class="pln">threshold</span><span class="pun">])</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> fmeasure</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    r </span><span class="pun">=</span><span class="pln"> recall</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> precision</span><span class="pun">(</span><span class="pln">threshold</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> r </span><span class="pun">*</span><span class="pln"> p </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="pln">r </span><span class="pun">+</span><span class="pln"> p</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="结果可视化" data-anchor-id="5r5e">结果可视化</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="w73v" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 三个指标随阈值变化图</span></code></li><li class="L1"><code class="language-python"><span class="pln">thresholds </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">float</span><span class="pun">(</span><span class="pln">n</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> nthresholds </span><span class="kwd">for</span><span class="pln"> n </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> nthresholds</span><span class="pun">)]</span></code></li><li class="L2"><code class="language-python"><span class="pln">falseposDict </span><span class="pun">=</span><span class="pln"> dict</span><span class="pun">([(</span><span class="pln">t</span><span class="pun">,</span><span class="pln"> falsepos</span><span class="pun">(</span><span class="pln">t</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> t </span><span class="kwd">in</span><span class="pln"> thresholds</span><span class="pun">])</span></code></li><li class="L3"><code class="language-python"><span class="pln">falsenegDict </span><span class="pun">=</span><span class="pln"> dict</span><span class="pun">([(</span><span class="pln">t</span><span class="pun">,</span><span class="pln"> falseneg</span><span class="pun">(</span><span class="pln">t</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> t </span><span class="kwd">in</span><span class="pln"> thresholds</span><span class="pun">])</span></code></li><li class="L4"><code class="language-python"><span class="pln">trueposDict </span><span class="pun">=</span><span class="pln"> dict</span><span class="pun">([(</span><span class="pln">t</span><span class="pun">,</span><span class="pln"> truepos</span><span class="pun">(</span><span class="pln">t</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> t </span><span class="kwd">in</span><span class="pln"> thresholds</span><span class="pun">])</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">precisions </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">precision</span><span class="pun">(</span><span class="pln">t</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> t </span><span class="kwd">in</span><span class="pln"> thresholds</span><span class="pun">]</span></code></li><li class="L7"><code class="language-python"><span class="pln">recalls </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">recall</span><span class="pun">(</span><span class="pln">t</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> t </span><span class="kwd">in</span><span class="pln"> thresholds</span><span class="pun">]</span></code></li><li class="L8"><code class="language-python"><span class="pln">fmeasures </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">fmeasure</span><span class="pun">(</span><span class="pln">t</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> t </span><span class="kwd">in</span><span class="pln"> thresholds</span><span class="pun">]</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> precisions</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> fmeasures</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L1"><code class="language-python"><span class="kwd">assert</span><span class="pln"> </span><span class="pun">(</span><span class="pln">abs</span><span class="pun">(</span><span class="pln">precisions</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0.000532546802671</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0.0000001</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="kwd">assert</span><span class="pln"> </span><span class="pun">(</span><span class="pln">abs</span><span class="pun">(</span><span class="pln">fmeasures</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0.00106452669505</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0.0000001</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">thresholds</span><span class="pun">,</span><span class="pln"> precisions</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">thresholds</span><span class="pun">,</span><span class="pln"> recalls</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">thresholds</span><span class="pun">,</span><span class="pln"> fmeasures</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">legend</span><span class="pun">([</span><span class="str">'Precision'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Recall'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'F-measure'</span><span class="pun">])</span></code></li><li class="L0"><code class="language-python"><span class="kwd">pass</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># 结果</span></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">0.000532546802671</span><span class="pln"> </span><span class="lit">0.00106452669505</span></code></li></ol></pre><p data-anchor-id="aya4"><img src="http://static.zybuluo.com/ronaldhan/n0yykzn0n3jmpcwguqymjue4/line.png" alt="line.png-40.2kB" title=""></p><div class="md-section-divider"></div><h3 id="9-讨论" data-anchor-id="59dn">9. 讨论</h3><p data-anchor-id="kn6l">在数据集上F-measures最好结果在40%左右, 并不高. 接下来可以采用的改进措施主要是:</p><ul data-anchor-id="2ye3">
<li>使用更多的属性</li>
<li>对现有的数据进行更好的特征提取, 包括使用词干法/n-grams等</li>
<li>采用其他计算相似度的函数</li>
</ul></div>
</body>
</html>