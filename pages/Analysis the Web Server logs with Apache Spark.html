<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>Apache Spark分析服务器日志</title>
<link href="../css/template-theme-white.css" rel="stylesheet" media="screen">
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 id="apache-spark分析服务器日志" data-anchor-id="076m">Apache Spark分析服务器日志</h1><p data-anchor-id="7vsi"><code>Spark</code> <code>日志分析</code></p><hr><p data-anchor-id="atcc">通过本文,能够发现使用Spark对网络日志进行分析是相当容易并且高效的. <br>
服务器日志是使用Spark进行分析的理想案例,主要是因为服务器日志很大,来源固定,并且包含一系列信息.</p><p data-anchor-id="jm5h">Tags : Spark 日志分析</p><div class="md-section-divider"></div><h3 id="内容目录" data-anchor-id="kz23">内容目录</h3><p data-anchor-id="vlb3"><div class="toc"><div class="toc">
<ul>
<li><a href="#apache-spark分析服务器日志">Apache Spark分析服务器日志</a><ul>
<li><ul>
<li><a href="#内容目录">内容目录</a></li>
<li><a href="#1-apache-web-server-log日志格式">1. Apache Web Server Log日志格式</a><ul>
<li><a href="#解析日志中的每一行">解析日志中的每一行</a></li>
<li><a href="#创建rdd">创建RDD</a></li>
<li><a href="#数据清洗">数据清洗</a></li>
</ul>
</li>
<li><a href="#2-对小部分日志数据的分析">2. 对小部分日志数据的分析</a><ul>
<li><a href="#统计返回内容大小">统计返回内容大小</a></li>
<li><a href="#统计状态码">统计状态码</a></li>
<li><a href="#使用matplotlab绘制状态码分布图">使用matplotlab绘制状态码分布图</a></li>
<li><a href="#主机访问频次统计">主机访问频次统计</a></li>
<li><a href="#对uri资源访问量的统计">对URI资源访问量的统计</a></li>
<li><a href="#访问量最多的uri">访问量最多的URI</a></li>
</ul>
</li>
<li><a href="#3-对日志进行分析">3. 对日志进行分析</a><ul>
<li><a href="#最常出现访问错误的uri">最常出现访问错误的URI</a></li>
<li><a href="#统计独立ip的数量">统计独立IP的数量</a></li>
<li><a href="#统计每天独立ip数量">统计每天独立IP数量</a></li>
<li><a href="#可视化每天独立ip数据">可视化每天独立IP数据</a></li>
<li><a href="#统计每天每个ip访问次数平均值">统计每天每个IP访问次数平均值</a></li>
<li><a href="#可视化每天每个ip访问次数平均值">可视化每天每个IP访问次数平均值</a></li>
</ul>
</li>
<li><a href="#4-404错误码出现情况进行分析">4. 404错误码出现情况进行分析</a><ul>
<li><a href="#统计404出现的次数">统计404出现的次数</a></li>
<li><a href="#找到出现404的记录">找到出现404的记录</a></li>
<li><a href="#找到出现404次数最多的uri资源">找到出现404次数最多的URI资源</a></li>
<li><a href="#找出出现最多404的访问ip">找出出现最多404的访问IP</a></li>
<li><a href="#统计每天出现404的数量">统计每天出现404的数量</a></li>
<li><a href="#出现404最多的5天">出现404最多的5天</a></li>
<li><a href="#统计以小时为单位出现404的情况">统计以小时为单位出现404的情况</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</p><div class="md-section-divider"></div><h3 id="1-apache-web-server-log日志格式" data-anchor-id="3auy">1. Apache Web Server Log日志格式</h3><p data-anchor-id="msh6">本文处理的日志格式为<a target="_blank" href="http://httpd.apache.org/docs/1.3/logs.html#common">通用日志格式</a>日志格式如下: <br>
<code>127.0.0.1 - - [01/Aug/1995:00:00:01 -0400] "GET /images/launch-logo.gif HTTP/1.0" 200 1839</code></p><ul data-anchor-id="erpy">
<li>127.0.0.1 表示访客的IP地址</li>
<li>访客的用户标识符</li>
<li>访客的local logon标识符</li>
<li>[01/Aug/1995:00:00:01 -0400] 服务器端处理完毕请求的时间,格式为[day/month/year:hour:minute:second timezone] <br>
<ul><li>day = 2位</li>
<li>month = 3字符</li>
<li>year = 4位</li>
<li>hour = 2位</li>
<li>minute = 2位</li>
<li>second = 2位</li>
<li>zone = (+ | -) 4位</li></ul></li>
<li>"GET /images/launch-logo.gif HTTP/1.0" 客户端请求地址和协议,包括三个部分: 请求方法(GET/POST/...),URI和客户端协议</li>
<li>200 服务器状态码</li>
<li>1839 返回客户端内容的长度</li>
</ul><p data-anchor-id="snzq">文中使用的数据是NASA肯尼迪空间中心的网络日志,下载地址<a target="_blank" href="http://ita.ee.lbl.gov/html/contrib/NASA-HTTP.html">http://ita.ee.lbl.gov/html/contrib/NASA-HTTP.html</a>,数据包含两个月的日志.</p><div class="md-section-divider"></div><h4 id="解析日志中的每一行" data-anchor-id="qjyh">解析日志中的每一行</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="bboo" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> re</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> datetime</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">sql </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Row</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">month_map </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'Jan'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Feb'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Mar'</span><span class="pun">:</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Apr'</span><span class="pun">:</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="str">'May'</span><span class="pun">:</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Jun'</span><span class="pun">:</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Jul'</span><span class="pun">:</span><span class="lit">7</span><span class="pun">,</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">'Aug'</span><span class="pun">:</span><span class="lit">8</span><span class="pun">,</span><span class="pln">  </span><span class="str">'Sep'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Oct'</span><span class="pun">:</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Nov'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Dec'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">12</span><span class="pun">}</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="kwd">def</span><span class="pln"> parse_apache_time</span><span class="pun">(</span><span class="pln">s</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="str">""" Convert Apache time format into a Python datetime object(转为python时间格式)</span></code></li><li class="L0"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L1"><code class="language-python"><span class="str">        s (str): date and time in Apache time format</span></code></li><li class="L2"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L3"><code class="language-python"><span class="str">        datetime: datetime object (ignore timezone for now)</span></code></li><li class="L4"><code class="language-python"><span class="str">    """</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> datetime</span><span class="pun">.</span><span class="pln">datetime</span><span class="pun">(</span><span class="pln">int</span><span class="pun">(</span><span class="pln">s</span><span class="pun">[</span><span class="lit">7</span><span class="pun">:</span><span class="lit">11</span><span class="pun">]),</span></code></li><li class="L6"><code class="language-python"><span class="pln">                             month_map</span><span class="pun">[</span><span class="pln">s</span><span class="pun">[</span><span class="lit">3</span><span class="pun">:</span><span class="lit">6</span><span class="pun">]],</span></code></li><li class="L7"><code class="language-python"><span class="pln">                             int</span><span class="pun">(</span><span class="pln">s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">:</span><span class="lit">2</span><span class="pun">]),</span></code></li><li class="L8"><code class="language-python"><span class="pln">                             int</span><span class="pun">(</span><span class="pln">s</span><span class="pun">[</span><span class="lit">12</span><span class="pun">:</span><span class="lit">14</span><span class="pun">]),</span></code></li><li class="L9"><code class="language-python"><span class="pln">                             int</span><span class="pun">(</span><span class="pln">s</span><span class="pun">[</span><span class="lit">15</span><span class="pun">:</span><span class="lit">17</span><span class="pun">]),</span></code></li><li class="L0"><code class="language-python"><span class="pln">                             int</span><span class="pun">(</span><span class="pln">s</span><span class="pun">[</span><span class="lit">18</span><span class="pun">:</span><span class="lit">20</span><span class="pun">]))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">def</span><span class="pln"> parseApacheLogLine</span><span class="pun">(</span><span class="pln">logline</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">""" Parse a line in the Apache Common Log format(解析CLF中的一行)</span></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        logline (str): a line of text in the Apache Common Log format</span></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        tuple: either a dictionary containing the parts of the Apache Access Log and 1,</span></code></li><li class="L9"><code class="language-python"><span class="str">               or the original invalid log line and 0</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    match </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">search</span><span class="pun">(</span><span class="pln">APACHE_ACCESS_LOG_PATTERN</span><span class="pun">,</span><span class="pln"> logline</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> match </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L3"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">logline</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    size_field </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">9</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> size_field </span><span class="pun">==</span><span class="pln"> </span><span class="str">'-'</span><span class="pun">:</span></code></li><li class="L6"><code class="language-python"><span class="pln">        size </span><span class="pun">=</span><span class="pln"> long</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L8"><code class="language-python"><span class="pln">        size </span><span class="pun">=</span><span class="pln"> long</span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">9</span><span class="pun">))</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Row</span><span class="pun">(</span></code></li><li class="L0"><code class="language-python"><span class="pln">        host          </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">1</span><span class="pun">),</span></code></li><li class="L1"><code class="language-python"><span class="pln">        client_identd </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">2</span><span class="pun">),</span></code></li><li class="L2"><code class="language-python"><span class="pln">        user_id       </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">3</span><span class="pun">),</span></code></li><li class="L3"><code class="language-python"><span class="pln">        date_time     </span><span class="pun">=</span><span class="pln"> parse_apache_time</span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">4</span><span class="pun">)),</span></code></li><li class="L4"><code class="language-python"><span class="pln">        method        </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">5</span><span class="pun">),</span></code></li><li class="L5"><code class="language-python"><span class="pln">        endpoint      </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">6</span><span class="pun">),</span></code></li><li class="L6"><code class="language-python"><span class="pln">        protocol      </span><span class="pun">=</span><span class="pln"> match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">7</span><span class="pun">),</span></code></li><li class="L7"><code class="language-python"><span class="pln">        response_code </span><span class="pun">=</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">match</span><span class="pun">.</span><span class="pln">group</span><span class="pun">(</span><span class="lit">8</span><span class="pun">)),</span></code></li><li class="L8"><code class="language-python"><span class="pln">        content_size  </span><span class="pun">=</span><span class="pln"> size</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># A regular expression pattern to extract fields from the log line</span></code></li><li class="L2"><code class="language-python"><span class="pln">APACHE_ACCESS_LOG_PATTERN </span><span class="pun">=</span><span class="pln"> </span><span class="str">'^(\S+) (\S+) (\S+) \[([\w:/]+\s[+\-]\d{4})\] "(\S+) (\S+)\s*(\S*)" (\d{3}) (\S+)'</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="创建rdd" data-anchor-id="sb70">创建RDD</h4><p data-anchor-id="u9oa">使用<code>SparkContext</code>的<code>textfile</code>方法加载本地的文件</p><div class="md-section-divider"></div><pre style="" data-anchor-id="m2qx" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> os</span></code></li><li class="L2"><code class="language-python"><span class="kwd">from</span><span class="pln"> test_helper </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Test</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">baseDir </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">inputPath </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">'cs100'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lab2'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'apache.access.log.PROJECT'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">logFile </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">baseDir</span><span class="pun">,</span><span class="pln"> inputPath</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="kwd">def</span><span class="pln"> parseLogs</span><span class="pun">():</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="str">""" Read and parse log file """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    parsed_logs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sc</span></code></li><li class="L1"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">textFile</span><span class="pun">(</span><span class="pln">logFile</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">parseApacheLogLine</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">    access_logs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">parsed_logs</span></code></li><li class="L6"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">])</span></code></li><li class="L8"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">    failed_logs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">parsed_logs</span></code></li><li class="L1"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]))</span></code></li><li class="L3"><code class="language-python"><span class="pln">    failed_logs_count </span><span class="pun">=</span><span class="pln"> failed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> failed_logs_count </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Number of invalid logline: %d'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> failed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> failed_logs</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">20</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">            </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Invalid logline: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> line</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'Read %d lines, successfully parsed %d lines, failed to parse %d lines'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">parsed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> failed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">())</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> parsed_logs</span><span class="pun">,</span><span class="pln"> access_logs</span><span class="pun">,</span><span class="pln"> failed_logs</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">parsed_logs</span><span class="pun">,</span><span class="pln"> access_logs</span><span class="pun">,</span><span class="pln"> failed_logs </span><span class="pun">=</span><span class="pln"> parseLogs</span><span class="pun">()</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="数据清洗" data-anchor-id="6xut">数据清洗</h4><p data-anchor-id="8dws">注意到日志中相当一部分数据并没有正常解析,需要修改<code>APACHE_ACCESS_LOG_PATTERN</code>来修正错误.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="mgo6" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># This was originally '^(\S+) (\S+) (\S+) \[([\w:/]+\s[+\-]\d{4})\] "(\S+) (\S+)\s*(\S*)" (\d{3}) (\S+)'</span></code></li><li class="L1"><code class="language-python"><span class="pln">APACHE_ACCESS_LOG_PATTERN </span><span class="pun">=</span><span class="pln"> </span><span class="str">'^(\S+) (\S+) (\S+) \[([\w:/]+\s[+\-]\d{4})\] "(\S+) (\S+)\s*(\S*)\s*" (\d{3}) (\S+)'</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">parsed_logs</span><span class="pun">,</span><span class="pln"> access_logs</span><span class="pun">,</span><span class="pln"> failed_logs </span><span class="pun">=</span><span class="pln"> parseLogs</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="com"># 输出结果如下</span></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Read</span><span class="pln"> </span><span class="lit">1043177</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> successfully parsed </span><span class="lit">1043177</span><span class="pln"> lines</span><span class="pun">,</span><span class="pln"> failed to parse </span><span class="lit">0</span><span class="pln"> lines</span></code></li><li class="L6"><code class="language-python"><span class="com"># 检验解析结果是否正确</span></code></li><li class="L7"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">failed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect failed_logs.count()'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">parsed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> </span><span class="lit">1043177</span><span class="pln"> </span><span class="pun">,</span><span class="pln"> </span><span class="str">'incorrect parsed_logs.count()'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="typ">Test</span><span class="pun">.</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">access_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> parsed_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span><span class="pln"> </span><span class="str">'incorrect access_logs.count()'</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="2-对小部分日志数据的分析" data-anchor-id="r2d4">2. 对小部分日志数据的分析</h3><p data-anchor-id="rydz">首先对小部分数据进行分析,一方面提高处理的效率,另一方面验证处理程序后再在大数据上执行.</p><div class="md-section-divider"></div><h4 id="统计返回内容大小" data-anchor-id="pass">统计返回内容大小</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="bq2o" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># lambda表达式将log对象中的size提取出来</span></code></li><li class="L1"><code class="language-python"><span class="com"># 使用RDD对象的min和max方法取得最小值和最大值</span></code></li><li class="L2"><code class="language-python"><span class="pln">content_sizes </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log</span><span class="pun">:</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">content_size</span><span class="pun">).</span><span class="pln">cache</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Content Size Avg: %i, Min: %i, Max: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L4"><code class="language-python"><span class="pln">    content_sizes</span><span class="pun">.</span><span class="pln">reduce</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> content_sizes</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(),</span></code></li><li class="L5"><code class="language-python"><span class="pln">    content_sizes</span><span class="pun">.</span><span class="pln">min</span><span class="pun">(),</span></code></li><li class="L6"><code class="language-python"><span class="pln">    content_sizes</span><span class="pun">.</span><span class="pln">max</span><span class="pun">())</span></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Content</span><span class="pln"> </span><span class="typ">Size</span><span class="pln"> </span><span class="typ">Avg</span><span class="pun">:</span><span class="pln"> </span><span class="lit">17531</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Min</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Max</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3421948</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="统计状态码" data-anchor-id="eg5f">统计状态码</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="b4zc" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># reduceByKey函数按照键值统计相关值的数量</span></code></li><li class="L1"><code class="language-python"><span class="pln">responseCodeToCount </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">access_logs</span></code></li><li class="L2"><code class="language-python"><span class="pln">                       </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">response_code</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">                       </span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">                       </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L5"><code class="language-python"><span class="pln">responseCodeToCountList </span><span class="pun">=</span><span class="pln"> responseCodeToCount</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">100</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Found %d response codes'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">responseCodeToCountList</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Response Code Counts: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> responseCodeToCountList</span></code></li><li class="L8"><code class="language-python"><span class="kwd">assert</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">responseCodeToCountList</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">7</span></code></li><li class="L9"><code class="language-python"><span class="kwd">assert</span><span class="pln"> sorted</span><span class="pun">(</span><span class="pln">responseCodeToCountList</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="lit">940847</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">302</span><span class="pun">,</span><span class="pln"> </span><span class="lit">16244</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">304</span><span class="pun">,</span><span class="pln"> </span><span class="lit">79824</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">403</span><span class="pun">,</span><span class="pln"> </span><span class="lit">58</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">404</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6185</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">500</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">501</span><span class="pun">,</span><span class="pln"> </span><span class="lit">17</span><span class="pun">)]</span></code></li><li class="L0"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Found</span><span class="pln"> </span><span class="lit">7</span><span class="pln"> response codes</span></code></li><li class="L1"><code class="language-python"><span class="typ">Response</span><span class="pln"> </span><span class="typ">Code</span><span class="pln"> </span><span class="typ">Counts</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="lit">940847</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">304</span><span class="pun">,</span><span class="pln"> </span><span class="lit">79824</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">404</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6185</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">500</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">501</span><span class="pun">,</span><span class="pln"> </span><span class="lit">17</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">302</span><span class="pun">,</span><span class="pln"> </span><span class="lit">16244</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">403</span><span class="pun">,</span><span class="pln"> </span><span class="lit">58</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="使用matplotlab绘制状态码分布图" data-anchor-id="tw2d">使用<code>matplotlab</code>绘制状态码分布图</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="0byv" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 获取状态码及其占比</span></code></li><li class="L1"><code class="language-python"><span class="pln">labels </span><span class="pun">=</span><span class="pln"> responseCodeToCount</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span><span class="pln"> x</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> labels</span></code></li><li class="L3"><code class="language-python"><span class="pln">count </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="pln">fracs </span><span class="pun">=</span><span class="pln"> responseCodeToCount</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span><span class="pln"> </span><span class="pun">(</span><span class="pln">float</span><span class="pun">(</span><span class="pln">y</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> count</span><span class="pun">)).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> fracs</span></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="lit">304</span><span class="pun">,</span><span class="pln"> </span><span class="lit">404</span><span class="pun">,</span><span class="pln"> </span><span class="lit">500</span><span class="pun">,</span><span class="pln"> </span><span class="lit">501</span><span class="pun">,</span><span class="pln"> </span><span class="lit">302</span><span class="pun">,</span><span class="pln"> </span><span class="lit">403</span><span class="pun">]</span></code></li><li class="L7"><code class="language-python"><span class="pun">[</span><span class="lit">0.9019054292799784</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.07652009198822443</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.005929003419362198</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.9172201841106543e-06</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.629637156494056e-05</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.015571662335346735</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5.5599385339208974e-05</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="4p6l" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 绘制饼图</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">pyplot </span><span class="kwd">as</span><span class="pln"> plt</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> pie_pct_format</span><span class="pun">(</span><span class="pln">value</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="str">""" Determine the appropriate format string for the pie chart percentage label</span></code></li><li class="L6"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L7"><code class="language-python"><span class="str">        value: value of the pie slice</span></code></li><li class="L8"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L9"><code class="language-python"><span class="str">        str: formated string label; if the slice is too small to fit, returns an empty string for label</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="str">''</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> value </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="str">'%.0f%%'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> value</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">4.5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4.5</span><span class="pun">),</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">colors </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'yellowgreen'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lightskyblue'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'gold'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'purple'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'lightcoral'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'yellow'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'black'</span><span class="pun">]</span></code></li><li class="L5"><code class="language-python"><span class="pln">explode </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="lit">0.05</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.05</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">patches</span><span class="pun">,</span><span class="pln"> texts</span><span class="pun">,</span><span class="pln"> autotexts </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">pie</span><span class="pun">(</span><span class="pln">fracs</span><span class="pun">,</span><span class="pln"> labels</span><span class="pun">=</span><span class="pln">labels</span><span class="pun">,</span><span class="pln"> colors</span><span class="pun">=</span><span class="pln">colors</span><span class="pun">,</span></code></li><li class="L7"><code class="language-python"><span class="pln">                                    explode</span><span class="pun">=</span><span class="pln">explode</span><span class="pun">,</span><span class="pln"> autopct</span><span class="pun">=</span><span class="pln">pie_pct_format</span><span class="pun">,</span></code></li><li class="L8"><code class="language-python"><span class="pln">                                    shadow</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">,</span><span class="pln">  startangle</span><span class="pun">=</span><span class="lit">125</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="kwd">for</span><span class="pln"> text</span><span class="pun">,</span><span class="pln"> autotext </span><span class="kwd">in</span><span class="pln"> zip</span><span class="pun">(</span><span class="pln">texts</span><span class="pun">,</span><span class="pln"> autotexts</span><span class="pun">):</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> autotext</span><span class="pun">.</span><span class="pln">get_text</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">:</span></code></li><li class="L1"><code class="language-python"><span class="pln">        text</span><span class="pun">.</span><span class="pln">set_text</span><span class="pun">(</span><span class="str">''</span><span class="pun">)</span><span class="pln">  </span><span class="com"># If the slice is small to fit, don't show a text label</span></code></li><li class="L2"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">legend</span><span class="pun">(</span><span class="pln">labels</span><span class="pun">,</span><span class="pln"> loc</span><span class="pun">=(</span><span class="lit">0.80</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.1</span><span class="pun">),</span><span class="pln"> shadow</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="wvll">饼图如下: <br>
<img src="http://static.zybuluo.com/ronaldhan/oe7efi2f3b7h7gfd300mbhsx/status_code.png" alt="status_code.png-29.4kB" title=""></p><div class="md-section-divider"></div><h4 id="主机访问频次统计" data-anchor-id="okbl">主机访问频次统计</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="6bax" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Any hosts that has accessed the server more than 10 times.</span></code></li><li class="L1"><code class="language-python"><span class="pln">hostCountPairTuple </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">host</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">hostSum </span><span class="pun">=</span><span class="pln"> hostCountPairTuple</span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="com"># 过滤出访问次数超过10的记录</span></code></li><li class="L5"><code class="language-python"><span class="pln">hostMoreThan10 </span><span class="pun">=</span><span class="pln"> hostSum</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">10</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="com"># 获取对应的主机名称或ip</span></code></li><li class="L7"><code class="language-python"><span class="pln">hostsPick20 </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">hostMoreThan10</span></code></li><li class="L8"><code class="language-python"><span class="pln">               </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">])</span></code></li><li class="L9"><code class="language-python"><span class="pln">               </span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">20</span><span class="pun">))</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Any 20 hosts that have accessed more then 10 times: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> hostsPick20</span></code></li><li class="L2"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Any</span><span class="pln"> </span><span class="lit">20</span><span class="pln"> hosts that have accessed more then </span><span class="lit">10</span><span class="pln"> times</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="pln">u</span><span class="str">'slip3.nilenet.com'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'client-71-31.online.apple.com'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'ix-jac2-16.ix.netcom.com'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'slip124.qlink.queensu.ca'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'ppp0e-01.rns.tamu.edu'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'ix-ftl2-16.ix.netcom.com'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'202.40.17.51'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'dialin14.wantree.com.au'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'y1a.kootenay.net'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'199.242.22.79'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'133.65.48.113'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'weird.stardust.com'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'ucsdtv2.ucsd.edu'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'dialup2.speed.net'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'147.150.5.96'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'pc-117.grassroots.ns.ca'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'152.52.29.20'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'asyn01.lw2.noord.bart.nl'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'bilbo.klautern.fh-rpl.de'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'cywilli.psdn177.pacbell.com'</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="对uri资源访问量的统计" data-anchor-id="0wlg">对URI资源访问量的统计</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="i711" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">endpoints </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">access_logs</span></code></li><li class="L1"><code class="language-python"><span class="pln">             </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">endpoint</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">             </span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">             </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"><span class="pln">ends </span><span class="pun">=</span><span class="pln"> endpoints</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span><span class="pln"> x</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="pln">counts </span><span class="pun">=</span><span class="pln"> endpoints</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span><span class="pln"> y</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">4.2</span><span class="pun">),</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">axis</span><span class="pun">([</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">ends</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">counts</span><span class="pun">)])</span></code></li><li class="L9"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">grid</span><span class="pun">(</span><span class="pln">b</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> which</span><span class="pun">=</span><span class="str">'major'</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="str">'y'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">xlabel</span><span class="pun">(</span><span class="str">'Endpoints'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">ylabel</span><span class="pun">(</span><span class="str">'Number of Hits'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">counts</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="ffvh"><img src="http://static.zybuluo.com/ronaldhan/zo8cz4vbxi0elw6kf9wb3wv0/URI_count.png" alt="URI_count.png-23.1kB" title=""></p><div class="md-section-divider"></div><h4 id="访问量最多的uri" data-anchor-id="9xpj">访问量最多的URI</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="5fzo" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">endpointCounts </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">access_logs</span></code></li><li class="L1"><code class="language-python"><span class="pln">                  </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">endpoint</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">                  </span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="com"># 对按照访问量进行从高到低排序</span></code></li><li class="L4"><code class="language-python"><span class="pln">topEndpoints </span><span class="pun">=</span><span class="pln"> endpointCounts</span><span class="pun">.</span><span class="pln">takeOrdered</span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> s</span><span class="pun">:</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Top Ten Endpoints: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> topEndpoints</span></code></li><li class="L7"><code class="language-python"><span class="kwd">assert</span><span class="pln"> topEndpoints </span><span class="pun">==</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">u</span><span class="str">'/images/NASA-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">59737</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/KSC-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">50452</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/MOSAIC-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43890</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/USA-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43664</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/WORLD-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43277</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/ksclogo-medium.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">41336</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/ksc.html'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">28582</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/images/apollo-logo1.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">26778</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/launch-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">24755</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20292</span><span class="pun">)],</span><span class="pln"> </span><span class="str">'incorrect Top Ten Endpoints'</span></code></li><li class="L8"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="typ">Ten</span><span class="pln"> </span><span class="typ">Endpoints</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">u</span><span class="str">'/images/NASA-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">59737</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/KSC-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">50452</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/MOSAIC-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43890</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/USA-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43664</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/WORLD-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43277</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/ksclogo-medium.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">41336</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/ksc.html'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">28582</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/images/apollo-logo1.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">26778</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/launch-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">24755</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20292</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="3-对日志进行分析" data-anchor-id="j1yn">3. 对日志进行分析</h3><div class="md-section-divider"></div><h4 id="最常出现访问错误的uri" data-anchor-id="55c6">最常出现访问错误的URI</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="lqyr" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">not200 </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">response_code </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">200</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="com"># 将每个URI映射为(URI, 1)这样的元组形式</span></code></li><li class="L2"><code class="language-python"><span class="pln">endpointCountPairTuple </span><span class="pun">=</span><span class="pln"> not200</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">endpoint</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="com"># 对个数进行加和统计</span></code></li><li class="L4"><code class="language-python"><span class="pln">endpointSum </span><span class="pun">=</span><span class="pln"> endpointCountPairTuple</span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="com"># 从高到低进行排序</span></code></li><li class="L6"><code class="language-python"><span class="pln">topTenErrURLs </span><span class="pun">=</span><span class="pln"> endpointSum</span><span class="pun">.</span><span class="pln">takeOrdered</span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Top Ten failed URLs: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> topTenErrURLs</span></code></li><li class="L8"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="typ">Ten</span><span class="pln"> failed </span><span class="typ">URLs</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">u</span><span class="str">'/images/NASA-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8761</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/KSC-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7236</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/MOSAIC-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5197</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/USA-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5157</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/WORLD-logosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5020</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/ksclogo-medium.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4728</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/images/apollo-logo1.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2907</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/launch-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2811</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2199</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/ksclogosmall.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1622</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="统计独立ip的数量" data-anchor-id="4fzg">统计独立IP的数量</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="25nl" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">hosts </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">host</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="com"># 使用distinct()函数获取唯一值</span></code></li><li class="L2"><code class="language-python"><span class="pln">uniqueHosts </span><span class="pun">=</span><span class="pln"> hosts</span><span class="pun">.</span><span class="pln">distinct</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">uniqueHostCount </span><span class="pun">=</span><span class="pln"> uniqueHosts</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Unique hosts: %d'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> uniqueHostCount</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Unique</span><span class="pln"> hosts</span><span class="pun">:</span><span class="pln"> </span><span class="lit">54507</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="统计每天独立ip数量" data-anchor-id="0zmw">统计每天独立IP数量</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="ghsf" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">dayToHostPairTuple </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">date_time</span><span class="pun">.</span><span class="pln">date</span><span class="pun">().</span><span class="pln">day</span><span class="pun">,</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">host</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"><span class="com"># 使用键进行聚合,结果形式类似于(key, [value1, value2, ...])</span></code></li><li class="L2"><code class="language-python"><span class="pln">dayGroupedHosts </span><span class="pun">=</span><span class="pln"> dayToHostPairTuple</span><span class="pun">.</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">dayHostCount </span><span class="pun">=</span><span class="pln"> dayGroupedHosts</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> values</span><span class="pun">)</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">set</span><span class="pun">(</span><span class="pln">values</span><span class="pun">))))</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">dailyHosts </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dayHostCount</span></code></li><li class="L7"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">sortByKey</span><span class="pun">()</span></code></li><li class="L8"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L9"><code class="language-python"><span class="pln">dailyHostsList </span><span class="pun">=</span><span class="pln"> dailyHosts</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">30</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Unique hosts per day: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> dailyHostsList</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Unique</span><span class="pln"> hosts per day</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2582</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3222</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4190</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2502</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2537</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4106</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4406</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4317</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4523</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4346</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2864</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">13</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2650</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">14</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4454</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4214</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">16</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4340</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">17</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4385</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">18</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4168</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">19</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2550</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2560</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">21</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4134</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">22</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4456</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="可视化每天独立ip数据" data-anchor-id="qzzv">可视化每天独立IP数据</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="k1y0" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">daysWithHosts </span><span class="pun">=</span><span class="pln"> dailyHosts</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">().</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> daysWithHosts</span></code></li><li class="L2"><code class="language-python"><span class="com"># 使用collect()函数将RDD转为python中list形式</span></code></li><li class="L3"><code class="language-python"><span class="pln">hosts </span><span class="pun">=</span><span class="pln"> dailyHosts</span><span class="pun">.</span><span class="pln">values</span><span class="pun">().</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> hosts</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">,</span><span class="pln"> </span><span class="lit">14</span><span class="pun">,</span><span class="pln"> </span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">16</span><span class="pun">,</span><span class="pln"> </span><span class="lit">17</span><span class="pun">,</span><span class="pln"> </span><span class="lit">18</span><span class="pun">,</span><span class="pln"> </span><span class="lit">19</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">21</span><span class="pun">,</span><span class="pln"> </span><span class="lit">22</span><span class="pun">]</span></code></li><li class="L7"><code class="language-python"><span class="pun">[</span><span class="lit">2582</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3222</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4190</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2502</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2537</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4106</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4406</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4317</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4523</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4346</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2864</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2650</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4454</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4214</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4340</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4385</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4168</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2550</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2560</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4134</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4456</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><pre style="" data-anchor-id="t8yq" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 使用matplotlab可视化</span></code></li><li class="L1"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">4.5</span><span class="pun">),</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">axis</span><span class="pun">([</span><span class="pln">min</span><span class="pun">(</span><span class="pln">daysWithHosts</span><span class="pun">),</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">daysWithHosts</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">hosts</span><span class="pun">)+</span><span class="lit">500</span><span class="pun">])</span></code></li><li class="L3"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">grid</span><span class="pun">(</span><span class="pln">b</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> which</span><span class="pun">=</span><span class="str">'major'</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="str">'y'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">xlabel</span><span class="pun">(</span><span class="str">'Day'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">ylabel</span><span class="pun">(</span><span class="str">'Hosts'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">daysWithHosts</span><span class="pun">,</span><span class="pln"> hosts</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="8q61"><img src="http://static.zybuluo.com/ronaldhan/m5776dg05wslpq682jjepox9/unique_host_day.png" alt="unique_host_day.png-23.3kB" title=""></p><div class="md-section-divider"></div><h4 id="统计每天每个ip访问次数平均值" data-anchor-id="o9o3">统计每天每个IP访问次数平均值</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="bfto" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">dayAndHostTuple </span><span class="pun">=</span><span class="pln"> access_logs</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">date_time</span><span class="pun">.</span><span class="pln">date</span><span class="pun">().</span><span class="pln">day</span><span class="pun">,</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">host</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">groupedByDay </span><span class="pun">=</span><span class="pln"> dayAndHostTuple</span><span class="pun">.</span><span class="pln">groupByKey</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">sortedByDay </span><span class="pun">=</span><span class="pln"> groupedByDay</span><span class="pun">.</span><span class="pln">sortByKey</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="com"># 利用lambda表达式直接求均值</span></code></li><li class="L6"><code class="language-python"><span class="pln">avgDailyReqPerHost </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sortedByDay</span></code></li><li class="L7"><code class="language-python"><span class="pln">                      </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span><span class="pln"> </span><span class="pun">(</span><span class="pln">key</span><span class="pun">,</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">set</span><span class="pun">(</span><span class="pln">value</span><span class="pun">))))</span></code></li><li class="L8"><code class="language-python"><span class="pln">                      </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L9"><code class="language-python"><span class="pln">avgDailyReqPerHostList </span><span class="pun">=</span><span class="pln"> avgDailyReqPerHost</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">30</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Average number of daily requests per Hosts is %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> avgDailyReqPerHostList</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Average</span><span class="pln"> number of daily requests per </span><span class="typ">Hosts</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">14</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="lit">14</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">14</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">13</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">14</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">16</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">17</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">18</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">19</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">21</span><span class="pun">,</span><span class="pln"> </span><span class="lit">13</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">22</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="可视化每天每个ip访问次数平均值" data-anchor-id="rbeh">可视化每天每个IP访问次数平均值</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="5kd2" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 转为list形式,用于绘图中坐标中数据</span></code></li><li class="L1"><code class="language-python"><span class="pln">daysWithAvg </span><span class="pun">=</span><span class="pln"> avgDailyReqPerHost</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">().</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">avgs </span><span class="pun">=</span><span class="pln"> avgDailyReqPerHost</span><span class="pun">.</span><span class="pln">values</span><span class="pun">().</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">4.2</span><span class="pun">),</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">axis</span><span class="pun">([</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">daysWithAvg</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">avgs</span><span class="pun">)+</span><span class="lit">2</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">grid</span><span class="pun">(</span><span class="pln">b</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> which</span><span class="pun">=</span><span class="str">'major'</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="str">'y'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">xlabel</span><span class="pun">(</span><span class="str">'Day'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">ylabel</span><span class="pun">(</span><span class="str">'Average'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">daysWithAvg</span><span class="pun">,</span><span class="pln"> avgs</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="bztj"><img src="http://static.zybuluo.com/ronaldhan/44o42917lf6npk4titew2rze/avg_host_day.png" alt="avg_host_day.png-16.2kB" title=""></p><div class="md-section-divider"></div><h3 id="4-404错误码出现情况进行分析" data-anchor-id="80c2">4. 404错误码出现情况进行分析</h3><div class="md-section-divider"></div><h4 id="统计404出现的次数" data-anchor-id="z47h">统计404出现的次数</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="wzhe" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">badRecords </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">access_logs</span></code></li><li class="L1"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">response_code </span><span class="pun">==</span><span class="pln"> </span><span class="lit">404</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">              </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Found %d 404 URLs'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> badRecords</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Found</span><span class="pln"> </span><span class="lit">6185</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> </span><span class="typ">URLs</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="找到出现404的记录" data-anchor-id="d5pi">找到出现404的记录</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="nq6p" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">badEndpoints </span><span class="pun">=</span><span class="pln"> badRecords</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">endpoint</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">badUniqueEndpoints </span><span class="pun">=</span><span class="pln"> badEndpoints</span><span class="pun">.</span><span class="pln">distinct</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">badUniqueEndpointsPick40 </span><span class="pun">=</span><span class="pln"> badUniqueEndpoints</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">40</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'404 URLS: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> badUniqueEndpointsPick40</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> URLS</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="pln">u</span><span class="str">'/11/history/apollo/images/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/128.159.104.89/tv/tv.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/imag'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/missionssts-70/woodpecker.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/~terrig/bookmark.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/elv/ATLAS_CENTAUR/p-ae.gif'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/pub.win'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/ksc.nasa.gov/images/ksclogo-medium.gif'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/apollo-13'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/missioins/sts-70/movies/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/missions/sts-69/mission-sts-74.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/missions/sts-80/mission-sts-80.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/histort/apollo/apollo13'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/www/ksc'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/miccions/sts-73/mission-sts-73.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/images/lf.gif'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/Missions/missions.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/ksc'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/missions/mission.html/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/images/jpeg/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/missions/sts-71/sts-69-info.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/images/crawlerway-logo.gif'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/home/whats-cool.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/procurement/business/ciao1.htm'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/icons/blank'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/HISTORY/APOLLO/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/finance/main.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/apollo/apollo-13/apollo_13.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/shuttle/countdown/images/yforw.gif'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/intersex.com/crawler.gif'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/apollo-13-info.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/images/hq.jpeg'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/apollo/apollo-13/*.gpg'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/apollo/apollo-13/apollo-11.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/discovery'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/history/apollo/apollo-13/movie'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/sofware/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/sjr/www/'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/KSC.html'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'/~adverts/graphics/indxlogo.gif'</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="找到出现404次数最多的uri资源" data-anchor-id="z5cw">找到出现404次数最多的URI资源</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="kk8o" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">badEndpointsCountPairTuple </span><span class="pun">=</span><span class="pln"> badRecords</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">endpoint</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">badEndpointsSum </span><span class="pun">=</span><span class="pln"> badEndpointsCountPairTuple</span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">badEndpointsTop20 </span><span class="pun">=</span><span class="pln"> badEndpointsSum</span><span class="pun">.</span><span class="pln">takeOrdered</span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Top Twenty 404 URLs: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> badEndpointsTop20</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="typ">Twenty</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> </span><span class="typ">URLs</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">u</span><span class="str">'/pub/winvn/readme.txt'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">633</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/pub/winvn/release.txt'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">494</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/shuttle/missions/STS-69/mission-STS-69.html'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">431</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/nasa-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">319</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/elv/DELTA/uncons.htm'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">178</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/shuttle/missions/sts-68/ksc-upclose.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">156</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/sa-1/sa-1-patch-small.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">146</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/crawlerway-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">120</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/://spacelink.msfc.nasa.gov'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">117</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/pad-abort-test-1/pad-abort-test-1-patch-small.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/a-001/a-001-patch-small.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">97</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/Nasa-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">85</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/shuttle/resources/orbiters/atlantis.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">64</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/images/little-joe.jpg'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">62</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/images/lf-logo.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">59</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/shuttle/resources/orbiters/discovery.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">56</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/shuttle/resources/orbiters/challenger.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">54</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/robots.txt'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">53</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/elv/new01.gif&gt;'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">43</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'/history/apollo/pad-abort-test-2/pad-abort-test-2-patch-small.gif'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">38</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="找出出现最多404的访问ip" data-anchor-id="m01o">找出出现最多404的访问IP</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="16h4" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">errHostsCountPairTuple </span><span class="pun">=</span><span class="pln"> badRecords</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">host</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">errHostsSum </span><span class="pun">=</span><span class="pln"> errHostsCountPairTuple</span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">errHostsTop25 </span><span class="pun">=</span><span class="pln"> errHostsSum</span><span class="pun">.</span><span class="pln">takeOrdered</span><span class="pun">(</span><span class="lit">25</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Top 25 hosts that generated errors: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> errHostsTop25</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="lit">25</span><span class="pln"> hosts that generated errors</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">u</span><span class="str">'piweba3y.prodigy.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">39</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'maz3.maz.net'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">39</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'gate.barr.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">38</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'m38-370-9.mit.edu'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">37</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'ts8-1.westwood.ts.ucla.edu'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">37</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'nexus.mlckew.edu.au'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">37</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'204.62.245.32'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">33</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'spica.sci.isas.ac.jp'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">27</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'163.206.104.34'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">27</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'www-d4.proxy.aol.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">26</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'203.13.168.24'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">25</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'www-c4.proxy.aol.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">25</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'203.13.168.17'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">25</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'internet-gw.watson.ibm.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">24</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'crl5.crl.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">23</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'scooter.pa-x.dec.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">23</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'piweba5y.prodigy.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">23</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'onramp2-9.onr.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">22</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'slip145-189.ut.nl.ibm.net'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">22</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'198.40.25.102.sap2.artic.edu'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">21</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'gn2.getnet.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'msp1-16.nas.mr.net'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'dial055.mbnet.mb.ca'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">19</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'isou24.vilspa.esa.es'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">19</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'tigger.nashscene.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">19</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="统计每天出现404的数量" data-anchor-id="kdos">统计每天出现404的数量</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="1jdo" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">errDateCountPairTuple </span><span class="pun">=</span><span class="pln"> badRecords</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">date_time</span><span class="pun">.</span><span class="pln">date</span><span class="pun">().</span><span class="pln">day</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">errDateSum </span><span class="pun">=</span><span class="pln"> errDateCountPairTuple</span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">errDateSorted </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">errDateSum</span></code></li><li class="L5"><code class="language-python"><span class="pln">                 </span><span class="pun">.</span><span class="pln">sortByKey</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="pln">                 </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">errByDate </span><span class="pun">=</span><span class="pln"> errDateSorted</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'404 Errors by day: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> errByDate</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> </span><span class="typ">Errors</span><span class="pln"> by day</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">243</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">303</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">346</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">234</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">372</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">532</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">381</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="lit">279</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">314</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">263</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">195</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">13</span><span class="pun">,</span><span class="pln"> </span><span class="lit">216</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">14</span><span class="pun">,</span><span class="pln"> </span><span class="lit">287</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">326</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">16</span><span class="pun">,</span><span class="pln"> </span><span class="lit">258</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">17</span><span class="pun">,</span><span class="pln"> </span><span class="lit">269</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">18</span><span class="pun">,</span><span class="pln"> </span><span class="lit">255</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">19</span><span class="pun">,</span><span class="pln"> </span><span class="lit">207</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">312</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">21</span><span class="pun">,</span><span class="pln"> </span><span class="lit">305</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">22</span><span class="pun">,</span><span class="pln"> </span><span class="lit">288</span><span class="pun">)]</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># 结果可视化</span></code></li><li class="L4"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">4.2</span><span class="pun">),</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">axis</span><span class="pun">([</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">daysWithErrors404</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">errors404ByDay</span><span class="pun">)])</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">grid</span><span class="pun">(</span><span class="pln">b</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> which</span><span class="pun">=</span><span class="str">'major'</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="str">'y'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">xlabel</span><span class="pun">(</span><span class="str">'Day'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">ylabel</span><span class="pun">(</span><span class="str">'404 Errors'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">daysWithErrors404</span><span class="pun">,</span><span class="pln"> errors404ByDay</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="u5cl"><img src="http://static.zybuluo.com/ronaldhan/3t540vc56ikiz8gvzde77ulr/host_404_day.png" alt="host_404_day.png-22.4kB" title=""></p><div class="md-section-divider"></div><h4 id="出现404最多的5天" data-anchor-id="rzvt">出现404最多的5天</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="i76g" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">topErrDate </span><span class="pun">=</span><span class="pln"> errDateSorted</span><span class="pun">.</span><span class="pln">sortBy</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x </span><span class="pun">:</span><span class="pln"> x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> </span><span class="pun">).</span><span class="pln">take</span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Top Five dates for 404 requests: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> topErrDate</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="typ">Five</span><span class="pln"> dates </span><span class="kwd">for</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> requests</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">532</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">381</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">372</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">346</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">326</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="统计以小时为单位出现404的情况" data-anchor-id="kxzp">统计以小时为单位出现404的情况</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="bfcz" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">hourCountPairTuple </span><span class="pun">=</span><span class="pln"> badRecords</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> log </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">log</span><span class="pun">.</span><span class="pln">date_time</span><span class="pun">.</span><span class="pln">time</span><span class="pun">().</span><span class="pln">hour</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">hourRecordsSum </span><span class="pun">=</span><span class="pln"> hourCountPairTuple</span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> a</span><span class="pun">,</span><span class="pln"> b </span><span class="pun">:</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">hourRecordsSorted </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">hourRecordsSum</span></code></li><li class="L5"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">sortByKey</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="pln">                     </span><span class="pun">.</span><span class="pln">cache</span><span class="pun">())</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">errHourList </span><span class="pun">=</span><span class="pln"> hourRecordsSorted</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Top hours for 404 requests: %s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> errHourList</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> hours </span><span class="kwd">for</span><span class="pln"> </span><span class="lit">404</span><span class="pln"> requests</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">175</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">171</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">422</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">272</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">102</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">95</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">93</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">122</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">199</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="lit">185</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">329</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">263</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">438</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">13</span><span class="pun">,</span><span class="pln"> </span><span class="lit">397</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">14</span><span class="pun">,</span><span class="pln"> </span><span class="lit">318</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">347</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">16</span><span class="pun">,</span><span class="pln"> </span><span class="lit">373</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">17</span><span class="pun">,</span><span class="pln"> </span><span class="lit">330</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">18</span><span class="pun">,</span><span class="pln"> </span><span class="lit">268</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">19</span><span class="pun">,</span><span class="pln"> </span><span class="lit">269</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">270</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">21</span><span class="pun">,</span><span class="pln"> </span><span class="lit">241</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">22</span><span class="pun">,</span><span class="pln"> </span><span class="lit">234</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">23</span><span class="pun">,</span><span class="pln"> </span><span class="lit">272</span><span class="pun">)]</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># 结果可视化</span></code></li><li class="L4"><code class="language-python"><span class="pln">hoursWithErrors404 </span><span class="pun">=</span><span class="pln"> hourRecordsSorted</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">().</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="pln">errors404ByHours </span><span class="pun">=</span><span class="pln"> hourRecordsSorted</span><span class="pun">.</span><span class="pln">values</span><span class="pun">().</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">fig </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">4.2</span><span class="pun">),</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">axis</span><span class="pun">([</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">hoursWithErrors404</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">errors404ByHours</span><span class="pun">)])</span></code></li><li class="L9"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">grid</span><span class="pun">(</span><span class="pln">b</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> which</span><span class="pun">=</span><span class="str">'major'</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="str">'y'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">xlabel</span><span class="pun">(</span><span class="str">'Hour'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">ylabel</span><span class="pun">(</span><span class="str">'404 Errors'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">hoursWithErrors404</span><span class="pun">,</span><span class="pln"> errors404ByHours</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="dawi"><img src="http://static.zybuluo.com/ronaldhan/aca8z6j9nymk86n8n6letah3/hour_404.png" alt="hour_404.png-26kB" title=""></p></div>
</body>
</html>