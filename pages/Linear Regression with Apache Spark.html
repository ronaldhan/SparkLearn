<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>Apache Spark 线性回归模型</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
</head>
<body class="theme theme-white">
<div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px none; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_SVG_Hidden"></div><svg><defs id="MathJax_SVG_glyphs"><path d="M624 444Q636 441 722 441Q797 441 800 444H805V382H741L593 11Q592 10 590 8T586 4T584 2T581 0T579 -2T575 -3T571 -3T567 -4T561 -4T553 -4H542Q525 -4 518 6T490 70Q474 110 463 137L415 257L367 137Q357 111 341 72Q320 17 313 7T289 -4H277Q259 -4 253 -2T238 11L90 382H25V444H32Q47 441 140 441Q243 441 261 444H270V382H222L310 164L382 342L366 382H303V444H310Q322 441 407 441Q508 441 523 444H531V382H506Q481 382 481 380Q482 376 529 259T577 142L674 382H617V444H624Z" stroke-width="1" id="MJMAINB-77"></path><path d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-69"></path><path d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z" stroke-width="1" id="MJMAIN-2B"></path><path d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" stroke-width="1" id="MJMAIN-31"></path><path d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" stroke-width="1" id="MJMAIN-3D"></path><path d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z" stroke-width="1" id="MJMAIN-2212"></path><path d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z" stroke-width="1" id="MJMATHI-3B1"></path><path d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z" stroke-width="1" id="MJSZ2-2211"></path><path d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z" stroke-width="1" id="MJMATHI-6A"></path><path d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z" stroke-width="1" id="MJMAIN-28"></path><path d="M55 642T55 648T59 659T66 666T71 668H708Q723 660 723 648T708 628H409V15Q402 2 391 0Q387 0 384 1T379 3T375 6T373 9T371 13T369 16V628H71Q70 628 67 630T59 637Z" stroke-width="1" id="MJMAIN-22A4"></path><path d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z" stroke-width="1" id="MJMAINB-78"></path><path d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z" stroke-width="1" id="MJMATHI-79"></path><path d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" stroke-width="1" id="MJMAIN-29"></path><path d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" stroke-width="1" id="MJMAIN-2E"></path><path stroke-width="1" id="MJMAIN-20"></path></defs></svg></div><div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 id="apache-spark-线性回归模型" data-anchor-id="lpyq">Apache Spark 线性回归模型</h1><p data-anchor-id="cfac"><code>Spark</code> <code>回归模型</code> <code>Linear</code> <code>Regression</code></p><hr><div class="md-section-divider"></div><h3 id="内容目录" data-anchor-id="a8to">内容目录</h3><p data-anchor-id="u5hn"><div class="toc"><div class="toc">
<ul>
<li><a href="#apache-spark-线性回归模型">Apache Spark 线性回归模型</a><ul>
<li><ul>
<li><a href="#内容目录">内容目录</a></li>
<li><a href="#1-数据准备">1. 数据准备</a><ul>
<li><a href="#加载数据">加载数据</a></li>
<li><a href="#使用labeledpoint-来表示数据">使用LabeledPoint 来表示数据</a></li>
<li><a href="#数据特征可视化">数据特征可视化</a></li>
<li><a href="#确定歌曲发布年份的范围">确定歌曲发布年份的范围</a></li>
<li><a href="#调整歌曲发布年份的时间区间">调整歌曲发布年份的时间区间</a></li>
<li><a href="#观察年份调整前和调整后的分布情况">观察年份调整前和调整后的分布情况</a></li>
<li><a href="#创建训练验证测试数据集">创建训练/验证/测试数据集</a></li>
</ul>
</li>
<li><a href="#2-创建基准模型">2. 创建基准模型</a><ul>
<li><a href="#均值模型">均值模型</a></li>
<li><a href="#均方根误差">均方根误差</a></li>
<li><a href="#均值模型的rmse">均值模型的RMSE</a></li>
<li><a href="#预测值与实际值">预测值与实际值</a></li>
</ul>
</li>
<li><a href="#3-回归模型的创建及评估">3. 回归模型的创建及评估</a><ul>
<li><a href="#梯度下降">梯度下降</a></li>
<li><a href="#利用权重值来做预测">利用权重值来做预测</a></li>
<li><a href="#梯度下降计算">梯度下降计算</a></li>
<li><a href="#训练回归模型">训练回归模型</a></li>
<li><a href="#模型训练误差可视化">模型训练误差可视化</a></li>
</ul>
</li>
<li><a href="#4-训练误差">4. 训练误差</a><ul>
<li><a href="#利用随机梯度下降训练回归模型">利用随机梯度下降训练回归模型</a></li>
<li><a href="#利用新模型进行预测">利用新模型进行预测</a></li>
<li><a href="#模型的rmse">模型的RMSE</a></li>
<li><a href="#网格搜索">网格搜索</a></li>
<li><a href="#最优模型的预测">最优模型的预测</a></li>
</ul>
</li>
<li><a href="#5-数据特征的一些分析">5. 数据特征的一些分析</a><ul>
<li><a href="#特征数据的两路作用2-way-interactions">特征数据的两路作用(2-way interactions)</a></li>
<li><a href="#构建新的模型">构建新的模型</a></li>
<li><a href="#在测试数据上测试新模型">在测试数据上测试新模型</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</p><p data-anchor-id="seqv">Tags : Spark 回归模型 Linear Regression</p><p data-anchor-id="r2gx">本文涵盖通用的监督学习流程， 使用<a target="_blank" href="http://labrosa.ee.columbia.edu/millionsong/">Million Song Dataset</a>数据的一个子集， 数据来自于<a target="_blank" href="https://archive.ics.uci.edu/ml/datasets/YearPredictionMSD">UCI Machine Learning Repository</a>项目。本文的目标是建立一个线性回归模型，在给定歌曲特征时，预测歌曲的发布年份。</p><div class="md-section-divider"></div><h3 id="1-数据准备" data-anchor-id="oa3c">1. 数据准备</h3><div class="md-section-divider"></div><h4 id="加载数据" data-anchor-id="8x52">加载数据</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="qib5" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># load testing library</span></code></li><li class="L1"><code class="language-python"><span class="kwd">from</span><span class="pln"> test_helper </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Test</span></code></li><li class="L2"><code class="language-python"><span class="kwd">import</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span></code></li><li class="L3"><code class="language-python"><span class="pln">baseDir </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">inputPath </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">'cs190'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'millionsong.txt'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">fileName </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">baseDir</span><span class="pun">,</span><span class="pln"> inputPath</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">numPartitions </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span></code></li><li class="L8"><code class="language-python"><span class="pln">rawData </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">textFile</span><span class="pun">(</span><span class="pln">fileName</span><span class="pun">,</span><span class="pln"> numPartitions</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">numPoints </span><span class="pun">=</span><span class="pln"> rawData</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> numPoints</span></code></li><li class="L2"><code class="language-python"><span class="pln">samplePoints </span><span class="pun">=</span><span class="pln"> rawData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> samplePoints</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">6724</span></code></li><li class="L6"><code class="language-python"><span class="pun">[</span><span class="pln">u</span><span class="str">'2001.0,0.884123733793,0.610454259079,0.600498416968,0.474669212493,0.247232680947,0.357306088914,0.344136412234,0.339641227335,0.600858840135,0.425704689024,0.60491501652,0.419193351817'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'2001.0,0.854411946129,0.604124786151,0.593634078776,0.495885413963,0.266307830936,0.261472105188,0.506387076327,0.464453565511,0.665798573683,0.542968988766,0.58044428577,0.445219373624'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'2001.0,0.908982970575,0.632063159227,0.557428975183,0.498263761394,0.276396052336,0.312809861625,0.448530069406,0.448674249968,0.649791323916,0.489868662682,0.591908113534,0.4500023818'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'2001.0,0.842525219898,0.561826888508,0.508715259692,0.443531142139,0.296733836002,0.250213568176,0.488540873206,0.360508747659,0.575435243185,0.361005878554,0.678378718617,0.409036786173'</span><span class="pun">,</span><span class="pln"> u</span><span class="str">'2001.0,0.909303285534,0.653607720915,0.585580794716,0.473250503005,0.251417011835,0.326976795524,0.40432273022,0.371154511756,0.629401917965,0.482243251755,0.566901413923,0.463373691946'</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="使用labeledpoint-来表示数据" data-anchor-id="djge">使用<code>LabeledPoint</code> 来表示数据</h4><p data-anchor-id="98t3">在Spark MLib中，带标注的数据使用<a target="_blank" href="https://spark.apache.org/docs/latest/api/python/pyspark.mllib.html#pyspark.mllib.regression.LabeledPoint">LabeledPoint</a>来存储。我们需要把数据表示成为<code>LabeledPoint</code>的格式。</p><div class="md-section-divider"></div><pre style="" data-anchor-id="csbv" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">mllib</span><span class="pun">.</span><span class="pln">regression </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">LabeledPoint</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> numpy </span><span class="kwd">as</span><span class="pln"> np</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># 样例数据， 其中2001是标签，其他的是特征数据</span></code></li><li class="L4"><code class="language-python"><span class="com"># '2001.0,0.884,0.610,0.600,0.474,0.247,0.357,0.344,0.33,0.600,0.425,0.60,0.419'</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="kwd">def</span><span class="pln"> parsePoint</span><span class="pun">(</span><span class="pln">line</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="str">"""Converts a comma separated unicode string into a `LabeledPoint`.</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L0"><code class="language-python"><span class="str">        line (unicode): Comma separated unicode string where the first element is the label and the</span></code></li><li class="L1"><code class="language-python"><span class="str">            remaining elements are features.</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L4"><code class="language-python"><span class="str">        LabeledPoint: The line is converted into a `LabeledPoint`, which consists of a label and</span></code></li><li class="L5"><code class="language-python"><span class="str">            features.</span></code></li><li class="L6"><code class="language-python"><span class="str">    """</span></code></li><li class="L7"><code class="language-python"><span class="pln">    tokens </span><span class="pun">=</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">','</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">    label</span><span class="pun">,</span><span class="pln"> features </span><span class="pun">=</span><span class="pln"> tokens</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> tokens</span><span class="pun">[</span><span class="lit">1</span><span class="pun">:]</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> features</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">parsedSamplePoints </span><span class="pun">=</span><span class="pln"> map</span><span class="pun">(</span><span class="pln">parsePoint</span><span class="pun">,</span><span class="pln"> samplePoints</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">firstPointFeatures </span><span class="pun">=</span><span class="pln"> parsedSamplePoints</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">features</span></code></li><li class="L3"><code class="language-python"><span class="pln">firstPointLabel </span><span class="pun">=</span><span class="pln"> parsedSamplePoints</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">label</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> firstPointFeatures</span><span class="pun">,</span><span class="pln"> firstPointLabel</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">d </span><span class="pun">=</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">firstPointFeatures</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> d</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># 输入结果</span></code></li><li class="L0"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.884123733793</span><span class="pun">,</span><span class="lit">0.610454259079</span><span class="pun">,</span><span class="lit">0.600498416968</span><span class="pun">,</span><span class="lit">0.474669212493</span><span class="pun">,</span><span class="lit">0.247232680947</span><span class="pun">,</span><span class="lit">0.357306088914</span><span class="pun">,</span><span class="lit">0.344136412234</span><span class="pun">,</span><span class="lit">0.339641227335</span><span class="pun">,</span><span class="lit">0.600858840135</span><span class="pun">,</span><span class="lit">0.425704689024</span><span class="pun">,</span><span class="lit">0.60491501652</span><span class="pun">,</span><span class="lit">0.419193351817</span><span class="pun">]</span><span class="pln"> </span><span class="lit">2001.0</span></code></li><li class="L1"><code class="language-python"><span class="lit">12</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="数据特征可视化" data-anchor-id="padl">数据特征可视化</h4><p data-anchor-id="z57e">每个样本有12个特征值, 并且都介于0到1之间, 为了方便观察数据的特征, 使用hotmap来可视化数据, 观察数据的特征. 数据值用灰度表示, 颜色越深表明值越接近1.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="aau5" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">pyplot </span><span class="kwd">as</span><span class="pln"> plt</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">cm </span><span class="kwd">as</span><span class="pln"> cm</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">sampleMorePoints </span><span class="pun">=</span><span class="pln"> rawData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">50</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># 随机选择50条记录</span></code></li><li class="L6"><code class="language-python"><span class="com"># sampleMorePoints = rawData.takeSample(False, 50)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">parsedSampleMorePoints </span><span class="pun">=</span><span class="pln"> map</span><span class="pun">(</span><span class="pln">parsePoint</span><span class="pun">,</span><span class="pln"> sampleMorePoints</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">dataValues </span><span class="pun">=</span><span class="pln"> map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">.</span><span class="pln">toArray</span><span class="pun">(),</span><span class="pln"> parsedSampleMorePoints</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">xticks</span><span class="pun">,</span><span class="pln"> yticks</span><span class="pun">,</span><span class="pln"> figsize</span><span class="pun">=(</span><span class="lit">10.5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6</span><span class="pun">),</span><span class="pln"> hideLabels</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> gridColor</span><span class="pun">=</span><span class="str">'#999999'</span><span class="pun">,</span><span class="pln"> gridWidth</span><span class="pun">=</span><span class="lit">1.0</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="str">"""Template for generating the plot layout."""</span></code></li><li class="L3"><code class="language-python"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="pln">    fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">subplots</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=</span><span class="pln">figsize</span><span class="pun">,</span><span class="pln"> facecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">,</span><span class="pln"> edgecolor</span><span class="pun">=</span><span class="str">'white'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    ax</span><span class="pun">.</span><span class="pln">axes</span><span class="pun">.</span><span class="pln">tick_params</span><span class="pun">(</span><span class="pln">labelcolor</span><span class="pun">=</span><span class="str">'#999999'</span><span class="pun">,</span><span class="pln"> labelsize</span><span class="pun">=</span><span class="str">'10'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> axis</span><span class="pun">,</span><span class="pln"> ticks </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">[(</span><span class="pln">ax</span><span class="pun">.</span><span class="pln">get_xaxis</span><span class="pun">(),</span><span class="pln"> xticks</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ax</span><span class="pun">.</span><span class="pln">get_yaxis</span><span class="pun">(),</span><span class="pln"> yticks</span><span class="pun">)]:</span></code></li><li class="L7"><code class="language-python"><span class="pln">        axis</span><span class="pun">.</span><span class="pln">set_ticks_position</span><span class="pun">(</span><span class="str">'none'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">        axis</span><span class="pun">.</span><span class="pln">set_ticks</span><span class="pun">(</span><span class="pln">ticks</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">        axis</span><span class="pun">.</span><span class="pln">label</span><span class="pun">.</span><span class="pln">set_color</span><span class="pun">(</span><span class="str">'#999999'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> hideLabels</span><span class="pun">:</span><span class="pln"> axis</span><span class="pun">.</span><span class="pln">set_ticklabels</span><span class="pun">([])</span></code></li><li class="L1"><code class="language-python"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">grid</span><span class="pun">(</span><span class="pln">color</span><span class="pun">=</span><span class="pln">gridColor</span><span class="pun">,</span><span class="pln"> linewidth</span><span class="pun">=</span><span class="pln">gridWidth</span><span class="pun">,</span><span class="pln"> linestyle</span><span class="pun">=</span><span class="str">'-'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">    map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> position</span><span class="pun">:</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">spines</span><span class="pun">[</span><span class="pln">position</span><span class="pun">].</span><span class="pln">set_visible</span><span class="pun">(</span><span class="kwd">False</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="str">'bottom'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'top'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'left'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'right'</span><span class="pun">])</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> fig</span><span class="pun">,</span><span class="pln"> ax</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># generate layout and plot</span></code></li><li class="L6"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(.</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(.</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">49</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="lit">7</span><span class="pun">),</span><span class="pln"> hideLabels</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> gridColor</span><span class="pun">=</span><span class="str">'#eeeeee'</span><span class="pun">,</span><span class="pln"> gridWidth</span><span class="pun">=</span><span class="lit">1.1</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">image </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">imshow</span><span class="pun">(</span><span class="pln">dataValues</span><span class="pun">,</span><span class="pln">interpolation</span><span class="pun">=</span><span class="str">'nearest'</span><span class="pun">,</span><span class="pln"> aspect</span><span class="pun">=</span><span class="str">'auto'</span><span class="pun">,</span><span class="pln"> cmap</span><span class="pun">=</span><span class="pln">cm</span><span class="pun">.</span><span class="typ">Greys</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="kwd">for</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> s </span><span class="kwd">in</span><span class="pln"> zip</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(-.</span><span class="lit">125</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">repeat</span><span class="pun">(-.</span><span class="lit">75</span><span class="pun">,</span><span class="pln"> </span><span class="lit">12</span><span class="pun">),</span><span class="pln"> </span><span class="pun">[</span><span class="pln">str</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> x </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">12</span><span class="pun">)]):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">text</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">,</span><span class="pln"> color</span><span class="pun">=</span><span class="str">'#999999'</span><span class="pun">,</span><span class="pln"> size</span><span class="pun">=</span><span class="str">'10'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">text</span><span class="pun">(</span><span class="lit">4.7</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Feature'</span><span class="pun">,</span><span class="pln"> color</span><span class="pun">=</span><span class="str">'#999999'</span><span class="pun">,</span><span class="pln"> size</span><span class="pun">=</span><span class="str">'11'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="str">'Observation'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="sygi"><img src="http://static.zybuluo.com/ronaldhan/elujcdongxtxxx5xl1mfu1xj/hotmap.png" alt="hotmap.png-22.2kB" title=""></p><div class="md-section-divider"></div><h4 id="确定歌曲发布年份的范围" data-anchor-id="qbcm">确定歌曲发布年份的范围</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="xsj3" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">parsedDataInit </span><span class="pun">=</span><span class="pln"> rawData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="pln">parsePoint</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">onlyLabels </span><span class="pun">=</span><span class="pln"> parsedDataInit</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">minYear </span><span class="pun">=</span><span class="pln"> min</span><span class="pun">(</span><span class="pln">onlyLabels</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">maxYear </span><span class="pun">=</span><span class="pln"> max</span><span class="pun">(</span><span class="pln">onlyLabels</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> maxYear</span><span class="pun">,</span><span class="pln"> minYear</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># 测试结果</span></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">2011.0</span><span class="pln"> </span><span class="lit">1922.0</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="调整歌曲发布年份的时间区间" data-anchor-id="8g4z">调整歌曲发布年份的时间区间</h4><p data-anchor-id="gadz">从以上分析中可以看出来年份大体在1900-2000之间, 通常机器学习问题会将数据标签设置为从0开始, 我们需要将年份转换到以0开始, 具体方法是: 所有年份 - 最小年份 = 新的年份值</p><div class="md-section-divider"></div><pre style="" data-anchor-id="zbqs" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">parsedData </span><span class="pun">=</span><span class="pln"> parsedDataInit</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label </span><span class="pun">-</span><span class="pln"> minYear</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># Should be a LabeledPoint</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> type</span><span class="pun">(</span><span class="pln">parsedData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)[</span><span class="lit">0</span><span class="pun">])</span></code></li><li class="L4"><code class="language-python"><span class="com"># View the first point</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'\n{0}'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">parsedData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">&lt;</span><span class="kwd">class</span><span class="pln"> </span><span class="str">'pyspark.mllib.regression.LabeledPoint'</span><span class="pun">&gt;</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">[</span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">79.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.884123733793</span><span class="pun">,</span><span class="lit">0.610454259079</span><span class="pun">,</span><span class="lit">0.600498416968</span><span class="pun">,</span><span class="lit">0.474669212493</span><span class="pun">,</span><span class="lit">0.247232680947</span><span class="pun">,</span><span class="lit">0.357306088914</span><span class="pun">,</span><span class="lit">0.344136412234</span><span class="pun">,</span><span class="lit">0.339641227335</span><span class="pun">,</span><span class="lit">0.600858840135</span><span class="pun">,</span><span class="lit">0.425704689024</span><span class="pun">,</span><span class="lit">0.60491501652</span><span class="pun">,</span><span class="lit">0.419193351817</span><span class="pun">])]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="观察年份调整前和调整后的分布情况" data-anchor-id="30xd">观察年份调整前和调整后的分布情况</h4><p data-anchor-id="62fc">调整前</p><div class="md-section-divider"></div><pre style="" data-anchor-id="jhf3" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">oldData </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">parsedDataInit</span></code></li><li class="L1"><code class="language-python"><span class="pln">           </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">           </span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">:</span><span class="pln"> x </span><span class="pun">+</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">           </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"><span class="pln">x</span><span class="pun">,</span><span class="pln"> y </span><span class="pun">=</span><span class="pln"> zip</span><span class="pun">(*</span><span class="pln">oldData</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># generate layout and plot data</span></code></li><li class="L7"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">1920</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2050</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">150</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">))</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="str">'#d6ebf2'</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#8cbfd0'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Year'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="str">'Count'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="erfd"><img src="http://static.zybuluo.com/ronaldhan/kbisj9v0202ygbewfgoi35po/year_shift_before.png" alt="year_shift_before.png-43kB" title=""></p><p data-anchor-id="1w8m">调整后</p><div class="md-section-divider"></div><pre style="" data-anchor-id="3emz" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">newData </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">parsedData</span></code></li><li class="L1"><code class="language-python"><span class="pln">           </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">           </span><span class="pun">.</span><span class="pln">reduceByKey</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">:</span><span class="pln"> x </span><span class="pun">+</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">           </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"><span class="pln">x</span><span class="pun">,</span><span class="pln"> y </span><span class="pun">=</span><span class="pln"> zip</span><span class="pun">(*</span><span class="pln">newData</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># generate layout and plot data</span></code></li><li class="L7"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">120</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">120</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">))</span></code></li><li class="L8"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="str">'#d6ebf2'</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#8cbfd0'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Year (shifted)'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="str">'Count'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="er4z"><img src="http://static.zybuluo.com/ronaldhan/7sqj74tnaehizpzm0x6i97fe/year_shift_after.png" alt="year_shift_after.png-46.1kB" title=""></p><div class="md-section-divider"></div><h4 id="创建训练验证测试数据集" data-anchor-id="kjau">创建训练/验证/测试数据集</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="53h7" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">weights </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[.</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="pun">.</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="pun">.</span><span class="lit">1</span><span class="pun">]</span></code></li><li class="L1"><code class="language-python"><span class="pln">seed </span><span class="pun">=</span><span class="pln"> </span><span class="lit">42</span></code></li><li class="L2"><code class="language-python"><span class="pln">parsedTrainData</span><span class="pun">,</span><span class="pln"> parsedValData</span><span class="pun">,</span><span class="pln"> parsedTestData </span><span class="pun">=</span><span class="pln"> parsedData</span><span class="pun">.</span><span class="pln">randomSplit</span><span class="pun">(</span><span class="pln">weights</span><span class="pun">,</span><span class="pln"> seed</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">parsedTrainData</span><span class="pun">.</span><span class="pln">cache</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"><span class="pln">parsedValData</span><span class="pun">.</span><span class="pln">cache</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"><span class="pln">parsedTestData</span><span class="pun">.</span><span class="pln">cache</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="pln">nTrain </span><span class="pun">=</span><span class="pln"> parsedTrainData</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L7"><code class="language-python"><span class="pln">nVal </span><span class="pun">=</span><span class="pln"> parsedValData</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L8"><code class="language-python"><span class="pln">nTest </span><span class="pun">=</span><span class="pln"> parsedTestData</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> nTrain</span><span class="pun">,</span><span class="pln"> nVal</span><span class="pun">,</span><span class="pln"> nTest</span><span class="pun">,</span><span class="pln"> nTrain </span><span class="pun">+</span><span class="pln"> nVal </span><span class="pun">+</span><span class="pln"> nTest</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> parsedData</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">5371</span><span class="pln"> </span><span class="lit">682</span><span class="pln"> </span><span class="lit">671</span><span class="pln"> </span><span class="lit">6724</span></code></li><li class="L4"><code class="language-python"><span class="lit">6724</span></code></li></ol></pre><div class="md-section-divider"></div><h3 id="2-创建基准模型" data-anchor-id="omz7">2. 创建基准模型</h3><div class="md-section-divider"></div><h4 id="均值模型" data-anchor-id="di3d">均值模型</h4><p data-anchor-id="7xam">最简单的预测是为每一个输入值返回已有数据标签值的均值作为预测结果. 这里的标签值是经过处理后的值.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="41ut" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">averageTrainYear </span><span class="pun">=</span><span class="pln"> parsedTrainData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">).</span><span class="pln">mean</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> averageTrainYear</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">53.9316700801</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="均方根误差" data-anchor-id="iwcv">均方根误差</h4><p data-anchor-id="ehzb">均方根误差用来衡量模型的优劣</p><div class="md-section-divider"></div><pre style="" data-anchor-id="idru" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> squaredError</span><span class="pun">(</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> prediction</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="str">"""Calculates the the squared error for a single prediction.</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L4"><code class="language-python"><span class="str">        label (float): The correct value for this observation.</span></code></li><li class="L5"><code class="language-python"><span class="str">        prediction (float): The predicted value for this observation.</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L8"><code class="language-python"><span class="str">        float: The difference between the `label` and `prediction` squared.</span></code></li><li class="L9"><code class="language-python"><span class="str">    """</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">label </span><span class="pun">-</span><span class="pln"> prediction</span><span class="pun">)</span><span class="pln"> </span><span class="pun">**</span><span class="pln"> </span><span class="lit">2</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPreds</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">"""Calculates the root mean squared error for an `RDD` of (label, prediction) tuples.</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L6"><code class="language-python"><span class="str">        labelsAndPred (RDD of (float, float)): An `RDD` consisting of (label, prediction) tuples.</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L9"><code class="language-python"><span class="str">        float: The square root of the mean of the squared errors.</span></code></li><li class="L0"><code class="language-python"><span class="str">    """</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sqrt</span><span class="pun">(</span><span class="pln">labelsAndPreds</span></code></li><li class="L2"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> prediction</span><span class="pun">):</span><span class="pln"> squaredError</span><span class="pun">(</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> prediction</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">mean</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">labelsAndPreds </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">parallelize</span><span class="pun">([(</span><span class="lit">3.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2.</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">2.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2.</span><span class="pun">)])</span></code></li><li class="L6"><code class="language-python"><span class="com"># RMSE = sqrt[((3-1)^2 + (1-2)^2 + (2-2)^2) / 3] = 1.291</span></code></li><li class="L7"><code class="language-python"><span class="pln">exampleRMSE </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPreds</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="kwd">print</span><span class="pln"> exampleRMSE</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">1.29099444874</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="均值模型的rmse" data-anchor-id="x5zp">均值模型的RMSE</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="8j3d" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">labelsAndPredsTrain </span><span class="pun">=</span><span class="pln"> parsedTrainData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> averageTrainYear</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"><span class="pln">rmseTrainBase </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPredsTrain</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">labelsAndPredsVal </span><span class="pun">=</span><span class="pln"> parsedValData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> averageTrainYear</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="pln">rmseValBase </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPredsVal</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">labelsAndPredsTest </span><span class="pun">=</span><span class="pln"> parsedTestData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> averageTrainYear</span><span class="pun">))</span></code></li><li class="L7"><code class="language-python"><span class="pln">rmseTestBase </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPredsTest</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Baseline Train RMSE = {0:.3f}'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseTrainBase</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Baseline Validation RMSE = {0:.3f}'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseValBase</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Baseline Test RMSE = {0:.3f}'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseTestBase</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Baseline</span><span class="pln"> </span><span class="typ">Train</span><span class="pln"> RMSE </span><span class="pun">=</span><span class="pln"> </span><span class="lit">21.306</span></code></li><li class="L4"><code class="language-python"><span class="typ">Baseline</span><span class="pln"> </span><span class="typ">Validation</span><span class="pln"> RMSE </span><span class="pun">=</span><span class="pln"> </span><span class="lit">21.586</span></code></li><li class="L5"><code class="language-python"><span class="typ">Baseline</span><span class="pln"> </span><span class="typ">Test</span><span class="pln"> RMSE </span><span class="pun">=</span><span class="pln"> </span><span class="lit">22.137</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="预测值与实际值" data-anchor-id="y9fy">预测值与实际值</h4><p data-anchor-id="bvtz">在验证数据集上计算预测值, 并与实际值进行比较. 在理想情况下, 预测值与实际值完全相等. 使用均值模型时, 对于任意输入都给出均值作为预测值. 两种情况下的图示如下. 图中点的颜色越深, 表明预测值与实际值之间的差值越大.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="gein" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 理想情况下, 图像是条45°直线</span></code></li><li class="L1"><code class="language-python"><span class="kwd">from</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">colors </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">ListedColormap</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Normalize</span></code></li><li class="L2"><code class="language-python"><span class="kwd">from</span><span class="pln"> matplotlib</span><span class="pun">.</span><span class="pln">cm </span><span class="kwd">import</span><span class="pln"> get_cmap</span></code></li><li class="L3"><code class="language-python"><span class="pln">cmap </span><span class="pun">=</span><span class="pln"> get_cmap</span><span class="pun">(</span><span class="str">'YlOrRd'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">norm </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Normalize</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">actual </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L7"><code class="language-python"><span class="pln">                    </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">                    </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L9"><code class="language-python"><span class="pln">error </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L0"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">l</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">):</span><span class="pln"> squaredError</span><span class="pun">(</span><span class="pln">l</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"><span class="pln">clrs </span><span class="pun">=</span><span class="pln"> cmap</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">norm</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)))[:,</span><span class="lit">0</span><span class="pun">:</span><span class="lit">3</span><span class="pun">]</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">actual</span><span class="pun">,</span><span class="pln"> actual</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="pln">clrs</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#888888'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">,</span><span class="pln"> linewidths</span><span class="pun">=</span><span class="lit">0.5</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Predicted'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="str">'Actual'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="1q1n"><img src="http://static.zybuluo.com/ronaldhan/iwnp22abia29v4dfl4dpuyif/ideal_predict.png" alt="ideal_predict.png-46.9kB" title=""></p><div class="md-section-divider"></div><pre style="" data-anchor-id="enef" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 实际预测情况, 颜色越深, 误差越大</span></code></li><li class="L1"><code class="language-python"><span class="pln">predictions </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L2"><code class="language-python"><span class="pln">                         </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> averageTrainYear</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">                         </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L4"><code class="language-python"><span class="pln">error </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L5"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> averageTrainYear</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">l</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">):</span><span class="pln"> squaredError</span><span class="pun">(</span><span class="pln">l</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">))</span></code></li><li class="L7"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L8"><code class="language-python"><span class="pln">norm </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Normalize</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"><span class="pln">clrs </span><span class="pun">=</span><span class="pln"> cmap</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">norm</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)))[:,</span><span class="lit">0</span><span class="pun">:</span><span class="lit">3</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">53.0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">55.0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.5</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlim</span><span class="pun">(</span><span class="lit">53</span><span class="pun">,</span><span class="pln"> </span><span class="lit">55</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">predictions</span><span class="pun">,</span><span class="pln"> actual</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="pln">clrs</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#888888'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">,</span><span class="pln"> linewidths</span><span class="pun">=</span><span class="lit">0.3</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Predicted'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="str">'Actual'</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="sskf"><img src="http://static.zybuluo.com/ronaldhan/wti39ehpu19x0f3nmq4x8vq5/avg_predict.png" alt="avg_predict.png-31.1kB" title=""></p><div class="md-section-divider"></div><h3 id="3-回归模型的创建及评估" data-anchor-id="c91r">3. 回归模型的创建及评估</h3><div class="md-section-divider"></div><h4 id="梯度下降" data-anchor-id="25pq">梯度下降</h4><p data-anchor-id="we8b"><span class="MathJax_Preview"></span><div style="text-align: center;" aria-readonly="true" role="textbox" class="MathJax_SVG_Display"><span id="MathJax-Element-1-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -696.9795817045472 11396.360893674451 1835.0527061328733" style="width: 26.444ex; height: 4.222ex; vertical-align: -2.778ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMAINB-77" transform="scale(0.7)"></use><g transform="translate(582,-150)"><use xlink:href="#MJMATHI-69" transform="scale(0.4949747468305833)"></use><use y="0" x="345" xlink:href="#MJMAIN-2B" transform="scale(0.4949747468305833)"></use><use y="0" x="1123" xlink:href="#MJMAIN-31" transform="scale(0.4949747468305833)"></use></g><use y="0" x="2519" xlink:href="#MJMAIN-3D" transform="scale(0.7)"></use><g transform="translate(2586,0)"><use xlink:href="#MJMAINB-77" transform="scale(0.7)"></use><use y="-304" x="1175" xlink:href="#MJMATHI-69" transform="scale(0.4949747468305833)"></use></g><use y="0" x="5231" xlink:href="#MJMAIN-2212" transform="scale(0.7)"></use><g transform="translate(4429,0)"><use xlink:href="#MJMATHI-3B1" transform="scale(0.7)"></use><use y="-304" x="905" xlink:href="#MJMATHI-69" transform="scale(0.4949747468305833)"></use></g><g transform="translate(5315,0)"><use xlink:href="#MJSZ2-2211" transform="scale(0.7)"></use><use y="-1850" x="815" xlink:href="#MJMATHI-6A" transform="scale(0.4949747468305833)"></use></g><use y="0" x="9037" xlink:href="#MJMAIN-28" transform="scale(0.7)"></use><g transform="translate(6598,0)"><use xlink:href="#MJMAINB-77" transform="scale(0.7)"></use><use y="696" x="1175" xlink:href="#MJMAIN-22A4" transform="scale(0.4949747468305833)"></use><use y="-330" x="1175" xlink:href="#MJMATHI-69" transform="scale(0.4949747468305833)"></use></g><g transform="translate(7666,0)"><use xlink:href="#MJMAINB-78" transform="scale(0.7)"></use><use y="-304" x="859" xlink:href="#MJMATHI-6A" transform="scale(0.4949747468305833)"></use></g><use y="0" x="12311" xlink:href="#MJMAIN-2212" transform="scale(0.7)"></use><g transform="translate(9385,0)"><use xlink:href="#MJMATHI-79" transform="scale(0.7)"></use><use y="-342" x="693" xlink:href="#MJMATHI-6A" transform="scale(0.4949747468305833)"></use></g><use y="0" x="14332" xlink:href="#MJMAIN-29" transform="scale(0.7)"></use><g transform="translate(10305,0)"><use xlink:href="#MJMAINB-78" transform="scale(0.7)"></use><use y="-304" x="859" xlink:href="#MJMATHI-6A" transform="scale(0.4949747468305833)"></use></g><use y="0" x="16002" xlink:href="#MJMAIN-2E" transform="scale(0.7)"></use></g></svg></span></div><script id="MathJax-Element-1" type="math/tex; mode=display"> \scriptsize \mathbf{w}_{i+1} = \mathbf{w}_i - \alpha_i \sum_j (\mathbf{w}_i^\top\mathbf{x}_j  - y_j) \mathbf{x}_j \,.</script>  <br>
这里 <span class="MathJax_Preview"></span><span aria-readonly="true" role="textbox" id="MathJax-Element-2-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -484.30330132805636 241.85 513.6066026561127" style="width: 0.556ex; height: 1.222ex; vertical-align: -0.111ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-69" transform="scale(0.7)"></use></g></svg></span><script id="MathJax-Element-2" type="math/tex"> \scriptsize i </script> 表示梯度下降算法迭代次数, <span class="MathJax_Preview"></span><span aria-readonly="true" role="textbox" id="MathJax-Element-3-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="-8.049999999999999 -484.30330132805636 296.8 648.7066026561128" style="width: 0.667ex; height: 1.556ex; vertical-align: -0.444ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMATHI-6A" transform="scale(0.7)"></use></g></svg></span><script id="MathJax-Element-3" type="math/tex"> \scriptsize j </script> 表示样本数量. 接下来, 我们要实现梯度下降算法, 其中gradient summand等于<span class="MathJax_Preview"></span><span aria-readonly="true" role="textbox" id="MathJax-Element-4-Frame" class="MathJax_SVG" style="font-size: 100%; display: inline-block;"><svg viewBox="0 -714.9334069577167 4071.4203800901487 911.5367082857731" style="width: 9.444ex; height: 2.111ex; vertical-align: -0.556ex; margin: 1px 0px;" xmlns:xlink="http://www.w3.org/1999/xlink"><g transform="matrix(1 0 0 -1 0 0)" stroke-width="0" fill="black" stroke="black"><use xlink:href="#MJMAIN-28" transform="scale(0.7)"></use><g transform="translate(272,0)"><use xlink:href="#MJMAINB-77" transform="scale(0.7)"></use><use y="733" x="1175" xlink:href="#MJMAIN-22A4" transform="scale(0.4949747468305833)"></use></g><use y="0" x="1914" xlink:href="#MJMAINB-78" transform="scale(0.7)"></use><use y="0" x="2839" xlink:href="#MJMAIN-2212" transform="scale(0.7)"></use><use y="0" x="4071" xlink:href="#MJMATHI-79" transform="scale(0.7)"></use><use y="0" x="4568" xlink:href="#MJMAIN-29" transform="scale(0.7)"></use><use y="0" x="4958" xlink:href="#MJMAINB-78" transform="scale(0.7)"></use><use y="0" x="5565" xlink:href="#MJMAIN-20" transform="scale(0.7)"></use></g></svg></span><script id="MathJax-Element-4" type="math/tex"> \scriptsize (\mathbf{w}^\top \mathbf{x} - y) \mathbf{x} \ </script></p><div class="md-section-divider"></div><pre style="" data-anchor-id="2awk" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">mllib</span><span class="pun">.</span><span class="pln">linalg </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">DenseVector</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> gradientSummand</span><span class="pun">(</span><span class="pln">weights</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">"""Calculates the gradient summand for a given weight and `LabeledPoint`.</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="str">    Note:</span></code></li><li class="L6"><code class="language-python"><span class="str">        `DenseVector` behaves similarly to a `numpy.ndarray` and they can be used interchangably</span></code></li><li class="L7"><code class="language-python"><span class="str">        within this function.  For example, they both implement the `dot` method.</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L0"><code class="language-python"><span class="str">        weights (DenseVector): An array of model weights (betas).</span></code></li><li class="L1"><code class="language-python"><span class="str">        lp (LabeledPoint): The `LabeledPoint` for a single observation.</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L4"><code class="language-python"><span class="str">        DenseVector: An array of values the same length as `weights`.  The gradient summand.</span></code></li><li class="L5"><code class="language-python"><span class="str">    """</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">weights</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">features</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">exampleW </span><span class="pun">=</span><span class="pln"> </span><span class="typ">DenseVector</span><span class="pun">([</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L9"><code class="language-python"><span class="pln">exampleLP </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">2.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">])</span></code></li><li class="L0"><code class="language-python"><span class="com"># gradientSummand = (dot([1 1 1], [3 1 4]) - 2) * [3 1 4] = (8 - 2) * [3 1 4] = [18 6 24]</span></code></li><li class="L1"><code class="language-python"><span class="pln">summandOne </span><span class="pun">=</span><span class="pln"> gradientSummand</span><span class="pun">(</span><span class="pln">exampleW</span><span class="pun">,</span><span class="pln"> exampleLP</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> summandOne</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">exampleW </span><span class="pun">=</span><span class="pln"> </span><span class="typ">DenseVector</span><span class="pun">([.</span><span class="lit">24</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.2</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1.4</span><span class="pun">])</span></code></li><li class="L5"><code class="language-python"><span class="pln">exampleLP </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">3.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[-</span><span class="lit">1.4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4.2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2.1</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"><span class="pln">summandTwo </span><span class="pun">=</span><span class="pln"> gradientSummand</span><span class="pun">(</span><span class="pln">exampleW</span><span class="pun">,</span><span class="pln"> exampleLP</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="kwd">print</span><span class="pln"> summandTwo</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="lit">18.0</span><span class="pun">,</span><span class="lit">6.0</span><span class="pun">,</span><span class="lit">24.0</span><span class="pun">]</span></code></li><li class="L0"><code class="language-python"><span class="pun">[</span><span class="lit">1.7304</span><span class="pun">,-</span><span class="lit">5.1912</span><span class="pun">,-</span><span class="lit">2.5956</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="利用权重值来做预测" data-anchor-id="8oro">利用权重值来做预测</h4><p data-anchor-id="o88s">只要计算出权重, 对于输入值就能够进行预测</p><div class="md-section-divider"></div><pre style="" data-anchor-id="eoay" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># 输入权重和观察值, 返回(标签值, 预测值)元组</span></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> getLabeledPrediction</span><span class="pun">(</span><span class="pln">weights</span><span class="pun">,</span><span class="pln"> observation</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">"""Calculates predictions and returns a (label, prediction) tuple.</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="str">    Note:</span></code></li><li class="L6"><code class="language-python"><span class="str">        The labels should remain unchanged as we'll use this information to calculate prediction</span></code></li><li class="L7"><code class="language-python"><span class="str">        error later.</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L0"><code class="language-python"><span class="str">        weights (np.ndarray): An array with one weight for each features in `trainData`.</span></code></li><li class="L1"><code class="language-python"><span class="str">        observation (LabeledPoint): A `LabeledPoint` that contain the correct label and the</span></code></li><li class="L2"><code class="language-python"><span class="str">            features for the data point.</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L5"><code class="language-python"><span class="str">        tuple: A (label, prediction) tuple.</span></code></li><li class="L6"><code class="language-python"><span class="str">    """</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">observation</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">observation</span><span class="pun">.</span><span class="pln">features</span><span class="pun">))</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">weights </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">array</span><span class="pun">([</span><span class="lit">1.0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.5</span><span class="pun">])</span></code></li><li class="L0"><code class="language-python"><span class="pln">predictionExample </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">parallelize</span><span class="pun">([</span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">array</span><span class="pun">([</span><span class="lit">1.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">.</span><span class="lit">5</span><span class="pun">])),</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">1.5</span><span class="pun">,</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">array</span><span class="pun">([.</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="pun">.</span><span class="lit">5</span><span class="pun">]))])</span></code></li><li class="L1"><code class="language-python"><span class="pln">labelsAndPredsExample </span><span class="pun">=</span><span class="pln"> predictionExample</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> getLabeledPrediction</span><span class="pun">(</span><span class="pln">weights</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> labelsAndPredsExample</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[(</span><span class="lit">2.0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.75</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1.5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.25</span><span class="pun">)]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="梯度下降计算" data-anchor-id="a2hg">梯度下降计算</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="r6s7" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> linregGradientDescent</span><span class="pun">(</span><span class="pln">trainData</span><span class="pun">,</span><span class="pln"> numIters</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="str">"""Calculates the weights and error for a linear regression model trained with gradient descent.</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="str">    Note:</span></code></li><li class="L5"><code class="language-python"><span class="str">        `DenseVector` behaves similarly to a `numpy.ndarray` and they can be used interchangably</span></code></li><li class="L6"><code class="language-python"><span class="str">        within this function.  For example, they both implement the `dot` method.</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L9"><code class="language-python"><span class="str">        trainData (RDD of LabeledPoint): The labeled data for use in training the model.</span></code></li><li class="L0"><code class="language-python"><span class="str">        numIters (int): The number of iterations of gradient descent to perform.</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L3"><code class="language-python"><span class="str">        (np.ndarray, np.ndarray): A tuple of (weights, training errors).  Weights will be the final weights (one weight per feature) for the model, and training errors will contain an error (RMSE) for each iteration of the algorithm.</span></code></li><li class="L4"><code class="language-python"><span class="str">    """</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="com"># The length of the training data</span></code></li><li class="L6"><code class="language-python"><span class="pln">    n </span><span class="pun">=</span><span class="pln"> trainData</span><span class="pun">.</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="com"># The number of features in the training data</span></code></li><li class="L8"><code class="language-python"><span class="pln">    d </span><span class="pun">=</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">trainData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">features</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    w </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">zeros</span><span class="pun">(</span><span class="pln">d</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">    alpha </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="com"># 保留每一次迭代的误差</span></code></li><li class="L2"><code class="language-python"><span class="pln">    errorTrain </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">zeros</span><span class="pun">(</span><span class="pln">numIters</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">numIters</span><span class="pun">):</span></code></li><li class="L4"><code class="language-python"><span class="pln">        </span><span class="com"># 初始权重都设置为0</span></code></li><li class="L5"><code class="language-python"><span class="pln">        labelsAndPredsTrain </span><span class="pun">=</span><span class="pln"> trainData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> getLabeledPrediction</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="pln">        errorTrain</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPredsTrain</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="com"># 梯度是一个长度为d的向量.</span></code></li><li class="L9"><code class="language-python"><span class="pln">        gradient </span><span class="pun">=</span><span class="pln"> trainData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> gradientSummand</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">)).</span><span class="pln">sum</span><span class="pun">()</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">        </span><span class="com"># 更新权重</span></code></li><li class="L2"><code class="language-python"><span class="pln">        alpha_i </span><span class="pun">=</span><span class="pln"> alpha </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="pln">n </span><span class="pun">*</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sqrt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">+</span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">        w </span><span class="pun">-=</span><span class="pln"> alpha_i </span><span class="pun">*</span><span class="pln"> gradient</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> w</span><span class="pun">,</span><span class="pln"> errorTrain</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># 创建测试数据集</span></code></li><li class="L7"><code class="language-python"><span class="pln">exampleN </span><span class="pun">=</span><span class="pln"> </span><span class="lit">10</span></code></li><li class="L8"><code class="language-python"><span class="pln">exampleD </span><span class="pun">=</span><span class="pln"> </span><span class="lit">3</span></code></li><li class="L9"><code class="language-python"><span class="pln">exampleData </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sc</span></code></li><li class="L0"><code class="language-python"><span class="pln">               </span><span class="pun">.</span><span class="pln">parallelize</span><span class="pun">(</span><span class="pln">parsedTrainData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="pln">exampleN</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"><span class="pln">               </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">[</span><span class="lit">0</span><span class="pun">:</span><span class="pln">exampleD</span><span class="pun">])))</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> exampleData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">exampleNumIters </span><span class="pun">=</span><span class="pln"> </span><span class="lit">5</span></code></li><li class="L4"><code class="language-python"><span class="pln">exampleWeights</span><span class="pun">,</span><span class="pln"> exampleErrorTrain </span><span class="pun">=</span><span class="pln"> linregGradientDescent</span><span class="pun">(</span><span class="pln">exampleData</span><span class="pun">,</span><span class="pln"> exampleNumIters</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> exampleWeights</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">79.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.884123733793</span><span class="pun">,</span><span class="lit">0.610454259079</span><span class="pun">,</span><span class="lit">0.600498416968</span><span class="pun">]),</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">79.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.854411946129</span><span class="pun">,</span><span class="lit">0.604124786151</span><span class="pun">,</span><span class="lit">0.593634078776</span><span class="pun">])]</span></code></li><li class="L8"><code class="language-python"><span class="pun">[</span><span class="pln"> </span><span class="lit">48.88110449</span><span class="pln">  </span><span class="lit">36.01144093</span><span class="pln">  </span><span class="lit">30.25350092</span><span class="pun">]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="训练回归模型" data-anchor-id="31ja">训练回归模型</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="f0fk" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">numIters </span><span class="pun">=</span><span class="pln"> </span><span class="lit">50</span></code></li><li class="L1"><code class="language-python"><span class="pln">weightsLR0</span><span class="pun">,</span><span class="pln"> errorTrainLR0 </span><span class="pun">=</span><span class="pln"> linregGradientDescent</span><span class="pun">(</span><span class="pln">parsedTrainData</span><span class="pun">,</span><span class="pln"> numIters</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">labelsAndPreds </span><span class="pun">=</span><span class="pln"> parsedValData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> getLabeledPrediction</span><span class="pun">(</span><span class="pln">weightsLR0</span><span class="pun">,</span><span class="pln"> lp</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="pln">rmseValLR0 </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPreds</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">'Validation RMSE:\n\tBaseline = {0:.3f}\n\tLR0 = {1:.3f}'</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseValBase</span><span class="pun">,</span><span class="pln"> rmseValLR0</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Validation</span><span class="pln"> RMSE</span><span class="pun">:</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="typ">Baseline</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">21.586</span></code></li><li class="L0"><code class="language-python"><span class="pln">    LR0 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.192</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="模型训练误差可视化" data-anchor-id="pf9c">模型训练误差可视化</h4><p data-anchor-id="6ide">首先画出算法在50次迭代中训练误差的对数图, 之后是算法在后44此迭代中误差变化图.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="tfsf" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 训练过程的误差对数图</span></code></li><li class="L1"><code class="language-python"><span class="pln">norm </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Normalize</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">clrs </span><span class="pun">=</span><span class="pln"> cmap</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">norm</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">errorTrainLR0</span><span class="pun">))))[:,</span><span class="lit">0</span><span class="pun">:</span><span class="lit">3</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">60</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_ylim</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">range</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> numIters</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">errorTrainLR0</span><span class="pun">),</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="pln">clrs</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#888888'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Iteration'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="pln">r</span><span class="str">'$\log_e(errorTrainLR0)$'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="7szj"><img src="http://static.zybuluo.com/ronaldhan/wdw2olzjeinsc5pn4hy2uh07/log_rmse.png" alt="log_rmse.png-36.8kB" title=""></p><div class="md-section-divider"></div><pre style="" data-anchor-id="ii1u" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 后44次计算过程的RMSE</span></code></li><li class="L1"><code class="language-python"><span class="pln">norm </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Normalize</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">clrs </span><span class="pun">=</span><span class="pln"> cmap</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">norm</span><span class="pun">(</span><span class="pln">errorTrainLR0</span><span class="pun">[</span><span class="lit">6</span><span class="pun">:])))[:,</span><span class="lit">0</span><span class="pun">:</span><span class="lit">3</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">60</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">17</span><span class="pun">,</span><span class="pln"> </span><span class="lit">22</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_ylim</span><span class="pun">(</span><span class="lit">17.8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">21.2</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">range</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> numIters</span><span class="pun">-</span><span class="lit">6</span><span class="pun">),</span><span class="pln"> errorTrainLR0</span><span class="pun">[</span><span class="lit">6</span><span class="pun">:],</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="pln">clrs</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#888888'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xticklabels</span><span class="pun">(</span><span class="pln">map</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">66</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">)))</span></code></li><li class="L8"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Iteration'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="pln">r</span><span class="str">'Training Error'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="bd6y"><img src="http://static.zybuluo.com/ronaldhan/lkv3qoatvx77m6nc0pgtdhzl/rmse_44.png" alt="rmse_44.png-35.9kB" title=""> <br>
通过两个图可以看出, 训练误差在前几次迭代过程中下降很快, 但随后就缓慢下降.</p><div class="md-section-divider"></div><h3 id="4-训练误差" data-anchor-id="lk8k">4. 训练误差</h3><div class="md-section-divider"></div><h4 id="利用随机梯度下降训练回归模型" data-anchor-id="o90b">利用随机梯度下降训练回归模型</h4><p data-anchor-id="snui">以上的模型已经比均值模型要好, 但是模型还有改进的空间. Spark MLib包含的<a target="_blank" href="https://spark.apache.org/docs/latest/api/python/pyspark.mllib.html#pyspark.mllib.regression.LinearRegressionWithSGD">LinearRegressionWithSGD</a>实现了梯度下降算法, 并且包含更多的特性, 比如随机梯度逼近算法, 对模型的解释, L1或L2正则化. </p><div class="md-section-divider"></div><pre style="" data-anchor-id="movp" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># “l1” for using L1 regularization (lasso)</span></code></li><li class="L2"><code class="language-python"><span class="com"># “l2” for using L2 regularization (ridge)</span></code></li><li class="L3"><code class="language-python"><span class="com"># 默认正则化类型是none</span></code></li><li class="L4"><code class="language-python"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">mllib</span><span class="pun">.</span><span class="pln">regression </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">LinearRegressionWithSGD</span></code></li><li class="L5"><code class="language-python"><span class="com"># Values to use when training the linear regression model</span></code></li><li class="L6"><code class="language-python"><span class="pln">numIters </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span><span class="pln">  </span><span class="com"># iterations</span></code></li><li class="L7"><code class="language-python"><span class="pln">alpha </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span><span class="pln">  </span><span class="com"># step</span></code></li><li class="L8"><code class="language-python"><span class="pln">miniBatchFrac </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span><span class="pln">  </span><span class="com"># miniBatchFraction</span></code></li><li class="L9"><code class="language-python"><span class="pln">reg </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1e-1</span><span class="pln">  </span><span class="com"># regParam</span></code></li><li class="L0"><code class="language-python"><span class="pln">regType </span><span class="pun">=</span><span class="pln"> </span><span class="str">'l2'</span><span class="pln">  </span><span class="com"># regType</span></code></li><li class="L1"><code class="language-python"><span class="pln">useIntercept </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">True</span><span class="pln">  </span><span class="com"># intercept</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">firstModel </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LinearRegressionWithSGD</span><span class="pun">.</span><span class="pln">train</span><span class="pun">(</span><span class="pln">parsedTrainData</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L4"><code class="language-python"><span class="pln">                                           iterations</span><span class="pun">=</span><span class="pln">numIters</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L5"><code class="language-python"><span class="pln">                                           step</span><span class="pun">=</span><span class="pln">alpha</span><span class="pun">,</span><span class="pln">                                          miniBatchFraction</span><span class="pun">=</span><span class="pln">miniBatchFrac</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L6"><code class="language-python"><span class="pln">                                           initialWeights</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L7"><code class="language-python"><span class="pln">                                           regParam</span><span class="pun">=</span><span class="pln">reg</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L8"><code class="language-python"><span class="pln">                                           regType</span><span class="pun">=</span><span class="pln">regType</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L9"><code class="language-python"><span class="pln">                                           intercept</span><span class="pun">=</span><span class="pln">useIntercept</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># weightsLR1 stores the model weights; interceptLR1 stores the model intercept</span></code></li><li class="L2"><code class="language-python"><span class="pln">weightsLR1 </span><span class="pun">=</span><span class="pln"> firstModel</span><span class="pun">.</span><span class="pln">weights</span></code></li><li class="L3"><code class="language-python"><span class="pln">interceptLR1 </span><span class="pun">=</span><span class="pln"> firstModel</span><span class="pun">.</span><span class="pln">intercept</span></code></li><li class="L4"><code class="language-python"><span class="kwd">print</span><span class="pln"> weightsLR1</span><span class="pun">,</span><span class="pln"> interceptLR1</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">[</span><span class="lit">16.682292427</span><span class="pun">,</span><span class="lit">14.7439059559</span><span class="pun">,-</span><span class="lit">0.0935105608897</span><span class="pun">,</span><span class="lit">6.22080088829</span><span class="pun">,</span><span class="lit">4.01454261926</span><span class="pun">,-</span><span class="lit">3.30214858535</span><span class="pun">,</span><span class="lit">11.0403027232</span><span class="pun">,</span><span class="lit">2.67190962854</span><span class="pun">,</span><span class="lit">7.18925791279</span><span class="pun">,</span><span class="lit">4.46093254586</span><span class="pun">,</span><span class="lit">8.14950409475</span><span class="pun">,</span><span class="lit">2.75135810882</span><span class="pun">]</span><span class="pln"> </span><span class="lit">13.3335907631</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="利用新模型进行预测" data-anchor-id="68db">利用新模型进行预测</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="b5tq" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">samplePoint </span><span class="pun">=</span><span class="pln"> parsedTrainData</span><span class="pun">.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)[</span><span class="lit">0</span><span class="pun">]</span></code></li><li class="L1"><code class="language-python"><span class="pln">samplePrediction </span><span class="pun">=</span><span class="pln"> firstModel</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">samplePoint</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> samplePrediction</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">56.8013380112</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="模型的rmse" data-anchor-id="hhbm">模型的RMSE</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="l9r9" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">labelsAndPreds </span><span class="pun">=</span><span class="pln"> parsedValData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> firstModel</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)))</span></code></li><li class="L1"><code class="language-python"><span class="pln">rmseValLR1 </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPreds</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="pun">(</span><span class="str">'Validation RMSE:\n\tBaseline = {0:.3f}\n\tLR0 = {1:.3f}'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'\n\tLR1 = {2:.3f}'</span><span class="pun">).</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseValBase</span><span class="pun">,</span><span class="pln"> rmseValLR0</span><span class="pun">,</span><span class="pln"> rmseValLR1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Validation</span><span class="pln"> RMSE</span><span class="pun">:</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="typ">Baseline</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">21.586</span></code></li><li class="L7"><code class="language-python"><span class="pln">    LR0 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.192</span></code></li><li class="L8"><code class="language-python"><span class="pln">    LR1 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.691</span></code></li></ol></pre><p data-anchor-id="ah3m">我们的模型已经比均值模型在预测值上提升了2年, 但模型还有进一步提升的空间. 比如使用网格搜索的方法寻找最优正则化参数</p><div class="md-section-divider"></div><h4 id="网格搜索" data-anchor-id="zab3">网格搜索</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="udph" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">bestRMSE </span><span class="pun">=</span><span class="pln"> rmseValLR1</span></code></li><li class="L1"><code class="language-python"><span class="pln">bestRegParam </span><span class="pun">=</span><span class="pln"> reg</span></code></li><li class="L2"><code class="language-python"><span class="pln">bestModel </span><span class="pun">=</span><span class="pln"> firstModel</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">numIters </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span></code></li><li class="L5"><code class="language-python"><span class="pln">alpha </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L6"><code class="language-python"><span class="pln">miniBatchFrac </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L7"><code class="language-python"><span class="kwd">for</span><span class="pln"> reg </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">[</span><span class="lit">1e-10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1e-5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">]:</span></code></li><li class="L8"><code class="language-python"><span class="pln">    model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LinearRegressionWithSGD</span><span class="pun">.</span><span class="pln">train</span><span class="pun">(</span><span class="pln">parsedTrainData</span><span class="pun">,</span><span class="pln"> numIters</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">,</span><span class="pln"> miniBatchFrac</span><span class="pun">,</span><span class="pln"> regParam</span><span class="pun">=</span><span class="pln">reg</span><span class="pun">,</span><span class="pln"> regType</span><span class="pun">=</span><span class="str">'l2'</span><span class="pun">,</span><span class="pln"> intercept</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    labelsAndPreds </span><span class="pun">=</span><span class="pln"> parsedValData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> model</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)))</span></code></li><li class="L0"><code class="language-python"><span class="pln">    rmseValGrid </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPreds</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> rmseValGrid</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> rmseValGrid </span><span class="pun">&lt;</span><span class="pln"> bestRMSE</span><span class="pun">:</span></code></li><li class="L4"><code class="language-python"><span class="pln">        bestRMSE </span><span class="pun">=</span><span class="pln"> rmseValGrid</span></code></li><li class="L5"><code class="language-python"><span class="pln">        bestRegParam </span><span class="pun">=</span><span class="pln"> reg</span></code></li><li class="L6"><code class="language-python"><span class="pln">        bestModel </span><span class="pun">=</span><span class="pln"> model</span></code></li><li class="L7"><code class="language-python"><span class="pln">rmseValLRGrid </span><span class="pun">=</span><span class="pln"> bestRMSE</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="pun">(</span><span class="str">'Validation RMSE:\n\tBaseline = {0:.3f}\n\tLR0 = {1:.3f}\n\tLR1 = {2:.3f}\n'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'\tLRGrid = {3:.3f}'</span><span class="pun">).</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseValBase</span><span class="pun">,</span><span class="pln"> rmseValLR0</span><span class="pun">,</span><span class="pln"> rmseValLR1</span><span class="pun">,</span><span class="pln"> rmseValLRGrid</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="lit">17.0171700716</span></code></li><li class="L2"><code class="language-python"><span class="lit">17.0175981807</span></code></li><li class="L3"><code class="language-python"><span class="lit">23.8007746698</span></code></li><li class="L4"><code class="language-python"><span class="typ">Validation</span><span class="pln"> RMSE</span><span class="pun">:</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="typ">Baseline</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">21.586</span></code></li><li class="L6"><code class="language-python"><span class="pln">    LR0 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.192</span></code></li><li class="L7"><code class="language-python"><span class="pln">    LR1 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.691</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="typ">LRGrid</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">17.017</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="最优模型的预测" data-anchor-id="7zz9">最优模型的预测</h4><p data-anchor-id="9s7s">从以上计算中可以看出RMSE继续下降, 我们找到了最优的模型. 下面我们通过绘制预测值和实际值散点图来观察模型预测情况, 图中颜色越深表明预测误差越大.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="zpmd" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">predictions </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L1"><code class="language-python"><span class="pln">                         </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> bestModel</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">                         </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"><span class="pln">actual </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L4"><code class="language-python"><span class="pln">                    </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">                    </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L6"><code class="language-python"><span class="pln">error </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">parsedValData</span></code></li><li class="L7"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> bestModel</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)))</span></code></li><li class="L8"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">(</span><span class="pln">l</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">):</span><span class="pln"> squaredError</span><span class="pun">(</span><span class="pln">l</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">))</span></code></li><li class="L9"><code class="language-python"><span class="pln">                   </span><span class="pun">.</span><span class="pln">collect</span><span class="pun">())</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">norm </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Normalize</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">clrs </span><span class="pun">=</span><span class="pln"> cmap</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">asarray</span><span class="pun">(</span><span class="pln">norm</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)))[:,</span><span class="lit">0</span><span class="pun">:</span><span class="lit">3</span><span class="pun">]</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">fig</span><span class="pun">,</span><span class="pln"> ax </span><span class="pun">=</span><span class="pln"> preparePlot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">120</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">arange</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">120</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlim</span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> </span><span class="lit">82</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylim</span><span class="pun">(-</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">105</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">predictions</span><span class="pun">,</span><span class="pln"> actual</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">=</span><span class="lit">14</span><span class="pun">**</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="pln">clrs</span><span class="pun">,</span><span class="pln"> edgecolors</span><span class="pun">=</span><span class="str">'#888888'</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">=</span><span class="lit">0.75</span><span class="pun">,</span><span class="pln"> linewidths</span><span class="pun">=.</span><span class="lit">5</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">'Predicted'</span><span class="pun">),</span><span class="pln"> ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="pln">r</span><span class="str">'Actual'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="xkf0"><img src="http://static.zybuluo.com/ronaldhan/fgirl4ftpm2dw6kclgrvozde/predict_actual.png" alt="predict_actual.png-201.8kB" title=""></p><div class="md-section-divider"></div><h3 id="5-数据特征的一些分析" data-anchor-id="qjug">5. 数据特征的一些分析</h3><div class="md-section-divider"></div><h4 id="特征数据的两路作用2-way-interactions" data-anchor-id="qw6a">特征数据的两路作用(2-way interactions)</h4><p data-anchor-id="sqbz">目前为止, 我们直接使用所有的特征数据构建模型, 现在我们要尝试使用特征数据的相互作用来增加更多的特征数据. 这里面的两路作用是特征数据两两相乘. 原有的特征数据加上作用后产生的新数据共同作为特征数据. 向量长度为2的数据两路作用后有4个数据, 长度为3时有9个数据.</p><div class="md-section-divider"></div><pre style="" data-anchor-id="ko2k" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> itertools</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> twoWayInteractions</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">"""Creates a new `LabeledPoint` that includes two-way interactions.</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="str">    Note:</span></code></li><li class="L6"><code class="language-python"><span class="str">        For features [x, y] the two-way interactions would be [x^2, x*y, y*x, y^2] and these</span></code></li><li class="L7"><code class="language-python"><span class="str">        would be appended to the original [x, y] feature list.</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="str">    Args:</span></code></li><li class="L0"><code class="language-python"><span class="str">        lp (LabeledPoint): The label and features for this observation.</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="str">    Returns:</span></code></li><li class="L3"><code class="language-python"><span class="str">        LabeledPoint: The new `LabeledPoint` should have the same label as `lp`.  Its features</span></code></li><li class="L4"><code class="language-python"><span class="str">            should include the features from `lp` followed by the two-way interaction features.</span></code></li><li class="L5"><code class="language-python"><span class="str">    """</span></code></li><li class="L6"><code class="language-python"><span class="pln">    inters </span><span class="pun">=</span><span class="pln"> list</span><span class="pun">(</span><span class="pln">itertools</span><span class="pun">.</span><span class="pln">product</span><span class="pun">(</span><span class="pln">range</span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)),</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">))))</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">hstack</span><span class="pun">((</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">[</span><span class="pln">j</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span><span class="pln">j</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> inters</span><span class="pun">])))</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> twoWayInteractions</span><span class="pun">(</span><span class="typ">LabeledPoint</span><span class="pun">(</span><span class="lit">0.0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">]))</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># Transform the existing train, validation, and test sets to include two-way interactions.</span></code></li><li class="L2"><code class="language-python"><span class="pln">trainDataInteract </span><span class="pun">=</span><span class="pln"> parsedTrainData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> p</span><span class="pun">:</span><span class="pln"> twoWayInteractions</span><span class="pun">(</span><span class="pln">p</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"><span class="pln">valDataInteract </span><span class="pun">=</span><span class="pln"> parsedValData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> p</span><span class="pun">:</span><span class="pln"> twoWayInteractions</span><span class="pun">(</span><span class="pln">p</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="pln">testDataInteract </span><span class="pun">=</span><span class="pln"> parsedTestData</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> p</span><span class="pun">:</span><span class="pln"> twoWayInteractions</span><span class="pun">(</span><span class="pln">p</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="pun">(</span><span class="lit">0.0</span><span class="pun">,[</span><span class="lit">2.0</span><span class="pun">,</span><span class="lit">3.0</span><span class="pun">,</span><span class="lit">4.0</span><span class="pun">,</span><span class="lit">6.0</span><span class="pun">,</span><span class="lit">6.0</span><span class="pun">,</span><span class="lit">9.0</span><span class="pun">])</span></code></li></ol></pre><div class="md-section-divider"></div><h4 id="构建新的模型" data-anchor-id="iic0">构建新的模型</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="xk89" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">numIters </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span></code></li><li class="L1"><code class="language-python"><span class="pln">alpha </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L2"><code class="language-python"><span class="pln">miniBatchFrac </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L3"><code class="language-python"><span class="pln">reg </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1e-10</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">modelInteract </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LinearRegressionWithSGD</span><span class="pun">.</span><span class="pln">train</span><span class="pun">(</span><span class="pln">trainDataInteract</span><span class="pun">,</span><span class="pln"> numIters</span><span class="pun">,</span><span class="pln"> alpha</span><span class="pun">,</span><span class="pln"> miniBatchFrac</span><span class="pun">,</span><span class="pln"> regParam</span><span class="pun">=</span><span class="pln">reg</span><span class="pun">,</span><span class="pln"> regType</span><span class="pun">=</span><span class="str">'l2'</span><span class="pun">,</span><span class="pln"> intercept</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">labelsAndPredsInteract </span><span class="pun">=</span><span class="pln"> valDataInteract</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> modelInteract</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)))</span></code></li><li class="L7"><code class="language-python"><span class="pln">rmseValInteract </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPredsInteract</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="pun">(</span><span class="str">'Validation RMSE:\n\tBaseline = {0:.3f}\n\tLR0 = {1:.3f}\n\tLR1 = {2:.3f}\n\tLRGrid = '</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'{3:.3f}\n\tLRInteract = {4:.3f}'</span><span class="pun">).</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseValBase</span><span class="pun">,</span><span class="pln"> rmseValLR0</span><span class="pun">,</span><span class="pln"> rmseValLR1</span><span class="pun">,</span><span class="pln"> rmseValLRGrid</span><span class="pun">,</span><span class="pln"> rmseValInteract</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Validation</span><span class="pln"> RMSE</span><span class="pun">:</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="typ">Baseline</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">21.586</span></code></li><li class="L3"><code class="language-python"><span class="pln">    LR0 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.192</span></code></li><li class="L4"><code class="language-python"><span class="pln">    LR1 </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19.691</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="typ">LRGrid</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">17.017</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="typ">LRInteract</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">15.690</span></code></li></ol></pre><p data-anchor-id="z0wd">能够看出来, 新模型的RMSE继续下降, 模型预测质量进一步提升</p><div class="md-section-divider"></div><h4 id="在测试数据上测试新模型" data-anchor-id="5zlr">在测试数据上测试新模型</h4><div class="md-section-divider"></div><pre style="" data-anchor-id="nmcf" class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">labelsAndPredsTest </span><span class="pun">=</span><span class="pln"> testDataInteract</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> lp</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">label</span><span class="pun">,</span><span class="pln"> modelInteract</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">lp</span><span class="pun">.</span><span class="pln">features</span><span class="pun">)))</span></code></li><li class="L1"><code class="language-python"><span class="pln">rmseTestInteract </span><span class="pun">=</span><span class="pln"> calcRMSE</span><span class="pun">(</span><span class="pln">labelsAndPredsTest</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="pun">(</span><span class="str">'Test RMSE:\n\tBaseline = {0:.3f}\n\tLRInteract = {1:.3f}'</span><span class="pln"> </span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">rmseTestBase</span><span class="pun">,</span><span class="pln"> rmseTestInteract</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="typ">Test</span><span class="pln"> RMSE</span><span class="pun">:</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="typ">Baseline</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">22.137</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="typ">LRInteract</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">16.327</span></code></li></ol></pre><p data-anchor-id="j6by">模型预测能力进一步改善, 说明增加新的特征数据提升了模型的预测能力</p></div>
</body>
</html>